import{c as _,g as Ui}from"./index-Cpy4kbTy.js";function zi(s,e){for(var t=0;t<e.length;t++){const r=e[t];if(typeof r!="string"&&!Array.isArray(r)){for(const i in r)if(i!=="default"&&!(i in s)){const n=Object.getOwnPropertyDescriptor(r,i);n&&Object.defineProperty(s,i,n.get?n:{enumerable:!0,get:()=>r[i]})}}}return Object.freeze(Object.defineProperty(s,Symbol.toStringTag,{value:"Module"}))}var zr={},$r={exports:{}},yr,_s;function Hi(){if(_s)return yr;_s=1;var s=1e3,e=s*60,t=e*60,r=t*24,i=r*7,n=r*365.25;yr=function(a,c){c=c||{};var l=typeof a;if(l==="string"&&a.length>0)return o(a);if(l==="number"&&isFinite(a))return c.long?u(a):d(a);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(a))};function o(a){if(a=String(a),!(a.length>100)){var c=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(a);if(c){var l=parseFloat(c[1]),h=(c[2]||"ms").toLowerCase();switch(h){case"years":case"year":case"yrs":case"yr":case"y":return l*n;case"weeks":case"week":case"w":return l*i;case"days":case"day":case"d":return l*r;case"hours":case"hour":case"hrs":case"hr":case"h":return l*t;case"minutes":case"minute":case"mins":case"min":case"m":return l*e;case"seconds":case"second":case"secs":case"sec":case"s":return l*s;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return l;default:return}}}}function d(a){var c=Math.abs(a);return c>=r?Math.round(a/r)+"d":c>=t?Math.round(a/t)+"h":c>=e?Math.round(a/e)+"m":c>=s?Math.round(a/s)+"s":a+"ms"}function u(a){var c=Math.abs(a);return c>=r?p(a,c,r,"day"):c>=t?p(a,c,t,"hour"):c>=e?p(a,c,e,"minute"):c>=s?p(a,c,s,"second"):a+" ms"}function p(a,c,l,h){var m=c>=l*1.5;return Math.round(a/l)+" "+h+(m?"s":"")}return yr}function Gi(s){t.debug=t,t.default=t,t.coerce=u,t.disable=n,t.enable=i,t.enabled=o,t.humanize=Hi(),t.destroy=p,Object.keys(s).forEach(a=>{t[a]=s[a]}),t.names=[],t.skips=[],t.formatters={};function e(a){let c=0;for(let l=0;l<a.length;l++)c=(c<<5)-c+a.charCodeAt(l),c|=0;return t.colors[Math.abs(c)%t.colors.length]}t.selectColor=e;function t(a){let c,l=null,h,m;function g(...f){if(!g.enabled)return;const w=g,I=Number(new Date),v=I-(c||I);w.diff=v,w.prev=c,w.curr=I,c=I,f[0]=t.coerce(f[0]),typeof f[0]!="string"&&f.unshift("%O");let b=0;f[0]=f[0].replace(/%([a-zA-Z%])/g,(U,ne)=>{if(U==="%%")return"%";b++;const ee=t.formatters[ne];if(typeof ee=="function"){const re=f[b];U=ee.call(w,re),f.splice(b,1),b--}return U}),t.formatArgs.call(w,f),(w.log||t.log).apply(w,f)}return g.namespace=a,g.useColors=t.useColors(),g.color=t.selectColor(a),g.extend=r,g.destroy=t.destroy,Object.defineProperty(g,"enabled",{enumerable:!0,configurable:!1,get:()=>l!==null?l:(h!==t.namespaces&&(h=t.namespaces,m=t.enabled(a)),m),set:f=>{l=f}}),typeof t.init=="function"&&t.init(g),g}function r(a,c){const l=t(this.namespace+(typeof c>"u"?":":c)+a);return l.log=this.log,l}function i(a){t.save(a),t.namespaces=a,t.names=[],t.skips=[];let c;const l=(typeof a=="string"?a:"").split(/[\s,]+/),h=l.length;for(c=0;c<h;c++)l[c]&&(a=l[c].replace(/\*/g,".*?"),a[0]==="-"?t.skips.push(new RegExp("^"+a.slice(1)+"$")):t.names.push(new RegExp("^"+a+"$")))}function n(){const a=[...t.names.map(d),...t.skips.map(d).map(c=>"-"+c)].join(",");return t.enable(""),a}function o(a){if(a[a.length-1]==="*")return!0;let c,l;for(c=0,l=t.skips.length;c<l;c++)if(t.skips[c].test(a))return!1;for(c=0,l=t.names.length;c<l;c++)if(t.names[c].test(a))return!0;return!1}function d(a){return a.toString().substring(2,a.toString().length-2).replace(/\.\*\?$/,"*")}function u(a){return a instanceof Error?a.stack||a.message:a}function p(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.enable(t.load()),t}var qi=Gi;(function(s,e){var t={};e.formatArgs=i,e.save=n,e.load=o,e.useColors=r,e.storage=d(),e.destroy=(()=>{let p=!1;return()=>{p||(p=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),e.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function r(){return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/)?!1:typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function i(p){if(p[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+p[0]+(this.useColors?"%c ":" ")+"+"+s.exports.humanize(this.diff),!this.useColors)return;const a="color: "+this.color;p.splice(1,0,a,"color: inherit");let c=0,l=0;p[0].replace(/%[a-zA-Z%]/g,h=>{h!=="%%"&&(c++,h==="%c"&&(l=c))}),p.splice(l,0,a)}e.log=console.debug||console.log||(()=>{});function n(p){try{p?e.storage.setItem("debug",p):e.storage.removeItem("debug")}catch{}}function o(){let p;try{p=e.storage.getItem("debug")}catch{}return!p&&typeof process<"u"&&"env"in process&&(p=t.DEBUG),p}function d(){try{return localStorage}catch{}}s.exports=qi(e);const{formatters:u}=s.exports;u.j=function(p){try{return JSON.stringify(p)}catch(a){return"[UnexpectedJSONParseError]: "+a.message}}})($r,$r.exports);var ni=$r.exports,Ne={},Nr={exports:{}};(function(s,e){(function(t,r){var i="1.0.37",n="",o="?",d="function",u="undefined",p="object",a="string",c="major",l="model",h="name",m="type",g="vendor",f="version",w="architecture",I="console",v="mobile",b="tablet",G="smarttv",U="wearable",ne="embedded",ee=500,re="Amazon",Pe="Apple",ye="ASUS",ce="BlackBerry",Fe="Browser",Mt="Chrome",$i="Edge",It="Firefox",Ot="Google",os="Huawei",mr="LG",gr="Microsoft",cs="Motorola",kt="Opera",jt="Samsung",ds="Sharp",Ft="Sony",_r="Xiaomi",wr="Zebra",ps="Facebook",ls="Chromium OS",us="Mac OS",Ni=function(O,A){var L={};for(var H in O)A[H]&&A[H].length%2===0?L[H]=A[H].concat(O[H]):L[H]=O[H];return L},$t=function(O){for(var A={},L=0;L<O.length;L++)A[O[L].toUpperCase()]=O[L];return A},hs=function(O,A){return typeof O===a?ut(A).indexOf(ut(O))!==-1:!1},ut=function(O){return O.toLowerCase()},Ai=function(O){return typeof O===a?O.replace(/[^\d\.]/g,n).split(".")[0]:r},vr=function(O,A){if(typeof O===a)return O=O.replace(/^\s\s*/,n),typeof A===u?O:O.substring(0,ee)},ht=function(O,A){for(var L=0,H,Ee,de,$,P,pe;L<A.length&&!P;){var Sr=A[L],gs=A[L+1];for(H=Ee=0;H<Sr.length&&!P&&Sr[H];)if(P=Sr[H++].exec(O),P)for(de=0;de<gs.length;de++)pe=P[++Ee],$=gs[de],typeof $===p&&$.length>0?$.length===2?typeof $[1]==d?this[$[0]]=$[1].call(this,pe):this[$[0]]=$[1]:$.length===3?typeof $[1]===d&&!($[1].exec&&$[1].test)?this[$[0]]=pe?$[1].call(this,pe,$[2]):r:this[$[0]]=pe?pe.replace($[1],$[2]):r:$.length===4&&(this[$[0]]=pe?$[3].call(this,pe.replace($[1],$[2])):r):this[$]=pe||r;L+=2}},br=function(O,A){for(var L in A)if(typeof A[L]===p&&A[L].length>0){for(var H=0;H<A[L].length;H++)if(hs(A[L][H],O))return L===o?r:L}else if(hs(A[L],O))return L===o?r:L;return O},Bi={"1.0":"/8","1.2":"/1","1.3":"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"},fs={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2","8.1":"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},ms={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[f,[h,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[f,[h,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[h,f],[/opios[\/ ]+([\w\.]+)/i],[f,[h,kt+" Mini"]],[/\bopr\/([\w\.]+)/i],[f,[h,kt]],[/\bb[ai]*d(?:uhd|[ub]*[aekoprswx]{5,6})[\/ ]?([\w\.]+)/i],[f,[h,"Baidu"]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/ ]?([\w\.]*)/i,/(avant|iemobile|slim)\s?(?:browser)?[\/ ]?([\w\.]*)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|qq|duckduckgo)\/([-\w\.]+)/i,/(heytap|ovi)browser\/([\d\.]+)/i,/(weibo)__([\d\.]+)/i],[h,f],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[f,[h,"UC"+Fe]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i,/micromessenger\/([\w\.]+)/i],[f,[h,"WeChat"]],[/konqueror\/([\w\.]+)/i],[f,[h,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[f,[h,"IE"]],[/ya(?:search)?browser\/([\w\.]+)/i],[f,[h,"Yandex"]],[/slbrowser\/([\w\.]+)/i],[f,[h,"Smart Lenovo "+Fe]],[/(avast|avg)\/([\w\.]+)/i],[[h,/(.+)/,"$1 Secure "+Fe],f],[/\bfocus\/([\w\.]+)/i],[f,[h,It+" Focus"]],[/\bopt\/([\w\.]+)/i],[f,[h,kt+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[f,[h,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[f,[h,"Dolphin"]],[/coast\/([\w\.]+)/i],[f,[h,kt+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[f,[h,"MIUI "+Fe]],[/fxios\/([-\w\.]+)/i],[f,[h,It]],[/\bqihu|(qi?ho?o?|360)browser/i],[[h,"360 "+Fe]],[/(oculus|sailfish|huawei|vivo)browser\/([\w\.]+)/i],[[h,/(.+)/,"$1 "+Fe],f],[/samsungbrowser\/([\w\.]+)/i],[f,[h,jt+" Internet"]],[/(comodo_dragon)\/([\w\.]+)/i],[[h,/_/g," "],f],[/metasr[\/ ]?([\d\.]+)/i],[f,[h,"Sogou Explorer"]],[/(sogou)mo\w+\/([\d\.]+)/i],[[h,"Sogou Mobile"],f],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|2345Explorer)[\/ ]?([\w\.]+)/i],[h,f],[/(lbbrowser)/i,/\[(linkedin)app\]/i],[h],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[h,ps],f],[/(Klarna)\/([\w\.]+)/i,/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(alipay)client\/([\w\.]+)/i,/(chromium|instagram|snapchat)[\/ ]([-\w\.]+)/i],[h,f],[/\bgsa\/([\w\.]+) .*safari\//i],[f,[h,"GSA"]],[/musical_ly(?:.+app_?version\/|_)([\w\.]+)/i],[f,[h,"TikTok"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[f,[h,Mt+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[h,Mt+" WebView"],f],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[f,[h,"Android "+Fe]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[h,f],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[f,[h,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[f,h],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[h,[f,br,Bi]],[/(webkit|khtml)\/([\w\.]+)/i],[h,f],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[h,"Netscape"],f],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[f,[h,It+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror|klar)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i,/panasonic;(viera)/i],[h,f],[/(cobalt)\/([\w\.]+)/i],[h,[f,/master.|lts./,""]]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[w,"amd64"]],[/(ia32(?=;))/i],[[w,ut]],[/((?:i[346]|x)86)[;\)]/i],[[w,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[w,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[w,"armhf"]],[/windows (ce|mobile); ppc;/i],[[w,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[w,/ower/,n,ut]],[/(sun4\w)[;\)]/i],[[w,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[w,ut]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[l,[g,jt],[m,b]],[/\b((?:s[cgp]h|gt|sm)-\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]([-\w]+)/i,/sec-(sgh\w+)/i],[l,[g,jt],[m,v]],[/(?:\/|\()(ip(?:hone|od)[\w, ]*)(?:\/|;)/i],[l,[g,Pe],[m,v]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[l,[g,Pe],[m,b]],[/(macintosh);/i],[l,[g,Pe]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[l,[g,ds],[m,v]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[l,[g,os],[m,b]],[/(?:huawei|honor)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[l,[g,os],[m,v]],[/\b(poco[\w ]+|m2\d{3}j\d\d[a-z]{2})(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/oid[^\)]+; (m?[12][0-389][01]\w{3,6}[c-y])( bui|; wv|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite)?)(?: bui|\))/i],[[l,/_/g," "],[g,_r],[m,v]],[/oid[^\)]+; (2\d{4}(283|rpbf)[cgl])( bui|\))/i,/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[l,/_/g," "],[g,_r],[m,b]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[l,[g,"OPPO"],[m,v]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[l,[g,"Vivo"],[m,v]],[/\b(rmx[1-3]\d{3})(?: bui|;|\))/i],[l,[g,"Realme"],[m,v]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[l,[g,cs],[m,v]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[l,[g,cs],[m,b]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[l,[g,mr],[m,b]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[l,[g,mr],[m,v]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[l,[g,"Lenovo"],[m,b]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[l,/_/g," "],[g,"Nokia"],[m,v]],[/(pixel c)\b/i],[l,[g,Ot],[m,b]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[l,[g,Ot],[m,v]],[/droid.+ (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[l,[g,Ft],[m,v]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[l,"Xperia Tablet"],[g,Ft],[m,b]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[l,[g,"OnePlus"],[m,v]],[/(alexa)webm/i,/(kf[a-z]{2}wi|aeo[c-r]{2})( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[l,[g,re],[m,b]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[l,/(.+)/g,"Fire Phone $1"],[g,re],[m,v]],[/(playbook);[-\w\),; ]+(rim)/i],[l,g,[m,b]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[l,[g,ce],[m,v]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[l,[g,ye],[m,b]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[l,[g,ye],[m,v]],[/(nexus 9)/i],[l,[g,"HTC"],[m,b]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[g,[l,/_/g," "],[m,v]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[l,[g,"Acer"],[m,b]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[l,[g,"Meizu"],[m,v]],[/; ((?:power )?armor(?:[\w ]{0,8}))(?: bui|\))/i],[l,[g,"Ulefone"],[m,v]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron|infinix|tecno)[-_ ]?([-\w]*)/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[g,l,[m,v]],[/(kobo)\s(ereader|touch)/i,/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[g,l,[m,b]],[/(surface duo)/i],[l,[g,gr],[m,b]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[l,[g,"Fairphone"],[m,v]],[/(u304aa)/i],[l,[g,"AT&T"],[m,v]],[/\bsie-(\w*)/i],[l,[g,"Siemens"],[m,v]],[/\b(rct\w+) b/i],[l,[g,"RCA"],[m,b]],[/\b(venue[\d ]{2,7}) b/i],[l,[g,"Dell"],[m,b]],[/\b(q(?:mv|ta)\w+) b/i],[l,[g,"Verizon"],[m,b]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[l,[g,"Barnes & Noble"],[m,b]],[/\b(tm\d{3}\w+) b/i],[l,[g,"NuVision"],[m,b]],[/\b(k88) b/i],[l,[g,"ZTE"],[m,b]],[/\b(nx\d{3}j) b/i],[l,[g,"ZTE"],[m,v]],[/\b(gen\d{3}) b.+49h/i],[l,[g,"Swiss"],[m,v]],[/\b(zur\d{3}) b/i],[l,[g,"Swiss"],[m,b]],[/\b((zeki)?tb.*\b) b/i],[l,[g,"Zeki"],[m,b]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[g,"Dragon Touch"],l,[m,b]],[/\b(ns-?\w{0,9}) b/i],[l,[g,"Insignia"],[m,b]],[/\b((nxa|next)-?\w{0,9}) b/i],[l,[g,"NextBook"],[m,b]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[g,"Voice"],l,[m,v]],[/\b(lvtel\-)?(v1[12]) b/i],[[g,"LvTel"],l,[m,v]],[/\b(ph-1) /i],[l,[g,"Essential"],[m,v]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[l,[g,"Envizen"],[m,b]],[/\b(trio[-\w\. ]+) b/i],[l,[g,"MachSpeed"],[m,b]],[/\btu_(1491) b/i],[l,[g,"Rotor"],[m,b]],[/(shield[\w ]+) b/i],[l,[g,"Nvidia"],[m,b]],[/(sprint) (\w+)/i],[g,l,[m,v]],[/(kin\.[onetw]{3})/i],[[l,/\./g," "],[g,gr],[m,v]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[l,[g,wr],[m,b]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[l,[g,wr],[m,v]],[/smart-tv.+(samsung)/i],[g,[m,G]],[/hbbtv.+maple;(\d+)/i],[[l,/^/,"SmartTV"],[g,jt],[m,G]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[g,mr],[m,G]],[/(apple) ?tv/i],[g,[l,Pe+" TV"],[m,G]],[/crkey/i],[[l,Mt+"cast"],[g,Ot],[m,G]],[/droid.+aft(\w+)( bui|\))/i],[l,[g,re],[m,G]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[l,[g,ds],[m,G]],[/(bravia[\w ]+)( bui|\))/i],[l,[g,Ft],[m,G]],[/(mitv-\w{5}) bui/i],[l,[g,_r],[m,G]],[/Hbbtv.*(technisat) (.*);/i],[g,l,[m,G]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[g,vr],[l,vr],[m,G]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[m,G]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[g,l,[m,I]],[/droid.+; (shield) bui/i],[l,[g,"Nvidia"],[m,I]],[/(playstation [345portablevi]+)/i],[l,[g,Ft],[m,I]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[l,[g,gr],[m,I]],[/((pebble))app/i],[g,l,[m,U]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[l,[g,Pe],[m,U]],[/droid.+; (glass) \d/i],[l,[g,Ot],[m,U]],[/droid.+; (wt63?0{2,3})\)/i],[l,[g,wr],[m,U]],[/(quest( 2| pro)?)/i],[l,[g,ps],[m,U]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[g,[m,ne]],[/(aeobc)\b/i],[l,[g,re],[m,ne]],[/droid .+?; ([^;]+?)(?: bui|; wv\)|\) applew).+? mobile safari/i],[l,[m,v]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[l,[m,b]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[m,b]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[m,v]],[/(android[-\w\. ]{0,9});.+buil/i],[l,[g,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[f,[h,$i+"HTML"]],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[f,[h,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i,/\b(libweb)/i],[h,f],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[f,h]],os:[[/microsoft (windows) (vista|xp)/i],[h,f],[/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i],[h,[f,br,fs]],[/windows nt 6\.2; (arm)/i,/windows[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i,/(?:win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[f,br,fs],[h,"Windows"]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/(?:ios;fbsv\/|iphone.+ios[\/ ])([\d\.]+)/i,/cfnetwork\/.+darwin/i],[[f,/_/g,"."],[h,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[h,us],[f,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[f,h],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[h,f],[/\(bb(10);/i],[f,[h,ce]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[f,[h,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[f,[h,It+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[f,[h,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[f,[h,"watchOS"]],[/crkey\/([\d\.]+)/i],[f,[h,Mt+"cast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[h,ls],f],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[h,f],[/(sunos) ?([\w\.\d]*)/i],[[h,"Solaris"],f],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux|serenityos)/i,/(unix) ?([\w\.]*)/i],[h,f]]},ae=function(O,A){if(typeof O===p&&(A=O,O=r),!(this instanceof ae))return new ae(O,A).getResult();var L=typeof t!==u&&t.navigator?t.navigator:r,H=O||(L&&L.userAgent?L.userAgent:n),Ee=L&&L.userAgentData?L.userAgentData:r,de=A?Ni(ms,A):ms,$=L&&L.userAgent==H;return this.getBrowser=function(){var P={};return P[h]=r,P[f]=r,ht.call(P,H,de.browser),P[c]=Ai(P[f]),$&&L&&L.brave&&typeof L.brave.isBrave==d&&(P[h]="Brave"),P},this.getCPU=function(){var P={};return P[w]=r,ht.call(P,H,de.cpu),P},this.getDevice=function(){var P={};return P[g]=r,P[l]=r,P[m]=r,ht.call(P,H,de.device),$&&!P[m]&&Ee&&Ee.mobile&&(P[m]=v),$&&P[l]=="Macintosh"&&L&&typeof L.standalone!==u&&L.maxTouchPoints&&L.maxTouchPoints>2&&(P[l]="iPad",P[m]=b),P},this.getEngine=function(){var P={};return P[h]=r,P[f]=r,ht.call(P,H,de.engine),P},this.getOS=function(){var P={};return P[h]=r,P[f]=r,ht.call(P,H,de.os),$&&!P[h]&&Ee&&Ee.platform!="Unknown"&&(P[h]=Ee.platform.replace(/chrome os/i,ls).replace(/macos/i,us)),P},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return H},this.setUA=function(P){return H=typeof P===a&&P.length>ee?vr(P,ee):P,this},this.setUA(H),this};ae.VERSION=i,ae.BROWSER=$t([h,f,c]),ae.CPU=$t([w]),ae.DEVICE=$t([l,g,m,I,v,G,b,U,ne]),ae.ENGINE=ae.OS=$t([h,f]),s.exports&&(e=s.exports=ae),e.UAParser=ae;var Ue=typeof t!==u&&(t.jQuery||t.Zepto);if(Ue&&!Ue.ua){var Nt=new ae;Ue.ua=Nt.getResult(),Ue.ua.get=function(){return Nt.getUA()},Ue.ua.set=function(O){Nt.setUA(O);var A=Nt.getResult();for(var L in A)Ue.ua[L]=A[L]}}})(typeof window=="object"?window:_)})(Nr,Nr.exports);var Ki=Nr.exports,K={},Vi=_&&_.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(K,"__esModule",{value:!0});K.Logger=void 0;const ze=Vi(ni),He="mediasoup-client";let Qi=class{constructor(e){e?(this._debug=(0,ze.default)(`${He}:${e}`),this._warn=(0,ze.default)(`${He}:WARN:${e}`),this._error=(0,ze.default)(`${He}:ERROR:${e}`)):(this._debug=(0,ze.default)(He),this._warn=(0,ze.default)(`${He}:WARN`),this._error=(0,ze.default)(`${He}:ERROR`)),this._debug.log=console.info.bind(console),this._warn.log=console.warn.bind(console),this._error.log=console.error.bind(console)}get debug(){return this._debug}get warn(){return this._warn}get error(){return this._error}};K.Logger=Qi;var be={},Hr={exports:{}},at=typeof Reflect=="object"?Reflect:null,ws=at&&typeof at.apply=="function"?at.apply:function(e,t,r){return Function.prototype.apply.call(e,t,r)},Jt;at&&typeof at.ownKeys=="function"?Jt=at.ownKeys:Object.getOwnPropertySymbols?Jt=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:Jt=function(e){return Object.getOwnPropertyNames(e)};function Wi(s){console&&console.warn&&console.warn(s)}var ai=Number.isNaN||function(e){return e!==e};function B(){B.init.call(this)}Hr.exports=B;Hr.exports.once=Xi;B.EventEmitter=B;B.prototype._events=void 0;B.prototype._eventsCount=0;B.prototype._maxListeners=void 0;var vs=10;function Yt(s){if(typeof s!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof s)}Object.defineProperty(B,"defaultMaxListeners",{enumerable:!0,get:function(){return vs},set:function(s){if(typeof s!="number"||s<0||ai(s))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+s+".");vs=s}});B.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};B.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||ai(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function oi(s){return s._maxListeners===void 0?B.defaultMaxListeners:s._maxListeners}B.prototype.getMaxListeners=function(){return oi(this)};B.prototype.emit=function(e){for(var t=[],r=1;r<arguments.length;r++)t.push(arguments[r]);var i=e==="error",n=this._events;if(n!==void 0)i=i&&n.error===void 0;else if(!i)return!1;if(i){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var d=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw d.context=o,d}var u=n[e];if(u===void 0)return!1;if(typeof u=="function")ws(u,this,t);else for(var p=u.length,a=ui(u,p),r=0;r<p;++r)ws(a[r],this,t);return!0};function ci(s,e,t,r){var i,n,o;if(Yt(t),n=s._events,n===void 0?(n=s._events=Object.create(null),s._eventsCount=0):(n.newListener!==void 0&&(s.emit("newListener",e,t.listener?t.listener:t),n=s._events),o=n[e]),o===void 0)o=n[e]=t,++s._eventsCount;else if(typeof o=="function"?o=n[e]=r?[t,o]:[o,t]:r?o.unshift(t):o.push(t),i=oi(s),i>0&&o.length>i&&!o.warned){o.warned=!0;var d=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");d.name="MaxListenersExceededWarning",d.emitter=s,d.type=e,d.count=o.length,Wi(d)}return s}B.prototype.addListener=function(e,t){return ci(this,e,t,!1)};B.prototype.on=B.prototype.addListener;B.prototype.prependListener=function(e,t){return ci(this,e,t,!0)};function Zi(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function di(s,e,t){var r={fired:!1,wrapFn:void 0,target:s,type:e,listener:t},i=Zi.bind(r);return i.listener=t,r.wrapFn=i,i}B.prototype.once=function(e,t){return Yt(t),this.on(e,di(this,e,t)),this};B.prototype.prependOnceListener=function(e,t){return Yt(t),this.prependListener(e,di(this,e,t)),this};B.prototype.removeListener=function(e,t){var r,i,n,o,d;if(Yt(t),i=this._events,i===void 0)return this;if(r=i[e],r===void 0)return this;if(r===t||r.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete i[e],i.removeListener&&this.emit("removeListener",e,r.listener||t));else if(typeof r!="function"){for(n=-1,o=r.length-1;o>=0;o--)if(r[o]===t||r[o].listener===t){d=r[o].listener,n=o;break}if(n<0)return this;n===0?r.shift():Ji(r,n),r.length===1&&(i[e]=r[0]),i.removeListener!==void 0&&this.emit("removeListener",e,d||t)}return this};B.prototype.off=B.prototype.removeListener;B.prototype.removeAllListeners=function(e){var t,r,i;if(r=this._events,r===void 0)return this;if(r.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):r[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete r[e]),this;if(arguments.length===0){var n=Object.keys(r),o;for(i=0;i<n.length;++i)o=n[i],o!=="removeListener"&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=r[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(i=t.length-1;i>=0;i--)this.removeListener(e,t[i]);return this};function pi(s,e,t){var r=s._events;if(r===void 0)return[];var i=r[e];return i===void 0?[]:typeof i=="function"?t?[i.listener||i]:[i]:t?Yi(i):ui(i,i.length)}B.prototype.listeners=function(e){return pi(this,e,!0)};B.prototype.rawListeners=function(e){return pi(this,e,!1)};B.listenerCount=function(s,e){return typeof s.listenerCount=="function"?s.listenerCount(e):li.call(s,e)};B.prototype.listenerCount=li;function li(s){var e=this._events;if(e!==void 0){var t=e[s];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}B.prototype.eventNames=function(){return this._eventsCount>0?Jt(this._events):[]};function ui(s,e){for(var t=new Array(e),r=0;r<e;++r)t[r]=s[r];return t}function Ji(s,e){for(;e+1<s.length;e++)s[e]=s[e+1];s.pop()}function Yi(s){for(var e=new Array(s.length),t=0;t<e.length;++t)e[t]=s[t].listener||s[t];return e}function Xi(s,e){return new Promise(function(t,r){function i(o){s.removeListener(e,n),r(o)}function n(){typeof s.removeListener=="function"&&s.removeListener("error",i),t([].slice.call(arguments))}hi(s,e,n,{once:!0}),e!=="error"&&en(s,i,{once:!0})})}function en(s,e,t){typeof s.on=="function"&&hi(s,"error",e,t)}function hi(s,e,t,r){if(typeof s.on=="function")r.once?s.once(e,t):s.on(e,t);else if(typeof s.addEventListener=="function")s.addEventListener(e,function i(n){r.once&&s.removeEventListener(e,i),t(n)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof s)}var tn=Hr.exports;Object.defineProperty(be,"__esModule",{value:!0});be.EnhancedEventEmitter=void 0;const rn=tn,sn=K,nn=new sn.Logger("EnhancedEventEmitter");class an extends rn.EventEmitter{constructor(){super(),this.setMaxListeners(1/0)}emit(e,...t){return super.emit(e,...t)}safeEmit(e,...t){const r=super.listenerCount(e);try{return super.emit(e,...t)}catch(i){return nn.error("safeEmit() | event listener threw an error [eventName:%s]:%o",e,i),!!r}}on(e,t){return super.on(e,t),this}off(e,t){return super.off(e,t),this}addListener(e,t){return super.on(e,t),this}prependListener(e,t){return super.prependListener(e,t),this}once(e,t){return super.once(e,t),this}prependOnceListener(e,t){return super.prependOnceListener(e,t),this}removeListener(e,t){return super.off(e,t),this}removeAllListeners(e){return super.removeAllListeners(e),this}listenerCount(e){return super.listenerCount(e)}listeners(e){return super.listeners(e)}rawListeners(e){return super.rawListeners(e)}}be.EnhancedEventEmitter=an;var X={};Object.defineProperty(X,"__esModule",{value:!0});X.InvalidStateError=X.UnsupportedError=void 0;class Gr extends Error{constructor(e){super(e),this.name="UnsupportedError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,Gr):this.stack=new Error(e).stack}}X.UnsupportedError=Gr;class qr extends Error{constructor(e){super(e),this.name="InvalidStateError",Error.hasOwnProperty("captureStackTrace")?Error.captureStackTrace(this,qr):this.stack=new Error(e).stack}}X.InvalidStateError=qr;var V={};Object.defineProperty(V,"__esModule",{value:!0});V.generateRandomNumber=V.clone=void 0;function on(s){if(s!==void 0)return Number.isNaN(s)?NaN:typeof structuredClone=="function"?structuredClone(s):JSON.parse(JSON.stringify(s))}V.clone=on;function cn(){return Math.round(Math.random()*1e7)}V.generateRandomNumber=cn;var S={},q={},Xt={},Ar={exports:{}},Rr,bs;function dn(){if(bs)return Rr;bs=1;var s=1e3,e=s*60,t=e*60,r=t*24,i=r*7,n=r*365.25;Rr=function(a,c){c=c||{};var l=typeof a;if(l==="string"&&a.length>0)return o(a);if(l==="number"&&isFinite(a))return c.long?u(a):d(a);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(a))};function o(a){if(a=String(a),!(a.length>100)){var c=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(a);if(c){var l=parseFloat(c[1]),h=(c[2]||"ms").toLowerCase();switch(h){case"years":case"year":case"yrs":case"yr":case"y":return l*n;case"weeks":case"week":case"w":return l*i;case"days":case"day":case"d":return l*r;case"hours":case"hour":case"hrs":case"hr":case"h":return l*t;case"minutes":case"minute":case"mins":case"min":case"m":return l*e;case"seconds":case"second":case"secs":case"sec":case"s":return l*s;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return l;default:return}}}}function d(a){var c=Math.abs(a);return c>=r?Math.round(a/r)+"d":c>=t?Math.round(a/t)+"h":c>=e?Math.round(a/e)+"m":c>=s?Math.round(a/s)+"s":a+"ms"}function u(a){var c=Math.abs(a);return c>=r?p(a,c,r,"day"):c>=t?p(a,c,t,"hour"):c>=e?p(a,c,e,"minute"):c>=s?p(a,c,s,"second"):a+" ms"}function p(a,c,l,h){var m=c>=l*1.5;return Math.round(a/l)+" "+h+(m?"s":"")}return Rr}function pn(s){t.debug=t,t.default=t,t.coerce=u,t.disable=n,t.enable=i,t.enabled=o,t.humanize=dn(),t.destroy=p,Object.keys(s).forEach(a=>{t[a]=s[a]}),t.names=[],t.skips=[],t.formatters={};function e(a){let c=0;for(let l=0;l<a.length;l++)c=(c<<5)-c+a.charCodeAt(l),c|=0;return t.colors[Math.abs(c)%t.colors.length]}t.selectColor=e;function t(a){let c,l=null,h,m;function g(...f){if(!g.enabled)return;const w=g,I=Number(new Date),v=I-(c||I);w.diff=v,w.prev=c,w.curr=I,c=I,f[0]=t.coerce(f[0]),typeof f[0]!="string"&&f.unshift("%O");let b=0;f[0]=f[0].replace(/%([a-zA-Z%])/g,(U,ne)=>{if(U==="%%")return"%";b++;const ee=t.formatters[ne];if(typeof ee=="function"){const re=f[b];U=ee.call(w,re),f.splice(b,1),b--}return U}),t.formatArgs.call(w,f),(w.log||t.log).apply(w,f)}return g.namespace=a,g.useColors=t.useColors(),g.color=t.selectColor(a),g.extend=r,g.destroy=t.destroy,Object.defineProperty(g,"enabled",{enumerable:!0,configurable:!1,get:()=>l!==null?l:(h!==t.namespaces&&(h=t.namespaces,m=t.enabled(a)),m),set:f=>{l=f}}),typeof t.init=="function"&&t.init(g),g}function r(a,c){const l=t(this.namespace+(typeof c>"u"?":":c)+a);return l.log=this.log,l}function i(a){t.save(a),t.namespaces=a,t.names=[],t.skips=[];let c;const l=(typeof a=="string"?a:"").split(/[\s,]+/),h=l.length;for(c=0;c<h;c++)l[c]&&(a=l[c].replace(/\*/g,".*?"),a[0]==="-"?t.skips.push(new RegExp("^"+a.slice(1)+"$")):t.names.push(new RegExp("^"+a+"$")))}function n(){const a=[...t.names.map(d),...t.skips.map(d).map(c=>"-"+c)].join(",");return t.enable(""),a}function o(a){if(a[a.length-1]==="*")return!0;let c,l;for(c=0,l=t.skips.length;c<l;c++)if(t.skips[c].test(a))return!1;for(c=0,l=t.names.length;c<l;c++)if(t.names[c].test(a))return!0;return!1}function d(a){return a.toString().substring(2,a.toString().length-2).replace(/\.\*\?$/,"*")}function u(a){return a instanceof Error?a.stack||a.message:a}function p(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.enable(t.load()),t}var ln=pn;(function(s,e){var t={};e.formatArgs=i,e.save=n,e.load=o,e.useColors=r,e.storage=d(),e.destroy=(()=>{let p=!1;return()=>{p||(p=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),e.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function r(){return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/)?!1:typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function i(p){if(p[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+p[0]+(this.useColors?"%c ":" ")+"+"+s.exports.humanize(this.diff),!this.useColors)return;const a="color: "+this.color;p.splice(1,0,a,"color: inherit");let c=0,l=0;p[0].replace(/%[a-zA-Z%]/g,h=>{h!=="%%"&&(c++,h==="%c"&&(l=c))}),p.splice(l,0,a)}e.log=console.debug||console.log||(()=>{});function n(p){try{p?e.storage.setItem("debug",p):e.storage.removeItem("debug")}catch{}}function o(){let p;try{p=e.storage.getItem("debug")}catch{}return!p&&typeof process<"u"&&"env"in process&&(p=t.DEBUG),p}function d(){try{return localStorage}catch{}}s.exports=ln(e);const{formatters:u}=s.exports;u.j=function(p){try{return JSON.stringify(p)}catch(a){return"[UnexpectedJSONParseError]: "+a.message}}})(Ar,Ar.exports);var un=Ar.exports,hn=_&&_.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(Xt,"__esModule",{value:!0});Xt.Logger=void 0;const Ge=hn(un),qe="h264-profile-level-id";let fn=class{constructor(e){e?(this._debug=(0,Ge.default)(`${qe}:${e}`),this._warn=(0,Ge.default)(`${qe}:WARN:${e}`),this._error=(0,Ge.default)(`${qe}:ERROR:${e}`)):(this._debug=(0,Ge.default)(qe),this._warn=(0,Ge.default)(`${qe}:WARN`),this._error=(0,Ge.default)(`${qe}:ERROR`)),this._debug.log=console.info.bind(console),this._warn.log=console.warn.bind(console),this._error.log=console.error.bind(console)}get debug(){return this._debug}get warn(){return this._warn}get error(){return this._error}};Xt.Logger=fn;Object.defineProperty(q,"__esModule",{value:!0});q.generateProfileLevelIdStringForAnswer=q.isSameProfile=q.parseSdpProfileLevelId=q.levelToString=q.profileToString=q.profileLevelIdToString=q.parseProfileLevelId=q.ProfileLevelId=q.Level=q.Profile=void 0;const mn=Xt,je=new mn.Logger;var z;(function(s){s[s.ConstrainedBaseline=1]="ConstrainedBaseline",s[s.Baseline=2]="Baseline",s[s.Main=3]="Main",s[s.ConstrainedHigh=4]="ConstrainedHigh",s[s.High=5]="High",s[s.PredictiveHigh444=6]="PredictiveHigh444"})(z||(q.Profile=z={}));var E;(function(s){s[s.L1_b=0]="L1_b",s[s.L1=10]="L1",s[s.L1_1=11]="L1_1",s[s.L1_2=12]="L1_2",s[s.L1_3=13]="L1_3",s[s.L2=20]="L2",s[s.L2_1=21]="L2_1",s[s.L2_2=22]="L2_2",s[s.L3=30]="L3",s[s.L3_1=31]="L3_1",s[s.L3_2=32]="L3_2",s[s.L4=40]="L4",s[s.L4_1=41]="L4_1",s[s.L4_2=42]="L4_2",s[s.L5=50]="L5",s[s.L5_1=51]="L5_1",s[s.L5_2=52]="L5_2"})(E||(q.Level=E={}));class er{constructor(e,t){this.profile=e,this.level=t}}q.ProfileLevelId=er;const gn=new er(z.ConstrainedBaseline,E.L3_1);class Re{constructor(e){this.mask=~Ss("x",e),this.masked_value=Ss("1",e)}isMatch(e){return this.masked_value===(e&this.mask)}}class Ce{constructor(e,t,r){this.profile_idc=e,this.profile_iop=t,this.profile=r}}const _n=[new Ce(66,new Re("x1xx0000"),z.ConstrainedBaseline),new Ce(77,new Re("1xxx0000"),z.ConstrainedBaseline),new Ce(88,new Re("11xx0000"),z.ConstrainedBaseline),new Ce(66,new Re("x0xx0000"),z.Baseline),new Ce(88,new Re("10xx0000"),z.Baseline),new Ce(77,new Re("0x0x0000"),z.Main),new Ce(100,new Re("00000000"),z.High),new Ce(100,new Re("00001100"),z.ConstrainedHigh),new Ce(244,new Re("00000000"),z.PredictiveHigh444)];function fi(s){if(typeof s!="string"||s.length!==6)return;const t=parseInt(s,16);if(t===0)return;const r=t&255,i=t>>8&255,n=t>>16&255;let o;switch(r){case E.L1_1:{o=i&16?E.L1_b:E.L1_1;break}case E.L1:case E.L1_2:case E.L1_3:case E.L2:case E.L2_1:case E.L2_2:case E.L3:case E.L3_1:case E.L3_2:case E.L4:case E.L4_1:case E.L4_2:case E.L5:case E.L5_1:case E.L5_2:{o=r;break}default:{je.warn(`parseProfileLevelId() | unrecognized level_idc [str:${s}, level_idc:${r}]`);return}}for(const d of _n)if(n===d.profile_idc&&d.profile_iop.isMatch(i))return new er(d.profile,o);je.warn(`parseProfileLevelId() | unrecognized profile_idc/profile_iop combination [str:${s}, profile_idc:${n}, profile_iop:${i}]`)}q.parseProfileLevelId=fi;function mi(s){if(s.level==E.L1_b)switch(s.profile){case z.ConstrainedBaseline:return"42f00b";case z.Baseline:return"42100b";case z.Main:return"4d100b";default:{je.warn(`profileLevelIdToString() | Level 1_b not is allowed for profile ${s.profile}`);return}}let e;switch(s.profile){case z.ConstrainedBaseline:{e="42e0";break}case z.Baseline:{e="4200";break}case z.Main:{e="4d00";break}case z.ConstrainedHigh:{e="640c";break}case z.High:{e="6400";break}case z.PredictiveHigh444:{e="f400";break}default:{je.warn(`profileLevelIdToString() | unrecognized profile ${s.profile}`);return}}let t=s.level.toString(16);return t.length===1&&(t=`0${t}`),`${e}${t}`}q.profileLevelIdToString=mi;function wn(s){switch(s){case z.ConstrainedBaseline:return"ConstrainedBaseline";case z.Baseline:return"Baseline";case z.Main:return"Main";case z.ConstrainedHigh:return"ConstrainedHigh";case z.High:return"High";case z.PredictiveHigh444:return"PredictiveHigh444";default:{je.warn(`profileToString() | unrecognized profile ${s}`);return}}}q.profileToString=wn;function vn(s){switch(s){case E.L1_b:return"1b";case E.L1:return"1";case E.L1_1:return"1.1";case E.L1_2:return"1.2";case E.L1_3:return"1.3";case E.L2:return"2";case E.L2_1:return"2.1";case E.L2_2:return"2.2";case E.L3:return"3";case E.L3_1:return"3.1";case E.L3_2:return"3.2";case E.L4:return"4";case E.L4_1:return"4.1";case E.L4_2:return"4.2";case E.L5:return"5";case E.L5_1:return"5.1";case E.L5_2:return"5.2";default:{je.warn(`levelToString() | unrecognized level ${s}`);return}}}q.levelToString=vn;function vt(s={}){const e=s["profile-level-id"];return e?fi(e):gn}q.parseSdpProfileLevelId=vt;function bn(s={},e={}){const t=vt(s),r=vt(e);return!!(t&&r&&t.profile===r.profile)}q.isSameProfile=bn;function Sn(s={},e={}){if(!s["profile-level-id"]&&!e["profile-level-id"]){je.warn("generateProfileLevelIdStringForAnswer() | profile-level-id missing in local and remote params");return}const t=vt(s),r=vt(e);if(!t)throw new TypeError("invalid local_profile_level_id");if(!r)throw new TypeError("invalid remote_profile_level_id");if(t.profile!==r.profile)throw new TypeError("H264 Profile mismatch");const i=ys(s)&&ys(e),n=t.level,o=r.level,d=Rn(n,o),u=i?n:d;return je.debug(`generateProfileLevelIdStringForAnswer() | result [profile:${t.profile}, level:${u}]`),mi(new er(t.profile,u))}q.generateProfileLevelIdStringForAnswer=Sn;function Ss(s,e){return+(e[0]===s)<<7|+(e[1]===s)<<6|+(e[2]===s)<<5|+(e[3]===s)<<4|+(e[4]===s)<<3|+(e[5]===s)<<2|+(e[6]===s)<<1|+(e[7]===s)<<0}function yn(s,e){return s===E.L1_b?e!==E.L1&&e!==E.L1_b:e===E.L1_b?s!==E.L1:s<e}function Rn(s,e){return yn(s,e)?s:e}function ys(s={}){const e=s["level-asymmetry-allowed"];return e===!0||e===1||e==="1"}var Cn=_&&_.__createBinding||(Object.create?function(s,e,t,r){r===void 0&&(r=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(s,r,i)}:function(s,e,t,r){r===void 0&&(r=t),s[r]=e[t]}),Dn=_&&_.__setModuleDefault||(Object.create?function(s,e){Object.defineProperty(s,"default",{enumerable:!0,value:e})}:function(s,e){s.default=e}),gi=_&&_.__importStar||function(s){if(s&&s.__esModule)return s;var e={};if(s!=null)for(var t in s)t!=="default"&&Object.prototype.hasOwnProperty.call(s,t)&&Cn(e,s,t);return Dn(e,s),e};Object.defineProperty(S,"__esModule",{value:!0});S.canReceive=S.canSend=S.generateProbatorRtpParameters=S.reduceCodecs=S.getSendingRemoteRtpParameters=S.getSendingRtpParameters=S.getRecvRtpCapabilities=S.getExtendedRtpCapabilities=S.validateSctpStreamParameters=S.validateSctpParameters=S.validateNumSctpStreams=S.validateSctpCapabilities=S.validateRtcpParameters=S.validateRtpEncodingParameters=S.validateRtpHeaderExtensionParameters=S.validateRtpCodecParameters=S.validateRtpParameters=S.validateRtpHeaderExtension=S.validateRtcpFeedback=S.validateRtpCodecCapability=S.validateRtpCapabilities=void 0;const Rs=gi(q),Tn=gi(V),Pn="probator",En=1234,Ln=127;function xn(s){if(typeof s!="object")throw new TypeError("caps is not an object");if(s.codecs&&!Array.isArray(s.codecs))throw new TypeError("caps.codecs is not an array");s.codecs||(s.codecs=[]);for(const e of s.codecs)_i(e);if(s.headerExtensions&&!Array.isArray(s.headerExtensions))throw new TypeError("caps.headerExtensions is not an array");s.headerExtensions||(s.headerExtensions=[]);for(const e of s.headerExtensions)wi(e)}S.validateRtpCapabilities=xn;function _i(s){const e=new RegExp("^(audio|video)/(.+)","i");if(typeof s!="object")throw new TypeError("codec is not an object");if(!s.mimeType||typeof s.mimeType!="string")throw new TypeError("missing codec.mimeType");const t=e.exec(s.mimeType);if(!t)throw new TypeError("invalid codec.mimeType");if(s.kind=t[1].toLowerCase(),s.preferredPayloadType&&typeof s.preferredPayloadType!="number")throw new TypeError("invalid codec.preferredPayloadType");if(typeof s.clockRate!="number")throw new TypeError("missing codec.clockRate");s.kind==="audio"?typeof s.channels!="number"&&(s.channels=1):delete s.channels,(!s.parameters||typeof s.parameters!="object")&&(s.parameters={});for(const r of Object.keys(s.parameters)){let i=s.parameters[r];if(i===void 0&&(s.parameters[r]="",i=""),typeof i!="string"&&typeof i!="number")throw new TypeError(`invalid codec parameter [key:${r}s, value:${i}]`);if(r==="apt"&&typeof i!="number")throw new TypeError("invalid codec apt parameter")}(!s.rtcpFeedback||!Array.isArray(s.rtcpFeedback))&&(s.rtcpFeedback=[]);for(const r of s.rtcpFeedback)Kr(r)}S.validateRtpCodecCapability=_i;function Kr(s){if(typeof s!="object")throw new TypeError("fb is not an object");if(!s.type||typeof s.type!="string")throw new TypeError("missing fb.type");(!s.parameter||typeof s.parameter!="string")&&(s.parameter="")}S.validateRtcpFeedback=Kr;function wi(s){if(typeof s!="object")throw new TypeError("ext is not an object");if(s.kind!=="audio"&&s.kind!=="video")throw new TypeError("invalid ext.kind");if(!s.uri||typeof s.uri!="string")throw new TypeError("missing ext.uri");if(typeof s.preferredId!="number")throw new TypeError("missing ext.preferredId");if(s.preferredEncrypt&&typeof s.preferredEncrypt!="boolean")throw new TypeError("invalid ext.preferredEncrypt");if(s.preferredEncrypt||(s.preferredEncrypt=!1),s.direction&&typeof s.direction!="string")throw new TypeError("invalid ext.direction");s.direction||(s.direction="sendrecv")}S.validateRtpHeaderExtension=wi;function Vr(s){if(typeof s!="object")throw new TypeError("params is not an object");if(s.mid&&typeof s.mid!="string")throw new TypeError("params.mid is not a string");if(!Array.isArray(s.codecs))throw new TypeError("missing params.codecs");for(const e of s.codecs)vi(e);if(s.headerExtensions&&!Array.isArray(s.headerExtensions))throw new TypeError("params.headerExtensions is not an array");s.headerExtensions||(s.headerExtensions=[]);for(const e of s.headerExtensions)bi(e);if(s.encodings&&!Array.isArray(s.encodings))throw new TypeError("params.encodings is not an array");s.encodings||(s.encodings=[]);for(const e of s.encodings)Si(e);if(s.rtcp&&typeof s.rtcp!="object")throw new TypeError("params.rtcp is not an object");s.rtcp||(s.rtcp={}),yi(s.rtcp)}S.validateRtpParameters=Vr;function vi(s){const e=new RegExp("^(audio|video)/(.+)","i");if(typeof s!="object")throw new TypeError("codec is not an object");if(!s.mimeType||typeof s.mimeType!="string")throw new TypeError("missing codec.mimeType");const t=e.exec(s.mimeType);if(!t)throw new TypeError("invalid codec.mimeType");if(typeof s.payloadType!="number")throw new TypeError("missing codec.payloadType");if(typeof s.clockRate!="number")throw new TypeError("missing codec.clockRate");t[1].toLowerCase()==="audio"?typeof s.channels!="number"&&(s.channels=1):delete s.channels,(!s.parameters||typeof s.parameters!="object")&&(s.parameters={});for(const i of Object.keys(s.parameters)){let n=s.parameters[i];if(n===void 0&&(s.parameters[i]="",n=""),typeof n!="string"&&typeof n!="number")throw new TypeError(`invalid codec parameter [key:${i}s, value:${n}]`);if(i==="apt"&&typeof n!="number")throw new TypeError("invalid codec apt parameter")}(!s.rtcpFeedback||!Array.isArray(s.rtcpFeedback))&&(s.rtcpFeedback=[]);for(const i of s.rtcpFeedback)Kr(i)}S.validateRtpCodecParameters=vi;function bi(s){if(typeof s!="object")throw new TypeError("ext is not an object");if(!s.uri||typeof s.uri!="string")throw new TypeError("missing ext.uri");if(typeof s.id!="number")throw new TypeError("missing ext.id");if(s.encrypt&&typeof s.encrypt!="boolean")throw new TypeError("invalid ext.encrypt");s.encrypt||(s.encrypt=!1),(!s.parameters||typeof s.parameters!="object")&&(s.parameters={});for(const e of Object.keys(s.parameters)){let t=s.parameters[e];if(t===void 0&&(s.parameters[e]="",t=""),typeof t!="string"&&typeof t!="number")throw new TypeError("invalid header extension parameter")}}S.validateRtpHeaderExtensionParameters=bi;function Si(s){if(typeof s!="object")throw new TypeError("encoding is not an object");if(s.ssrc&&typeof s.ssrc!="number")throw new TypeError("invalid encoding.ssrc");if(s.rid&&typeof s.rid!="string")throw new TypeError("invalid encoding.rid");if(s.rtx&&typeof s.rtx!="object")throw new TypeError("invalid encoding.rtx");if(s.rtx&&typeof s.rtx.ssrc!="number")throw new TypeError("missing encoding.rtx.ssrc");if((!s.dtx||typeof s.dtx!="boolean")&&(s.dtx=!1),s.scalabilityMode&&typeof s.scalabilityMode!="string")throw new TypeError("invalid encoding.scalabilityMode")}S.validateRtpEncodingParameters=Si;function yi(s){if(typeof s!="object")throw new TypeError("rtcp is not an object");if(s.cname&&typeof s.cname!="string")throw new TypeError("invalid rtcp.cname");(!s.reducedSize||typeof s.reducedSize!="boolean")&&(s.reducedSize=!0)}S.validateRtcpParameters=yi;function Mn(s){if(typeof s!="object")throw new TypeError("caps is not an object");if(!s.numStreams||typeof s.numStreams!="object")throw new TypeError("missing caps.numStreams");Ri(s.numStreams)}S.validateSctpCapabilities=Mn;function Ri(s){if(typeof s!="object")throw new TypeError("numStreams is not an object");if(typeof s.OS!="number")throw new TypeError("missing numStreams.OS");if(typeof s.MIS!="number")throw new TypeError("missing numStreams.MIS")}S.validateNumSctpStreams=Ri;function In(s){if(typeof s!="object")throw new TypeError("params is not an object");if(typeof s.port!="number")throw new TypeError("missing params.port");if(typeof s.OS!="number")throw new TypeError("missing params.OS");if(typeof s.MIS!="number")throw new TypeError("missing params.MIS");if(typeof s.maxMessageSize!="number")throw new TypeError("missing params.maxMessageSize")}S.validateSctpParameters=In;function On(s){if(typeof s!="object")throw new TypeError("params is not an object");if(typeof s.streamId!="number")throw new TypeError("missing params.streamId");let e=!1;if(typeof s.ordered=="boolean"?e=!0:s.ordered=!0,s.maxPacketLifeTime&&typeof s.maxPacketLifeTime!="number")throw new TypeError("invalid params.maxPacketLifeTime");if(s.maxRetransmits&&typeof s.maxRetransmits!="number")throw new TypeError("invalid params.maxRetransmits");if(s.maxPacketLifeTime&&s.maxRetransmits)throw new TypeError("cannot provide both maxPacketLifeTime and maxRetransmits");if(e&&s.ordered&&(s.maxPacketLifeTime||s.maxRetransmits))throw new TypeError("cannot be ordered with maxPacketLifeTime or maxRetransmits");if(!e&&(s.maxPacketLifeTime||s.maxRetransmits)&&(s.ordered=!1),s.label&&typeof s.label!="string")throw new TypeError("invalid params.label");if(s.protocol&&typeof s.protocol!="string")throw new TypeError("invalid params.protocol")}S.validateSctpStreamParameters=On;function kn(s,e){const t={codecs:[],headerExtensions:[]};for(const r of e.codecs||[]){if(wt(r))continue;const i=(s.codecs||[]).find(o=>Ci(o,r,{strict:!0,modify:!0}));if(!i)continue;const n={mimeType:i.mimeType,kind:i.kind,clockRate:i.clockRate,channels:i.channels,localPayloadType:i.preferredPayloadType,localRtxPayloadType:void 0,remotePayloadType:r.preferredPayloadType,remoteRtxPayloadType:void 0,localParameters:i.parameters,remoteParameters:r.parameters,rtcpFeedback:Hn(i,r)};t.codecs.push(n)}for(const r of t.codecs){const i=s.codecs.find(o=>wt(o)&&o.parameters.apt===r.localPayloadType),n=e.codecs.find(o=>wt(o)&&o.parameters.apt===r.remotePayloadType);i&&n&&(r.localRtxPayloadType=i.preferredPayloadType,r.remoteRtxPayloadType=n.preferredPayloadType)}for(const r of e.headerExtensions){const i=s.headerExtensions.find(o=>zn(o,r));if(!i)continue;const n={kind:r.kind,uri:r.uri,sendId:i.preferredId,recvId:r.preferredId,encrypt:i.preferredEncrypt,direction:"sendrecv"};switch(r.direction){case"sendrecv":{n.direction="sendrecv";break}case"recvonly":{n.direction="sendonly";break}case"sendonly":{n.direction="recvonly";break}case"inactive":{n.direction="inactive";break}}t.headerExtensions.push(n)}return t}S.getExtendedRtpCapabilities=kn;function jn(s){const e={codecs:[],headerExtensions:[]};for(const t of s.codecs){const r={mimeType:t.mimeType,kind:t.kind,preferredPayloadType:t.remotePayloadType,clockRate:t.clockRate,channels:t.channels,parameters:t.localParameters,rtcpFeedback:t.rtcpFeedback};if(e.codecs.push(r),!t.remoteRtxPayloadType)continue;const i={mimeType:`${t.kind}/rtx`,kind:t.kind,preferredPayloadType:t.remoteRtxPayloadType,clockRate:t.clockRate,parameters:{apt:t.remotePayloadType},rtcpFeedback:[]};e.codecs.push(i)}for(const t of s.headerExtensions){if(t.direction!=="sendrecv"&&t.direction!=="recvonly")continue;const r={kind:t.kind,uri:t.uri,preferredId:t.recvId,preferredEncrypt:t.encrypt,direction:t.direction};e.headerExtensions.push(r)}return e}S.getRecvRtpCapabilities=jn;function Fn(s,e){const t={mid:void 0,codecs:[],headerExtensions:[],encodings:[],rtcp:{}};for(const r of e.codecs){if(r.kind!==s)continue;const i={mimeType:r.mimeType,payloadType:r.localPayloadType,clockRate:r.clockRate,channels:r.channels,parameters:r.localParameters,rtcpFeedback:r.rtcpFeedback};if(t.codecs.push(i),r.localRtxPayloadType){const n={mimeType:`${r.kind}/rtx`,payloadType:r.localRtxPayloadType,clockRate:r.clockRate,parameters:{apt:r.localPayloadType},rtcpFeedback:[]};t.codecs.push(n)}}for(const r of e.headerExtensions){if(r.kind&&r.kind!==s||r.direction!=="sendrecv"&&r.direction!=="sendonly")continue;const i={uri:r.uri,id:r.sendId,encrypt:r.encrypt,parameters:{}};t.headerExtensions.push(i)}return t}S.getSendingRtpParameters=Fn;function $n(s,e){const t={mid:void 0,codecs:[],headerExtensions:[],encodings:[],rtcp:{}};for(const r of e.codecs){if(r.kind!==s)continue;const i={mimeType:r.mimeType,payloadType:r.localPayloadType,clockRate:r.clockRate,channels:r.channels,parameters:r.remoteParameters,rtcpFeedback:r.rtcpFeedback};if(t.codecs.push(i),r.localRtxPayloadType){const n={mimeType:`${r.kind}/rtx`,payloadType:r.localRtxPayloadType,clockRate:r.clockRate,parameters:{apt:r.localPayloadType},rtcpFeedback:[]};t.codecs.push(n)}}for(const r of e.headerExtensions){if(r.kind&&r.kind!==s||r.direction!=="sendrecv"&&r.direction!=="sendonly")continue;const i={uri:r.uri,id:r.sendId,encrypt:r.encrypt,parameters:{}};t.headerExtensions.push(i)}if(t.headerExtensions.some(r=>r.uri==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"))for(const r of t.codecs)r.rtcpFeedback=(r.rtcpFeedback||[]).filter(i=>i.type!=="goog-remb");else if(t.headerExtensions.some(r=>r.uri==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"))for(const r of t.codecs)r.rtcpFeedback=(r.rtcpFeedback||[]).filter(i=>i.type!=="transport-cc");else for(const r of t.codecs)r.rtcpFeedback=(r.rtcpFeedback||[]).filter(i=>i.type!=="transport-cc"&&i.type!=="goog-remb");return t}S.getSendingRemoteRtpParameters=$n;function Nn(s,e){const t=[];if(!e)t.push(s[0]),wt(s[1])&&t.push(s[1]);else{for(let r=0;r<s.length;++r)if(Ci(s[r],e)){t.push(s[r]),wt(s[r+1])&&t.push(s[r+1]);break}if(t.length===0)throw new TypeError("no matching codec found")}return t}S.reduceCodecs=Nn;function An(s){s=Tn.clone(s),Vr(s);const e={mid:Pn,codecs:[],headerExtensions:[],encodings:[{ssrc:En}],rtcp:{cname:"probator"}};return e.codecs.push(s.codecs[0]),e.codecs[0].payloadType=Ln,e.headerExtensions=s.headerExtensions,e}S.generateProbatorRtpParameters=An;function Bn(s,e){return e.codecs.some(t=>t.kind===s)}S.canSend=Bn;function Un(s,e){if(Vr(s),s.codecs.length===0)return!1;const t=s.codecs[0];return e.codecs.some(r=>r.remotePayloadType===t.payloadType)}S.canReceive=Un;function wt(s){return s?/.+\/rtx$/i.test(s.mimeType):!1}function Ci(s,e,{strict:t=!1,modify:r=!1}={}){const i=s.mimeType.toLowerCase(),n=e.mimeType.toLowerCase();if(i!==n||s.clockRate!==e.clockRate||s.channels!==e.channels)return!1;switch(i){case"video/h264":{if(t){const o=s.parameters["packetization-mode"]||0,d=e.parameters["packetization-mode"]||0;if(o!==d||!Rs.isSameProfile(s.parameters,e.parameters))return!1;let u;try{u=Rs.generateProfileLevelIdStringForAnswer(s.parameters,e.parameters)}catch{return!1}r&&(u?(s.parameters["profile-level-id"]=u,e.parameters["profile-level-id"]=u):(delete s.parameters["profile-level-id"],delete e.parameters["profile-level-id"]))}break}case"video/vp9":{if(t){const o=s.parameters["profile-id"]||0,d=e.parameters["profile-id"]||0;if(o!==d)return!1}break}}return!0}function zn(s,e){return!(s.kind&&e.kind&&s.kind!==e.kind||s.uri!==e.uri)}function Hn(s,e){const t=[];for(const r of s.rtcpFeedback||[]){const i=(e.rtcpFeedback||[]).find(n=>n.type===r.type&&(n.parameter===r.parameter||!n.parameter&&!r.parameter));i&&t.push(i)}return t}var bt={},Oe={},tr={},Br={exports:{}},Cr,Cs;function Gn(){if(Cs)return Cr;Cs=1;var s=1e3,e=s*60,t=e*60,r=t*24,i=r*7,n=r*365.25;Cr=function(a,c){c=c||{};var l=typeof a;if(l==="string"&&a.length>0)return o(a);if(l==="number"&&isFinite(a))return c.long?u(a):d(a);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(a))};function o(a){if(a=String(a),!(a.length>100)){var c=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(a);if(c){var l=parseFloat(c[1]),h=(c[2]||"ms").toLowerCase();switch(h){case"years":case"year":case"yrs":case"yr":case"y":return l*n;case"weeks":case"week":case"w":return l*i;case"days":case"day":case"d":return l*r;case"hours":case"hour":case"hrs":case"hr":case"h":return l*t;case"minutes":case"minute":case"mins":case"min":case"m":return l*e;case"seconds":case"second":case"secs":case"sec":case"s":return l*s;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return l;default:return}}}}function d(a){var c=Math.abs(a);return c>=r?Math.round(a/r)+"d":c>=t?Math.round(a/t)+"h":c>=e?Math.round(a/e)+"m":c>=s?Math.round(a/s)+"s":a+"ms"}function u(a){var c=Math.abs(a);return c>=r?p(a,c,r,"day"):c>=t?p(a,c,t,"hour"):c>=e?p(a,c,e,"minute"):c>=s?p(a,c,s,"second"):a+" ms"}function p(a,c,l,h){var m=c>=l*1.5;return Math.round(a/l)+" "+h+(m?"s":"")}return Cr}function qn(s){t.debug=t,t.default=t,t.coerce=u,t.disable=n,t.enable=i,t.enabled=o,t.humanize=Gn(),t.destroy=p,Object.keys(s).forEach(a=>{t[a]=s[a]}),t.names=[],t.skips=[],t.formatters={};function e(a){let c=0;for(let l=0;l<a.length;l++)c=(c<<5)-c+a.charCodeAt(l),c|=0;return t.colors[Math.abs(c)%t.colors.length]}t.selectColor=e;function t(a){let c,l=null,h,m;function g(...f){if(!g.enabled)return;const w=g,I=Number(new Date),v=I-(c||I);w.diff=v,w.prev=c,w.curr=I,c=I,f[0]=t.coerce(f[0]),typeof f[0]!="string"&&f.unshift("%O");let b=0;f[0]=f[0].replace(/%([a-zA-Z%])/g,(U,ne)=>{if(U==="%%")return"%";b++;const ee=t.formatters[ne];if(typeof ee=="function"){const re=f[b];U=ee.call(w,re),f.splice(b,1),b--}return U}),t.formatArgs.call(w,f),(w.log||t.log).apply(w,f)}return g.namespace=a,g.useColors=t.useColors(),g.color=t.selectColor(a),g.extend=r,g.destroy=t.destroy,Object.defineProperty(g,"enabled",{enumerable:!0,configurable:!1,get:()=>l!==null?l:(h!==t.namespaces&&(h=t.namespaces,m=t.enabled(a)),m),set:f=>{l=f}}),typeof t.init=="function"&&t.init(g),g}function r(a,c){const l=t(this.namespace+(typeof c>"u"?":":c)+a);return l.log=this.log,l}function i(a){t.save(a),t.namespaces=a,t.names=[],t.skips=[];let c;const l=(typeof a=="string"?a:"").split(/[\s,]+/),h=l.length;for(c=0;c<h;c++)l[c]&&(a=l[c].replace(/\*/g,".*?"),a[0]==="-"?t.skips.push(new RegExp("^"+a.slice(1)+"$")):t.names.push(new RegExp("^"+a+"$")))}function n(){const a=[...t.names.map(d),...t.skips.map(d).map(c=>"-"+c)].join(",");return t.enable(""),a}function o(a){if(a[a.length-1]==="*")return!0;let c,l;for(c=0,l=t.skips.length;c<l;c++)if(t.skips[c].test(a))return!1;for(c=0,l=t.names.length;c<l;c++)if(t.names[c].test(a))return!0;return!1}function d(a){return a.toString().substring(2,a.toString().length-2).replace(/\.\*\?$/,"*")}function u(a){return a instanceof Error?a.stack||a.message:a}function p(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.enable(t.load()),t}var Kn=qn;(function(s,e){var t={};e.formatArgs=i,e.save=n,e.load=o,e.useColors=r,e.storage=d(),e.destroy=(()=>{let p=!1;return()=>{p||(p=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),e.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function r(){return typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs)?!0:typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/)?!1:typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function i(p){if(p[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+p[0]+(this.useColors?"%c ":" ")+"+"+s.exports.humanize(this.diff),!this.useColors)return;const a="color: "+this.color;p.splice(1,0,a,"color: inherit");let c=0,l=0;p[0].replace(/%[a-zA-Z%]/g,h=>{h!=="%%"&&(c++,h==="%c"&&(l=c))}),p.splice(l,0,a)}e.log=console.debug||console.log||(()=>{});function n(p){try{p?e.storage.setItem("debug",p):e.storage.removeItem("debug")}catch{}}function o(){let p;try{p=e.storage.getItem("debug")}catch{}return!p&&typeof process<"u"&&"env"in process&&(p=t.DEBUG),p}function d(){try{return localStorage}catch{}}s.exports=Kn(e);const{formatters:u}=s.exports;u.j=function(p){try{return JSON.stringify(p)}catch(a){return"[UnexpectedJSONParseError]: "+a.message}}})(Br,Br.exports);var Vn=Br.exports;Object.defineProperty(tr,"__esModule",{value:!0});tr.Logger=void 0;const Ke=Vn,Ve="awaitqueue";class Qn{constructor(e){e?(this._debug=(0,Ke.default)(`${Ve}:${e}`),this._warn=(0,Ke.default)(`${Ve}:WARN:${e}`),this._error=(0,Ke.default)(`${Ve}:ERROR:${e}`)):(this._debug=(0,Ke.default)(Ve),this._warn=(0,Ke.default)(`${Ve}:WARN`),this._error=(0,Ke.default)(`${Ve}:ERROR`)),this._debug.log=console.info.bind(console),this._warn.log=console.warn.bind(console),this._error.log=console.error.bind(console)}get debug(){return this._debug}get warn(){return this._warn}get error(){return this._error}}tr.Logger=Qn;Object.defineProperty(Oe,"__esModule",{value:!0});Oe.AwaitQueue=Oe.AwaitQueueRemovedTaskError=Oe.AwaitQueueStoppedError=void 0;const Wn=tr,Le=new Wn.Logger;class rr extends Error{constructor(e){super(e??"AwaitQueue stopped"),this.name="AwaitQueueStoppedError",typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,rr)}}Oe.AwaitQueueStoppedError=rr;class sr extends Error{constructor(e){super(e??"AwaitQueue task removed"),this.name="AwaitQueueRemovedTaskError",typeof Error.captureStackTrace=="function"&&Error.captureStackTrace(this,sr)}}Oe.AwaitQueueRemovedTaskError=sr;class Zn{constructor(){this.pendingTasks=new Map,this.nextTaskId=0,this.stopping=!1}get size(){return this.pendingTasks.size}async push(e,t){if(t=t??e.name,Le.debug(`push() [name:${t}]`),typeof e!="function")throw new TypeError("given task is not a function");if(t)try{Object.defineProperty(e,"name",{value:t})}catch{}return new Promise((r,i)=>{const n={id:this.nextTaskId++,task:e,name:t,enqueuedAt:Date.now(),executedAt:void 0,completed:!1,resolve:o=>{if(n.completed)return;n.completed=!0,this.pendingTasks.delete(n.id),Le.debug(`resolving task [name:${n.name}]`),r(o);const[d]=this.pendingTasks.values();d&&!d.executedAt&&this.execute(d)},reject:o=>{if(!n.completed&&(n.completed=!0,this.pendingTasks.delete(n.id),Le.debug(`rejecting task [name:${n.name}]: %s`,String(o)),i(o),!this.stopping)){const[d]=this.pendingTasks.values();d&&!d.executedAt&&this.execute(d)}}};this.pendingTasks.set(n.id,n),this.pendingTasks.size===1&&this.execute(n)})}stop(){Le.debug("stop()"),this.stopping=!0;for(const e of this.pendingTasks.values())Le.debug(`stop() | stopping task [name:${e.name}]`),e.reject(new rr);this.stopping=!1}remove(e){Le.debug(`remove() [taskIdx:${e}]`);const t=Array.from(this.pendingTasks.values())[e];if(!t){Le.debug(`stop() | no task with given idx [taskIdx:${e}]`);return}t.reject(new sr)}dump(){const e=Date.now();let t=0;return Array.from(this.pendingTasks.values()).map(r=>({idx:t++,task:r.task,name:r.name,enqueuedTime:r.executedAt?r.executedAt-r.enqueuedAt:e-r.enqueuedAt,executionTime:r.executedAt?e-r.executedAt:0}))}async execute(e){if(Le.debug(`execute() [name:${e.name}]`),e.executedAt)throw new Error("task already being executed");e.executedAt=Date.now();try{const t=await e.task();e.resolve(t)}catch(t){e.reject(t)}}}Oe.AwaitQueue=Zn;/*! queue-microtask. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */let Ds;var Jn=typeof queueMicrotask=="function"?queueMicrotask.bind(typeof window<"u"?window:_):s=>(Ds||(Ds=Promise.resolve())).then(s).catch(e=>setTimeout(()=>{throw e},0)),St={};Object.defineProperty(St,"__esModule",{value:!0});St.Producer=void 0;const Yn=K,Ts=be,Qe=X,le=new Yn.Logger("Producer");class Xn extends Ts.EnhancedEventEmitter{constructor({id:e,localId:t,rtpSender:r,track:i,rtpParameters:n,stopTracks:o,disableTrackOnPause:d,zeroRtpOnPause:u,appData:p}){super(),this._closed=!1,this._observer=new Ts.EnhancedEventEmitter,le.debug("constructor()"),this._id=e,this._localId=t,this._rtpSender=r,this._track=i,this._kind=i.kind,this._rtpParameters=n,this._paused=d?!i.enabled:!1,this._maxSpatialLayer=void 0,this._stopTracks=o,this._disableTrackOnPause=d,this._zeroRtpOnPause=u,this._appData=p||{},this.onTrackEnded=this.onTrackEnded.bind(this),this.handleTrack()}get id(){return this._id}get localId(){return this._localId}get closed(){return this._closed}get kind(){return this._kind}get rtpSender(){return this._rtpSender}get track(){return this._track}get rtpParameters(){return this._rtpParameters}get paused(){return this._paused}get maxSpatialLayer(){return this._maxSpatialLayer}get appData(){return this._appData}set appData(e){this._appData=e}get observer(){return this._observer}close(){this._closed||(le.debug("close()"),this._closed=!0,this.destroyTrack(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(le.debug("transportClosed()"),this._closed=!0,this.destroyTrack(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}async getStats(){if(this._closed)throw new Qe.InvalidStateError("closed");return new Promise((e,t)=>{this.safeEmit("@getstats",e,t)})}pause(){if(le.debug("pause()"),this._closed){le.error("pause() | Producer closed");return}this._paused=!0,this._track&&this._disableTrackOnPause&&(this._track.enabled=!1),this._zeroRtpOnPause&&new Promise((e,t)=>{this.safeEmit("@pause",e,t)}).catch(()=>{}),this._observer.safeEmit("pause")}resume(){if(le.debug("resume()"),this._closed){le.error("resume() | Producer closed");return}this._paused=!1,this._track&&this._disableTrackOnPause&&(this._track.enabled=!0),this._zeroRtpOnPause&&new Promise((e,t)=>{this.safeEmit("@resume",e,t)}).catch(()=>{}),this._observer.safeEmit("resume")}async replaceTrack({track:e}){if(le.debug("replaceTrack() [track:%o]",e),this._closed){if(e&&this._stopTracks)try{e.stop()}catch{}throw new Qe.InvalidStateError("closed")}else if(e&&e.readyState==="ended")throw new Qe.InvalidStateError("track ended");if(e===this._track){le.debug("replaceTrack() | same track, ignored");return}await new Promise((t,r)=>{this.safeEmit("@replacetrack",e,t,r)}),this.destroyTrack(),this._track=e,this._track&&this._disableTrackOnPause&&(this._paused?this._paused&&(this._track.enabled=!1):this._track.enabled=!0),this.handleTrack()}async setMaxSpatialLayer(e){if(this._closed)throw new Qe.InvalidStateError("closed");if(this._kind!=="video")throw new Qe.UnsupportedError("not a video Producer");if(typeof e!="number")throw new TypeError("invalid spatialLayer");e!==this._maxSpatialLayer&&(await new Promise((t,r)=>{this.safeEmit("@setmaxspatiallayer",e,t,r)}).catch(()=>{}),this._maxSpatialLayer=e)}async setRtpEncodingParameters(e){if(this._closed)throw new Qe.InvalidStateError("closed");if(typeof e!="object")throw new TypeError("invalid params");await new Promise((t,r)=>{this.safeEmit("@setrtpencodingparameters",e,t,r)})}onTrackEnded(){le.debug('track "ended" event'),this.safeEmit("trackended"),this._observer.safeEmit("trackended")}handleTrack(){this._track&&this._track.addEventListener("ended",this.onTrackEnded)}destroyTrack(){if(this._track)try{this._track.removeEventListener("ended",this.onTrackEnded),this._stopTracks&&this._track.stop()}catch{}}}St.Producer=Xn;var yt={};Object.defineProperty(yt,"__esModule",{value:!0});yt.Consumer=void 0;const ea=K,Ps=be,ta=X,ue=new ea.Logger("Consumer");class ra extends Ps.EnhancedEventEmitter{constructor({id:e,localId:t,producerId:r,rtpReceiver:i,track:n,rtpParameters:o,appData:d}){super(),this._closed=!1,this._observer=new Ps.EnhancedEventEmitter,ue.debug("constructor()"),this._id=e,this._localId=t,this._producerId=r,this._rtpReceiver=i,this._track=n,this._rtpParameters=o,this._paused=!n.enabled,this._appData=d||{},this.onTrackEnded=this.onTrackEnded.bind(this),this.handleTrack()}get id(){return this._id}get localId(){return this._localId}get producerId(){return this._producerId}get closed(){return this._closed}get kind(){return this._track.kind}get rtpReceiver(){return this._rtpReceiver}get track(){return this._track}get rtpParameters(){return this._rtpParameters}get paused(){return this._paused}get appData(){return this._appData}set appData(e){this._appData=e}get observer(){return this._observer}close(){this._closed||(ue.debug("close()"),this._closed=!0,this.destroyTrack(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(ue.debug("transportClosed()"),this._closed=!0,this.destroyTrack(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}async getStats(){if(this._closed)throw new ta.InvalidStateError("closed");return new Promise((e,t)=>{this.safeEmit("@getstats",e,t)})}pause(){if(ue.debug("pause()"),this._closed){ue.error("pause() | Consumer closed");return}if(this._paused){ue.debug("pause() | Consumer is already paused");return}this._paused=!0,this._track.enabled=!1,this.emit("@pause"),this._observer.safeEmit("pause")}resume(){if(ue.debug("resume()"),this._closed){ue.error("resume() | Consumer closed");return}if(!this._paused){ue.debug("resume() | Consumer is already resumed");return}this._paused=!1,this._track.enabled=!0,this.emit("@resume"),this._observer.safeEmit("resume")}onTrackEnded(){ue.debug('track "ended" event'),this.safeEmit("trackended"),this._observer.safeEmit("trackended")}handleTrack(){this._track.addEventListener("ended",this.onTrackEnded)}destroyTrack(){try{this._track.removeEventListener("ended",this.onTrackEnded),this._track.stop()}catch{}}}yt.Consumer=ra;var Rt={};Object.defineProperty(Rt,"__esModule",{value:!0});Rt.DataProducer=void 0;const sa=K,Es=be,ia=X,De=new sa.Logger("DataProducer");class na extends Es.EnhancedEventEmitter{constructor({id:e,dataChannel:t,sctpStreamParameters:r,appData:i}){super(),this._closed=!1,this._observer=new Es.EnhancedEventEmitter,De.debug("constructor()"),this._id=e,this._dataChannel=t,this._sctpStreamParameters=r,this._appData=i||{},this.handleDataChannel()}get id(){return this._id}get closed(){return this._closed}get sctpStreamParameters(){return this._sctpStreamParameters}get readyState(){return this._dataChannel.readyState}get label(){return this._dataChannel.label}get protocol(){return this._dataChannel.protocol}get bufferedAmount(){return this._dataChannel.bufferedAmount}get bufferedAmountLowThreshold(){return this._dataChannel.bufferedAmountLowThreshold}set bufferedAmountLowThreshold(e){this._dataChannel.bufferedAmountLowThreshold=e}get appData(){return this._appData}set appData(e){this._appData=e}get observer(){return this._observer}close(){this._closed||(De.debug("close()"),this._closed=!0,this._dataChannel.close(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||(De.debug("transportClosed()"),this._closed=!0,this._dataChannel.close(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}send(e){if(De.debug("send()"),this._closed)throw new ia.InvalidStateError("closed");this._dataChannel.send(e)}handleDataChannel(){this._dataChannel.addEventListener("open",()=>{this._closed||(De.debug('DataChannel "open" event'),this.safeEmit("open"))}),this._dataChannel.addEventListener("error",e=>{if(this._closed)return;let{error:t}=e;t||(t=new Error("unknown DataChannel error")),t.errorDetail==="sctp-failure"?De.error("DataChannel SCTP error [sctpCauseCode:%s]: %s",t.sctpCauseCode,t.message):De.error('DataChannel "error" event: %o',t),this.safeEmit("error",t)}),this._dataChannel.addEventListener("close",()=>{this._closed||(De.warn('DataChannel "close" event'),this._closed=!0,this.emit("@close"),this.safeEmit("close"),this._observer.safeEmit("close"))}),this._dataChannel.addEventListener("message",()=>{this._closed||De.warn('DataChannel "message" event in a DataProducer, message discarded')}),this._dataChannel.addEventListener("bufferedamountlow",()=>{this._closed||this.safeEmit("bufferedamountlow")})}}Rt.DataProducer=na;var Ct={};Object.defineProperty(Ct,"__esModule",{value:!0});Ct.DataConsumer=void 0;const aa=K,Ls=be,$e=new aa.Logger("DataConsumer");class oa extends Ls.EnhancedEventEmitter{constructor({id:e,dataProducerId:t,dataChannel:r,sctpStreamParameters:i,appData:n}){super(),this._closed=!1,this._observer=new Ls.EnhancedEventEmitter,$e.debug("constructor()"),this._id=e,this._dataProducerId=t,this._dataChannel=r,this._sctpStreamParameters=i,this._appData=n||{},this.handleDataChannel()}get id(){return this._id}get dataProducerId(){return this._dataProducerId}get closed(){return this._closed}get sctpStreamParameters(){return this._sctpStreamParameters}get readyState(){return this._dataChannel.readyState}get label(){return this._dataChannel.label}get protocol(){return this._dataChannel.protocol}get binaryType(){return this._dataChannel.binaryType}set binaryType(e){this._dataChannel.binaryType=e}get appData(){return this._appData}set appData(e){this._appData=e}get observer(){return this._observer}close(){this._closed||($e.debug("close()"),this._closed=!0,this._dataChannel.close(),this.emit("@close"),this._observer.safeEmit("close"))}transportClosed(){this._closed||($e.debug("transportClosed()"),this._closed=!0,this._dataChannel.close(),this.safeEmit("transportclose"),this._observer.safeEmit("close"))}handleDataChannel(){this._dataChannel.addEventListener("open",()=>{this._closed||($e.debug('DataChannel "open" event'),this.safeEmit("open"))}),this._dataChannel.addEventListener("error",e=>{if(this._closed)return;let{error:t}=e;t||(t=new Error("unknown DataChannel error")),t.errorDetail==="sctp-failure"?$e.error("DataChannel SCTP error [sctpCauseCode:%s]: %s",t.sctpCauseCode,t.message):$e.error('DataChannel "error" event: %o',t),this.safeEmit("error",t)}),this._dataChannel.addEventListener("close",()=>{this._closed||($e.warn('DataChannel "close" event'),this._closed=!0,this.emit("@close"),this.safeEmit("close"),this._observer.safeEmit("close"))}),this._dataChannel.addEventListener("message",e=>{this._closed||this.safeEmit("message",e.data)})}}Ct.DataConsumer=oa;var ca=_&&_.__createBinding||(Object.create?function(s,e,t,r){r===void 0&&(r=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(s,r,i)}:function(s,e,t,r){r===void 0&&(r=t),s[r]=e[t]}),da=_&&_.__setModuleDefault||(Object.create?function(s,e){Object.defineProperty(s,"default",{enumerable:!0,value:e})}:function(s,e){s.default=e}),Di=_&&_.__importStar||function(s){if(s&&s.__esModule)return s;var e={};if(s!=null)for(var t in s)t!=="default"&&Object.prototype.hasOwnProperty.call(s,t)&&ca(e,s,t);return da(e,s),e},pa=_&&_.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(bt,"__esModule",{value:!0});bt.Transport=void 0;const la=Oe,Dr=pa(Jn),ua=K,xs=be,Z=X,Tr=Di(V),ft=Di(S),ha=St,fa=yt,ma=Rt,ga=Ct,W=new ua.Logger("Transport");class _a{constructor(e){this.consumerOptions=e,this.promise=new Promise((t,r)=>{this.resolve=t,this.reject=r})}}class wa extends xs.EnhancedEventEmitter{constructor({direction:e,id:t,iceParameters:r,iceCandidates:i,dtlsParameters:n,sctpParameters:o,iceServers:d,iceTransportPolicy:u,additionalSettings:p,proprietaryConstraints:a,appData:c,handlerFactory:l,extendedRtpCapabilities:h,canProduceByKind:m}){super(),this._closed=!1,this._iceGatheringState="new",this._connectionState="new",this._producers=new Map,this._consumers=new Map,this._dataProducers=new Map,this._dataConsumers=new Map,this._probatorConsumerCreated=!1,this._awaitQueue=new la.AwaitQueue,this._pendingConsumerTasks=[],this._consumerCreationInProgress=!1,this._pendingPauseConsumers=new Map,this._consumerPauseInProgress=!1,this._pendingResumeConsumers=new Map,this._consumerResumeInProgress=!1,this._pendingCloseConsumers=new Map,this._consumerCloseInProgress=!1,this._observer=new xs.EnhancedEventEmitter,W.debug("constructor() [id:%s, direction:%s]",t,e),this._id=t,this._direction=e,this._extendedRtpCapabilities=h,this._canProduceByKind=m,this._maxSctpMessageSize=o?o.maxMessageSize:null,p=Tr.clone(p)||{},delete p.iceServers,delete p.iceTransportPolicy,delete p.bundlePolicy,delete p.rtcpMuxPolicy,delete p.sdpSemantics,this._handler=l(),this._handler.run({direction:e,iceParameters:r,iceCandidates:i,dtlsParameters:n,sctpParameters:o,iceServers:d,iceTransportPolicy:u,additionalSettings:p,proprietaryConstraints:a,extendedRtpCapabilities:h}),this._appData=c||{},this.handleHandler()}get id(){return this._id}get closed(){return this._closed}get direction(){return this._direction}get handler(){return this._handler}get iceGatheringState(){return this._iceGatheringState}get connectionState(){return this._connectionState}get appData(){return this._appData}set appData(e){this._appData=e}get observer(){return this._observer}close(){if(!this._closed){W.debug("close()"),this._closed=!0,this._awaitQueue.stop(),this._handler.close(),this._connectionState="closed";for(const e of this._producers.values())e.transportClosed();this._producers.clear();for(const e of this._consumers.values())e.transportClosed();this._consumers.clear();for(const e of this._dataProducers.values())e.transportClosed();this._dataProducers.clear();for(const e of this._dataConsumers.values())e.transportClosed();this._dataConsumers.clear(),this._observer.safeEmit("close")}}async getStats(){if(this._closed)throw new Z.InvalidStateError("closed");return this._handler.getTransportStats()}async restartIce({iceParameters:e}){if(W.debug("restartIce()"),this._closed)throw new Z.InvalidStateError("closed");if(!e)throw new TypeError("missing iceParameters");return this._awaitQueue.push(async()=>await this._handler.restartIce(e),"transport.restartIce()")}async updateIceServers({iceServers:e}={}){if(W.debug("updateIceServers()"),this._closed)throw new Z.InvalidStateError("closed");if(!Array.isArray(e))throw new TypeError("missing iceServers");return this._awaitQueue.push(async()=>this._handler.updateIceServers(e),"transport.updateIceServers()")}async produce({track:e,encodings:t,codecOptions:r,codec:i,stopTracks:n=!0,disableTrackOnPause:o=!0,zeroRtpOnPause:d=!1,appData:u={}}={}){if(W.debug("produce() [track:%o]",e),this._closed)throw new Z.InvalidStateError("closed");if(e){if(this._direction!=="send")throw new Z.UnsupportedError("not a sending Transport");if(this._canProduceByKind[e.kind]){if(e.readyState==="ended")throw new Z.InvalidStateError("track ended");if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(this.listenerCount("produce")===0)throw new TypeError('no "produce" listener set into this transport');if(u&&typeof u!="object")throw new TypeError("if given, appData must be an object")}else throw new Z.UnsupportedError(`cannot produce ${e.kind}`)}else throw new TypeError("missing track");return this._awaitQueue.push(async()=>{let p;if(t&&!Array.isArray(t))throw TypeError("encodings must be an array");t&&t.length===0?p=void 0:t&&(p=t.map(h=>{const m={active:!0};return h.active===!1&&(m.active=!1),typeof h.dtx=="boolean"&&(m.dtx=h.dtx),typeof h.scalabilityMode=="string"&&(m.scalabilityMode=h.scalabilityMode),typeof h.scaleResolutionDownBy=="number"&&(m.scaleResolutionDownBy=h.scaleResolutionDownBy),typeof h.maxBitrate=="number"&&(m.maxBitrate=h.maxBitrate),typeof h.maxFramerate=="number"&&(m.maxFramerate=h.maxFramerate),typeof h.adaptivePtime=="boolean"&&(m.adaptivePtime=h.adaptivePtime),typeof h.priority=="string"&&(m.priority=h.priority),typeof h.networkPriority=="string"&&(m.networkPriority=h.networkPriority),m}));const{localId:a,rtpParameters:c,rtpSender:l}=await this._handler.send({track:e,encodings:p,codecOptions:r,codec:i});try{ft.validateRtpParameters(c);const{id:h}=await new Promise((g,f)=>{this.safeEmit("produce",{kind:e.kind,rtpParameters:c,appData:u},g,f)}),m=new ha.Producer({id:h,localId:a,rtpSender:l,track:e,rtpParameters:c,stopTracks:n,disableTrackOnPause:o,zeroRtpOnPause:d,appData:u});return this._producers.set(m.id,m),this.handleProducer(m),this._observer.safeEmit("newproducer",m),m}catch(h){throw this._handler.stopSending(a).catch(()=>{}),h}},"transport.produce()").catch(p=>{if(n)try{e.stop()}catch{}throw p})}async consume({id:e,producerId:t,kind:r,rtpParameters:i,streamId:n,appData:o={}}){if(W.debug("consume()"),i=Tr.clone(i),this._closed)throw new Z.InvalidStateError("closed");if(this._direction!=="recv")throw new Z.UnsupportedError("not a receiving Transport");if(typeof e!="string")throw new TypeError("missing id");if(typeof t!="string")throw new TypeError("missing producerId");if(r!=="audio"&&r!=="video")throw new TypeError(`invalid kind '${r}'`);if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(o&&typeof o!="object")throw new TypeError("if given, appData must be an object");if(!ft.canReceive(i,this._extendedRtpCapabilities))throw new Z.UnsupportedError("cannot consume this Producer");const u=new _a({id:e,producerId:t,kind:r,rtpParameters:i,streamId:n,appData:o});return this._pendingConsumerTasks.push(u),(0,Dr.default)(()=>{this._closed||this._consumerCreationInProgress===!1&&this.createPendingConsumers()}),u.promise}async produceData({ordered:e=!0,maxPacketLifeTime:t,maxRetransmits:r,label:i="",protocol:n="",appData:o={}}={}){if(W.debug("produceData()"),this._closed)throw new Z.InvalidStateError("closed");if(this._direction!=="send")throw new Z.UnsupportedError("not a sending Transport");if(this._maxSctpMessageSize){if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(this.listenerCount("producedata")===0)throw new TypeError('no "producedata" listener set into this transport');if(o&&typeof o!="object")throw new TypeError("if given, appData must be an object")}else throw new Z.UnsupportedError("SCTP not enabled by remote Transport");return(t||r)&&(e=!1),this._awaitQueue.push(async()=>{const{dataChannel:d,sctpStreamParameters:u}=await this._handler.sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:r,label:i,protocol:n});ft.validateSctpStreamParameters(u);const{id:p}=await new Promise((c,l)=>{this.safeEmit("producedata",{sctpStreamParameters:u,label:i,protocol:n,appData:o},c,l)}),a=new ma.DataProducer({id:p,dataChannel:d,sctpStreamParameters:u,appData:o});return this._dataProducers.set(a.id,a),this.handleDataProducer(a),this._observer.safeEmit("newdataproducer",a),a},"transport.produceData()")}async consumeData({id:e,dataProducerId:t,sctpStreamParameters:r,label:i="",protocol:n="",appData:o={}}){if(W.debug("consumeData()"),r=Tr.clone(r),this._closed)throw new Z.InvalidStateError("closed");if(this._direction!=="recv")throw new Z.UnsupportedError("not a receiving Transport");if(this._maxSctpMessageSize){if(typeof e!="string")throw new TypeError("missing id");if(typeof t!="string")throw new TypeError("missing dataProducerId");if(this.listenerCount("connect")===0&&this._connectionState==="new")throw new TypeError('no "connect" listener set into this transport');if(o&&typeof o!="object")throw new TypeError("if given, appData must be an object")}else throw new Z.UnsupportedError("SCTP not enabled by remote Transport");return ft.validateSctpStreamParameters(r),this._awaitQueue.push(async()=>{const{dataChannel:d}=await this._handler.receiveDataChannel({sctpStreamParameters:r,label:i,protocol:n}),u=new ga.DataConsumer({id:e,dataProducerId:t,dataChannel:d,sctpStreamParameters:r,appData:o});return this._dataConsumers.set(u.id,u),this.handleDataConsumer(u),this._observer.safeEmit("newdataconsumer",u),u},"transport.consumeData()")}async createPendingConsumers(){this._consumerCreationInProgress=!0,this._awaitQueue.push(async()=>{if(this._pendingConsumerTasks.length===0){W.debug("createPendingConsumers() | there is no Consumer to be created");return}const e=[...this._pendingConsumerTasks];this._pendingConsumerTasks=[];let t;const r=[];for(const i of e){const{id:n,kind:o,rtpParameters:d,streamId:u}=i.consumerOptions;r.push({trackId:n,kind:o,rtpParameters:d,streamId:u})}try{const i=await this._handler.receive(r);for(let n=0;n<i.length;++n){const o=e[n],d=i[n],{id:u,producerId:p,kind:a,rtpParameters:c,appData:l}=o.consumerOptions,{localId:h,rtpReceiver:m,track:g}=d,f=new fa.Consumer({id:u,localId:h,producerId:p,rtpReceiver:m,track:g,rtpParameters:c,appData:l});this._consumers.set(f.id,f),this.handleConsumer(f),!this._probatorConsumerCreated&&!t&&a==="video"&&(t=f),this._observer.safeEmit("newconsumer",f),o.resolve(f)}}catch(i){for(const n of e)n.reject(i)}if(t)try{const i=ft.generateProbatorRtpParameters(t.rtpParameters);await this._handler.receive([{trackId:"probator",kind:"video",rtpParameters:i}]),W.debug("createPendingConsumers() | Consumer for RTP probation created"),this._probatorConsumerCreated=!0}catch(i){W.error("createPendingConsumers() | failed to create Consumer for RTP probation:%o",i)}},"transport.createPendingConsumers()").then(()=>{this._consumerCreationInProgress=!1,this._pendingConsumerTasks.length>0&&this.createPendingConsumers()}).catch(()=>{})}pausePendingConsumers(){this._consumerPauseInProgress=!0,this._awaitQueue.push(async()=>{if(this._pendingPauseConsumers.size===0){W.debug("pausePendingConsumers() | there is no Consumer to be paused");return}const e=Array.from(this._pendingPauseConsumers.values());this._pendingPauseConsumers.clear();try{const t=e.map(r=>r.localId);await this._handler.pauseReceiving(t)}catch(t){W.error("pausePendingConsumers() | failed to pause Consumers:",t)}},"transport.pausePendingConsumers").then(()=>{this._consumerPauseInProgress=!1,this._pendingPauseConsumers.size>0&&this.pausePendingConsumers()}).catch(()=>{})}resumePendingConsumers(){this._consumerResumeInProgress=!0,this._awaitQueue.push(async()=>{if(this._pendingResumeConsumers.size===0){W.debug("resumePendingConsumers() | there is no Consumer to be resumed");return}const e=Array.from(this._pendingResumeConsumers.values());this._pendingResumeConsumers.clear();try{const t=e.map(r=>r.localId);await this._handler.resumeReceiving(t)}catch(t){W.error("resumePendingConsumers() | failed to resume Consumers:",t)}},"transport.resumePendingConsumers").then(()=>{this._consumerResumeInProgress=!1,this._pendingResumeConsumers.size>0&&this.resumePendingConsumers()}).catch(()=>{})}closePendingConsumers(){this._consumerCloseInProgress=!0,this._awaitQueue.push(async()=>{if(this._pendingCloseConsumers.size===0){W.debug("closePendingConsumers() | there is no Consumer to be closed");return}const e=Array.from(this._pendingCloseConsumers.values());this._pendingCloseConsumers.clear();try{await this._handler.stopReceiving(e.map(t=>t.localId))}catch(t){W.error("closePendingConsumers() | failed to close Consumers:",t)}},"transport.closePendingConsumers").then(()=>{this._consumerCloseInProgress=!1,this._pendingCloseConsumers.size>0&&this.closePendingConsumers()}).catch(()=>{})}handleHandler(){const e=this._handler;e.on("@connect",({dtlsParameters:t},r,i)=>{if(this._closed){i(new Z.InvalidStateError("closed"));return}this.safeEmit("connect",{dtlsParameters:t},r,i)}),e.on("@icegatheringstatechange",t=>{t!==this._iceGatheringState&&(W.debug("ICE gathering state changed to %s",t),this._iceGatheringState=t,this._closed||this.safeEmit("icegatheringstatechange",t))}),e.on("@connectionstatechange",t=>{t!==this._connectionState&&(W.debug("connection state changed to %s",t),this._connectionState=t,this._closed||this.safeEmit("connectionstatechange",t))})}handleProducer(e){e.on("@close",()=>{this._producers.delete(e.id),!this._closed&&this._awaitQueue.push(async()=>await this._handler.stopSending(e.localId),"producer @close event").catch(t=>W.warn("producer.close() failed:%o",t))}),e.on("@pause",(t,r)=>{this._awaitQueue.push(async()=>await this._handler.pauseSending(e.localId),"producer @pause event").then(t).catch(r)}),e.on("@resume",(t,r)=>{this._awaitQueue.push(async()=>await this._handler.resumeSending(e.localId),"producer @resume event").then(t).catch(r)}),e.on("@replacetrack",(t,r,i)=>{this._awaitQueue.push(async()=>await this._handler.replaceTrack(e.localId,t),"producer @replacetrack event").then(r).catch(i)}),e.on("@setmaxspatiallayer",(t,r,i)=>{this._awaitQueue.push(async()=>await this._handler.setMaxSpatialLayer(e.localId,t),"producer @setmaxspatiallayer event").then(r).catch(i)}),e.on("@setrtpencodingparameters",(t,r,i)=>{this._awaitQueue.push(async()=>await this._handler.setRtpEncodingParameters(e.localId,t),"producer @setrtpencodingparameters event").then(r).catch(i)}),e.on("@getstats",(t,r)=>{if(this._closed)return r(new Z.InvalidStateError("closed"));this._handler.getSenderStats(e.localId).then(t).catch(r)})}handleConsumer(e){e.on("@close",()=>{this._consumers.delete(e.id),this._pendingPauseConsumers.delete(e.id),this._pendingResumeConsumers.delete(e.id),!this._closed&&(this._pendingCloseConsumers.set(e.id,e),this._consumerCloseInProgress===!1&&this.closePendingConsumers())}),e.on("@pause",()=>{this._pendingResumeConsumers.has(e.id)&&this._pendingResumeConsumers.delete(e.id),this._pendingPauseConsumers.set(e.id,e),(0,Dr.default)(()=>{this._closed||this._consumerPauseInProgress===!1&&this.pausePendingConsumers()})}),e.on("@resume",()=>{this._pendingPauseConsumers.has(e.id)&&this._pendingPauseConsumers.delete(e.id),this._pendingResumeConsumers.set(e.id,e),(0,Dr.default)(()=>{this._closed||this._consumerResumeInProgress===!1&&this.resumePendingConsumers()})}),e.on("@getstats",(t,r)=>{if(this._closed)return r(new Z.InvalidStateError("closed"));this._handler.getReceiverStats(e.localId).then(t).catch(r)})}handleDataProducer(e){e.on("@close",()=>{this._dataProducers.delete(e.id)})}handleDataConsumer(e){e.on("@close",()=>{this._dataConsumers.delete(e.id)})}}bt.Transport=wa;var ir={},Q={},Ti={},Pi={exports:{}},Ms=Pi.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(s){return s.encoding?"rtpmap:%d %s/%s/%s":s.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(s){return s.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(s){return s.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(s){return"extmap:%d"+(s.direction?"/%s":"%v")+(s["encrypt-uri"]?" %s":"%v")+" %s"+(s.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(s){return s.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(s){var e="candidate:%s %d %s %d %s %d typ %s";return e+=s.raddr!=null?" raddr %s rport %d":"%v%v",e+=s.tcptype!=null?" tcptype %s":"%v",s.generation!=null&&(e+=" generation %d"),e+=s["network-id"]!=null?" network-id %d":"%v",e+=s["network-cost"]!=null?" network-cost %d":"%v",e}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(s){var e="ssrc:%d";return s.attribute!=null&&(e+=" %s",s.value!=null&&(e+=":%s")),e}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(s){return s.maxMessageSize!=null?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(s){return s.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(s){return"imageattr:%s %s %s"+(s.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(s){return"simulcast:%s %s"+(s.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(s){return"ts-refclk:%s"+(s.clksrcExt!=null?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(s){var e="mediaclk:";return e+=s.id!=null?"id=%s %s":"%v%s",e+=s.mediaClockValue!=null?"=%s":"",e+=s.rateNumerator!=null?" rate=%s":"",e+=s.rateDenominator!=null?"/%s":"",e}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(Ms).forEach(function(s){var e=Ms[s];e.forEach(function(t){t.reg||(t.reg=/(.*)/),t.format||(t.format="%s")})});var Ei=Pi.exports;(function(s){var e=function(d){return String(Number(d))===d?Number(d):d},t=function(d,u,p,a){if(a&&!p)u[a]=e(d[1]);else for(var c=0;c<p.length;c+=1)d[c+1]!=null&&(u[p[c]]=e(d[c+1]))},r=function(d,u,p){var a=d.name&&d.names;d.push&&!u[d.push]?u[d.push]=[]:a&&!u[d.name]&&(u[d.name]={});var c=d.push?{}:a?u[d.name]:u;t(p.match(d.reg),c,d.names,d.name),d.push&&u[d.push].push(c)},i=Ei,n=RegExp.prototype.test.bind(/^([a-z])=(.*)/);s.parse=function(d){var u={},p=[],a=u;return d.split(/(\r\n|\r|\n)/).filter(n).forEach(function(c){var l=c[0],h=c.slice(2);l==="m"&&(p.push({rtp:[],fmtp:[]}),a=p[p.length-1]);for(var m=0;m<(i[l]||[]).length;m+=1){var g=i[l][m];if(g.reg.test(h))return r(g,a,h)}}),u.media=p,u};var o=function(d,u){var p=u.split(/=(.+)/,2);return p.length===2?d[p[0]]=e(p[1]):p.length===1&&u.length>1&&(d[p[0]]=void 0),d};s.parseParams=function(d){return d.split(/;\s?/).reduce(o,{})},s.parseFmtpConfig=s.parseParams,s.parsePayloads=function(d){return d.toString().split(" ").map(Number)},s.parseRemoteCandidates=function(d){for(var u=[],p=d.split(" ").map(e),a=0;a<p.length;a+=3)u.push({component:p[a],ip:p[a+1],port:p[a+2]});return u},s.parseImageAttributes=function(d){return d.split(" ").map(function(u){return u.substring(1,u.length-1).split(",").reduce(o,{})})},s.parseSimulcastStreamList=function(d){return d.split(";").map(function(u){return u.split(",").map(function(p){var a,c=!1;return p[0]!=="~"?a=e(p):(a=e(p.substring(1,p.length)),c=!0),{scid:a,paused:c}})})}})(Ti);var Pr=Ei,va=/%[sdv%]/g,ba=function(s){var e=1,t=arguments,r=t.length;return s.replace(va,function(i){if(e>=r)return i;var n=t[e];switch(e+=1,i){case"%%":return"%";case"%s":return String(n);case"%d":return Number(n);case"%v":return""}})},mt=function(s,e,t){var r=e.format instanceof Function?e.format(e.push?t:t[e.name]):e.format,i=[s+"="+r];if(e.names)for(var n=0;n<e.names.length;n+=1){var o=e.names[n];e.name?i.push(t[e.name][o]):i.push(t[e.names[n]])}else i.push(t[e.name]);return ba.apply(null,i)},Sa=["v","o","s","i","u","e","p","c","b","t","r","z","a"],ya=["i","c","b","a"],Ra=function(s,e){e=e||{},s.version==null&&(s.version=0),s.name==null&&(s.name=" "),s.media.forEach(function(n){n.payloads==null&&(n.payloads="")});var t=e.outerOrder||Sa,r=e.innerOrder||ya,i=[];return t.forEach(function(n){Pr[n].forEach(function(o){o.name in s&&s[o.name]!=null?i.push(mt(n,o,s)):o.push in s&&s[o.push]!=null&&s[o.push].forEach(function(d){i.push(mt(n,o,d))})})}),s.media.forEach(function(n){i.push(mt("m",Pr.m[0],n)),r.forEach(function(o){Pr[o].forEach(function(d){d.name in n&&n[d.name]!=null?i.push(mt(o,d,n)):d.push in n&&n[d.push]!=null&&n[d.push].forEach(function(u){i.push(mt(o,d,u))})})})}),i.join(`\r
`)+`\r
`},Ae=Ti,Ca=Ra;Q.write=Ca;Q.parse=Ae.parse;Q.parseParams=Ae.parseParams;Q.parseFmtpConfig=Ae.parseFmtpConfig;Q.parsePayloads=Ae.parsePayloads;Q.parseRemoteCandidates=Ae.parseRemoteCandidates;Q.parseImageAttributes=Ae.parseImageAttributes;Q.parseSimulcastStreamList=Ae.parseSimulcastStreamList;var Y={},Da=_&&_.__createBinding||(Object.create?function(s,e,t,r){r===void 0&&(r=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(s,r,i)}:function(s,e,t,r){r===void 0&&(r=t),s[r]=e[t]}),Ta=_&&_.__setModuleDefault||(Object.create?function(s,e){Object.defineProperty(s,"default",{enumerable:!0,value:e})}:function(s,e){s.default=e}),Pa=_&&_.__importStar||function(s){if(s&&s.__esModule)return s;var e={};if(s!=null)for(var t in s)t!=="default"&&Object.prototype.hasOwnProperty.call(s,t)&&Da(e,s,t);return Ta(e,s),e};Object.defineProperty(Y,"__esModule",{value:!0});Y.applyCodecParameters=Y.getCname=Y.extractDtlsParameters=Y.extractRtpCapabilities=void 0;const Li=Pa(Q);function Ea({sdpObject:s}){const e=new Map,t=[];let r=!1,i=!1;for(const o of s.media){const d=o.type;switch(d){case"audio":{if(r)continue;r=!0;break}case"video":{if(i)continue;i=!0;break}default:continue}for(const u of o.rtp){const p={kind:d,mimeType:`${d}/${u.codec}`,preferredPayloadType:u.payload,clockRate:u.rate,channels:u.encoding,parameters:{},rtcpFeedback:[]};e.set(p.preferredPayloadType,p)}for(const u of o.fmtp||[]){const p=Li.parseParams(u.config),a=e.get(u.payload);a&&(p&&p.hasOwnProperty("profile-level-id")&&(p["profile-level-id"]=String(p["profile-level-id"])),a.parameters=p)}for(const u of o.rtcpFb||[]){const p={type:u.type,parameter:u.subtype};if(p.parameter||delete p.parameter,u.payload!=="*"){const a=e.get(u.payload);if(!a)continue;a.rtcpFeedback.push(p)}else for(const a of e.values())a.kind===d&&!/.+\/rtx$/i.test(a.mimeType)&&a.rtcpFeedback.push(p)}for(const u of o.ext||[]){if(u["encrypt-uri"])continue;const p={kind:d,uri:u.uri,preferredId:u.value};t.push(p)}}return{codecs:Array.from(e.values()),headerExtensions:t}}Y.extractRtpCapabilities=Ea;function La({sdpObject:s}){let e=s.setup,t=s.fingerprint;if(!e||!t){const n=(s.media||[]).find(o=>o.port!==0);n&&(e??(e=n.setup),t??(t=n.fingerprint))}if(e){if(!t)throw new Error("no a=fingerprint found at SDP session or media level")}else throw new Error("no a=setup found at SDP session or media level");let r;switch(e){case"active":{r="client";break}case"passive":{r="server";break}case"actpass":{r="auto";break}}return{role:r,fingerprints:[{algorithm:t.type,value:t.hash}]}}Y.extractDtlsParameters=La;function xa({offerMediaObject:s}){const e=(s.ssrcs||[]).find(t=>t.attribute==="cname");return e?e.value:""}Y.getCname=xa;function Ma({offerRtpParameters:s,answerMediaObject:e}){for(const t of s.codecs){const r=t.mimeType.toLowerCase();if(r!=="audio/opus"||!(e.rtp||[]).find(d=>d.payload===t.payloadType))continue;e.fmtp=e.fmtp||[];let n=e.fmtp.find(d=>d.payload===t.payloadType);n||(n={payload:t.payloadType,config:""},e.fmtp.push(n));const o=Li.parseParams(n.config);switch(r){case"audio/opus":{const d=t.parameters["sprop-stereo"];d!==void 0&&(o.stereo=d?1:0);break}}n.config="";for(const d of Object.keys(o))n.config&&(n.config+=";"),n.config+=`${d}=${o[d]}`}}Y.applyCodecParameters=Ma;var oe={};Object.defineProperty(oe,"__esModule",{value:!0});oe.addLegacySimulcast=oe.getRtpEncodings=void 0;function Ia({offerMediaObject:s}){const e=new Set;for(const i of s.ssrcs||[]){const n=i.id;e.add(n)}if(e.size===0)throw new Error("no a=ssrc lines found");const t=new Map;for(const i of s.ssrcGroups||[]){if(i.semantics!=="FID")continue;let[n,o]=i.ssrcs.split(/\s+/);n=Number(n),o=Number(o),e.has(n)&&(e.delete(n),e.delete(o),t.set(n,o))}for(const i of e)t.set(i,null);const r=[];for(const[i,n]of t){const o={ssrc:i};n&&(o.rtx={ssrc:n}),r.push(o)}return r}oe.getRtpEncodings=Ia;function Oa({offerMediaObject:s,numStreams:e}){if(e<=1)throw new TypeError("numStreams must be greater than 1");const t=(s.ssrcs||[]).find(c=>c.attribute==="msid");if(!t)throw new Error("a=ssrc line with msid information not found");const[r,i]=t.value.split(" "),n=t.id;let o;(s.ssrcGroups||[]).some(c=>{if(c.semantics!=="FID")return!1;const l=c.ssrcs.split(/\s+/);return Number(l[0])===n?(o=Number(l[1]),!0):!1});const d=s.ssrcs.find(c=>c.attribute==="cname");if(!d)throw new Error("a=ssrc line with cname information not found");const u=d.value,p=[],a=[];for(let c=0;c<e;++c)p.push(n+c),o&&a.push(o+c);s.ssrcGroups=[],s.ssrcs=[],s.ssrcGroups.push({semantics:"SIM",ssrcs:p.join(" ")});for(let c=0;c<p.length;++c){const l=p[c];s.ssrcs.push({id:l,attribute:"cname",value:u}),s.ssrcs.push({id:l,attribute:"msid",value:`${r} ${i}`})}for(let c=0;c<a.length;++c){const l=p[c],h=a[c];s.ssrcs.push({id:h,attribute:"cname",value:u}),s.ssrcs.push({id:h,attribute:"msid",value:`${r} ${i}`}),s.ssrcGroups.push({semantics:"FID",ssrcs:`${l} ${h}`})}}oe.addLegacySimulcast=Oa;var Be={};Object.defineProperty(Be,"__esModule",{value:!0});Be.addNackSuppportForOpus=void 0;function ka(s){var e;for(const t of s.codecs||[])(t.mimeType.toLowerCase()==="audio/opus"||t.mimeType.toLowerCase()==="audio/multiopus")&&!((e=t.rtcpFeedback)!=null&&e.some(r=>r.type==="nack"&&!r.parameter))&&(t.rtcpFeedback||(t.rtcpFeedback=[]),t.rtcpFeedback.push({type:"nack"}))}Be.addNackSuppportForOpus=ka;var te={};Object.defineProperty(te,"__esModule",{value:!0});te.HandlerInterface=void 0;const ja=be;class Fa extends ja.EnhancedEventEmitter{constructor(){super()}}te.HandlerInterface=Fa;var se={},ke={},$a=_&&_.__createBinding||(Object.create?function(s,e,t,r){r===void 0&&(r=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(s,r,i)}:function(s,e,t,r){r===void 0&&(r=t),s[r]=e[t]}),Na=_&&_.__setModuleDefault||(Object.create?function(s,e){Object.defineProperty(s,"default",{enumerable:!0,value:e})}:function(s,e){s.default=e}),xi=_&&_.__importStar||function(s){if(s&&s.__esModule)return s;var e={};if(s!=null)for(var t in s)t!=="default"&&Object.prototype.hasOwnProperty.call(s,t)&&$a(e,s,t);return Na(e,s),e};Object.defineProperty(ke,"__esModule",{value:!0});ke.OfferMediaSection=ke.AnswerMediaSection=ke.MediaSection=void 0;const Aa=xi(Q),Is=xi(V);class Qr{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:r,planB:i=!1}){if(this._mediaObject={},this._planB=i,e&&this.setIceParameters(e),t){this._mediaObject.candidates=[];for(const n of t){const o={};o.component=1,o.foundation=n.foundation,o.ip=n.ip,o.port=n.port,o.priority=n.priority,o.transport=n.protocol,o.type=n.type,n.tcpType&&(o.tcptype=n.tcpType),this._mediaObject.candidates.push(o)}this._mediaObject.endOfCandidates="end-of-candidates",this._mediaObject.iceOptions="renomination"}r&&this.setDtlsRole(r.role)}get mid(){return String(this._mediaObject.mid)}get closed(){return this._mediaObject.port===0}getObject(){return this._mediaObject}setIceParameters(e){this._mediaObject.iceUfrag=e.usernameFragment,this._mediaObject.icePwd=e.password}pause(){this._mediaObject.direction="inactive"}disable(){this.pause(),delete this._mediaObject.ext,delete this._mediaObject.ssrcs,delete this._mediaObject.ssrcGroups,delete this._mediaObject.simulcast,delete this._mediaObject.simulcast_03,delete this._mediaObject.rids,delete this._mediaObject.extmapAllowMixed}close(){this.disable(),this._mediaObject.port=0}}ke.MediaSection=Qr;class Ba extends Qr{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:r,sctpParameters:i,plainRtpParameters:n,planB:o=!1,offerMediaObject:d,offerRtpParameters:u,answerRtpParameters:p,codecOptions:a,extmapAllowMixed:c=!1}){switch(super({iceParameters:e,iceCandidates:t,dtlsParameters:r,planB:o}),this._mediaObject.mid=String(d.mid),this._mediaObject.type=d.type,this._mediaObject.protocol=d.protocol,n?(this._mediaObject.connection={ip:n.ip,version:n.ipVersion},this._mediaObject.port=n.port):(this._mediaObject.connection={ip:"127.0.0.1",version:4},this._mediaObject.port=7),d.type){case"audio":case"video":{this._mediaObject.direction="recvonly",this._mediaObject.rtp=[],this._mediaObject.rtcpFb=[],this._mediaObject.fmtp=[];for(const l of p.codecs){const h={payload:l.payloadType,codec:Ur(l),rate:l.clockRate};l.channels>1&&(h.encoding=l.channels),this._mediaObject.rtp.push(h);const m=Is.clone(l.parameters)??{};let g=Is.clone(l.rtcpFeedback)??[];if(a){const{opusStereo:w,opusFec:I,opusDtx:v,opusMaxPlaybackRate:b,opusMaxAverageBitrate:G,opusPtime:U,opusNack:ne,videoGoogleStartBitrate:ee,videoGoogleMaxBitrate:re,videoGoogleMinBitrate:Pe}=a,ye=u.codecs.find(ce=>ce.payloadType===l.payloadType);switch(l.mimeType.toLowerCase()){case"audio/opus":case"audio/multiopus":{w!==void 0&&(ye.parameters["sprop-stereo"]=w?1:0,m.stereo=w?1:0),I!==void 0&&(ye.parameters.useinbandfec=I?1:0,m.useinbandfec=I?1:0),v!==void 0&&(ye.parameters.usedtx=v?1:0,m.usedtx=v?1:0),b!==void 0&&(m.maxplaybackrate=b),G!==void 0&&(m.maxaveragebitrate=G),U!==void 0&&(ye.parameters.ptime=U,m.ptime=U),ne||(ye.rtcpFeedback=ye.rtcpFeedback.filter(ce=>ce.type!=="nack"||ce.parameter),g=g.filter(ce=>ce.type!=="nack"||ce.parameter));break}case"video/vp8":case"video/vp9":case"video/h264":case"video/h265":{ee!==void 0&&(m["x-google-start-bitrate"]=ee),re!==void 0&&(m["x-google-max-bitrate"]=re),Pe!==void 0&&(m["x-google-min-bitrate"]=Pe);break}}}const f={payload:l.payloadType,config:""};for(const w of Object.keys(m))f.config&&(f.config+=";"),f.config+=`${w}=${m[w]}`;f.config&&this._mediaObject.fmtp.push(f);for(const w of g)this._mediaObject.rtcpFb.push({payload:l.payloadType,type:w.type,subtype:w.parameter})}this._mediaObject.payloads=p.codecs.map(l=>l.payloadType).join(" "),this._mediaObject.ext=[];for(const l of p.headerExtensions)(d.ext||[]).some(m=>m.uri===l.uri)&&this._mediaObject.ext.push({uri:l.uri,value:l.id});if(c&&d.extmapAllowMixed==="extmap-allow-mixed"&&(this._mediaObject.extmapAllowMixed="extmap-allow-mixed"),d.simulcast){this._mediaObject.simulcast={dir1:"recv",list1:d.simulcast.list1},this._mediaObject.rids=[];for(const l of d.rids||[])l.direction==="send"&&this._mediaObject.rids.push({id:l.id,direction:"recv"})}else if(d.simulcast_03){this._mediaObject.simulcast_03={value:d.simulcast_03.value.replace(/send/g,"recv")},this._mediaObject.rids=[];for(const l of d.rids||[])l.direction==="send"&&this._mediaObject.rids.push({id:l.id,direction:"recv"})}this._mediaObject.rtcpMux="rtcp-mux",this._mediaObject.rtcpRsize="rtcp-rsize",this._planB&&this._mediaObject.type==="video"&&(this._mediaObject.xGoogleFlag="conference");break}case"application":{typeof d.sctpPort=="number"?(this._mediaObject.payloads="webrtc-datachannel",this._mediaObject.sctpPort=i.port,this._mediaObject.maxMessageSize=i.maxMessageSize):d.sctpmap&&(this._mediaObject.payloads=i.port,this._mediaObject.sctpmap={app:"webrtc-datachannel",sctpmapNumber:i.port,maxMessageSize:i.maxMessageSize});break}}}setDtlsRole(e){switch(e){case"client":{this._mediaObject.setup="active";break}case"server":{this._mediaObject.setup="passive";break}case"auto":{this._mediaObject.setup="actpass";break}}}resume(){this._mediaObject.direction="recvonly"}muxSimulcastStreams(e){var n;if(!this._mediaObject.simulcast||!this._mediaObject.simulcast.list1)return;const t={};for(const o of e)o.rid&&(t[o.rid]=o);const r=this._mediaObject.simulcast.list1,i=Aa.parseSimulcastStreamList(r);for(const o of i)for(const d of o)d.paused=!((n=t[d.scid])!=null&&n.active);this._mediaObject.simulcast.list1=i.map(o=>o.map(d=>`${d.paused?"~":""}${d.scid}`).join(",")).join(";")}}ke.AnswerMediaSection=Ba;class Ua extends Qr{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:r,sctpParameters:i,plainRtpParameters:n,planB:o=!1,mid:d,kind:u,offerRtpParameters:p,streamId:a,trackId:c,oldDataChannelSpec:l=!1}){switch(super({iceParameters:e,iceCandidates:t,dtlsParameters:r,planB:o}),this._mediaObject.mid=String(d),this._mediaObject.type=u,n?(this._mediaObject.connection={ip:n.ip,version:n.ipVersion},this._mediaObject.protocol="RTP/AVP",this._mediaObject.port=n.port):(this._mediaObject.connection={ip:"127.0.0.1",version:4},i?this._mediaObject.protocol="UDP/DTLS/SCTP":this._mediaObject.protocol="UDP/TLS/RTP/SAVPF",this._mediaObject.port=7),u){case"audio":case"video":{this._mediaObject.direction="sendonly",this._mediaObject.rtp=[],this._mediaObject.rtcpFb=[],this._mediaObject.fmtp=[],this._planB||(this._mediaObject.msid=`${a||"-"} ${c}`);for(const f of p.codecs){const w={payload:f.payloadType,codec:Ur(f),rate:f.clockRate};f.channels>1&&(w.encoding=f.channels),this._mediaObject.rtp.push(w);const I={payload:f.payloadType,config:""};for(const v of Object.keys(f.parameters))I.config&&(I.config+=";"),I.config+=`${v}=${f.parameters[v]}`;I.config&&this._mediaObject.fmtp.push(I);for(const v of f.rtcpFeedback)this._mediaObject.rtcpFb.push({payload:f.payloadType,type:v.type,subtype:v.parameter})}this._mediaObject.payloads=p.codecs.map(f=>f.payloadType).join(" "),this._mediaObject.ext=[];for(const f of p.headerExtensions)this._mediaObject.ext.push({uri:f.uri,value:f.id});this._mediaObject.rtcpMux="rtcp-mux",this._mediaObject.rtcpRsize="rtcp-rsize";const h=p.encodings[0],m=h.ssrc,g=h.rtx&&h.rtx.ssrc?h.rtx.ssrc:void 0;this._mediaObject.ssrcs=[],this._mediaObject.ssrcGroups=[],p.rtcp.cname&&this._mediaObject.ssrcs.push({id:m,attribute:"cname",value:p.rtcp.cname}),this._planB&&this._mediaObject.ssrcs.push({id:m,attribute:"msid",value:`${a||"-"} ${c}`}),g&&(p.rtcp.cname&&this._mediaObject.ssrcs.push({id:g,attribute:"cname",value:p.rtcp.cname}),this._planB&&this._mediaObject.ssrcs.push({id:g,attribute:"msid",value:`${a||"-"} ${c}`}),this._mediaObject.ssrcGroups.push({semantics:"FID",ssrcs:`${m} ${g}`}));break}case"application":{l?(this._mediaObject.payloads=i.port,this._mediaObject.sctpmap={app:"webrtc-datachannel",sctpmapNumber:i.port,maxMessageSize:i.maxMessageSize}):(this._mediaObject.payloads="webrtc-datachannel",this._mediaObject.sctpPort=i.port,this._mediaObject.maxMessageSize=i.maxMessageSize);break}}}setDtlsRole(e){this._mediaObject.setup="actpass"}resume(){this._mediaObject.direction="sendonly"}planBReceive({offerRtpParameters:e,streamId:t,trackId:r}){const i=e.encodings[0],n=i.ssrc,o=i.rtx&&i.rtx.ssrc?i.rtx.ssrc:void 0,d=this._mediaObject.payloads.split(" ");for(const u of e.codecs){if(d.includes(String(u.payloadType)))continue;const p={payload:u.payloadType,codec:Ur(u),rate:u.clockRate};u.channels>1&&(p.encoding=u.channels),this._mediaObject.rtp.push(p);const a={payload:u.payloadType,config:""};for(const c of Object.keys(u.parameters))a.config&&(a.config+=";"),a.config+=`${c}=${u.parameters[c]}`;a.config&&this._mediaObject.fmtp.push(a);for(const c of u.rtcpFeedback)this._mediaObject.rtcpFb.push({payload:u.payloadType,type:c.type,subtype:c.parameter})}this._mediaObject.payloads+=` ${e.codecs.filter(u=>!this._mediaObject.payloads.includes(u.payloadType)).map(u=>u.payloadType).join(" ")}`,this._mediaObject.payloads=this._mediaObject.payloads.trim(),e.rtcp.cname&&this._mediaObject.ssrcs.push({id:n,attribute:"cname",value:e.rtcp.cname}),this._mediaObject.ssrcs.push({id:n,attribute:"msid",value:`${t||"-"} ${r}`}),o&&(e.rtcp.cname&&this._mediaObject.ssrcs.push({id:o,attribute:"cname",value:e.rtcp.cname}),this._mediaObject.ssrcs.push({id:o,attribute:"msid",value:`${t||"-"} ${r}`}),this._mediaObject.ssrcGroups.push({semantics:"FID",ssrcs:`${n} ${o}`}))}planBStopReceiving({offerRtpParameters:e}){const t=e.encodings[0],r=t.ssrc,i=t.rtx&&t.rtx.ssrc?t.rtx.ssrc:void 0;this._mediaObject.ssrcs=this._mediaObject.ssrcs.filter(n=>n.id!==r&&n.id!==i),i&&(this._mediaObject.ssrcGroups=this._mediaObject.ssrcGroups.filter(n=>n.ssrcs!==`${r} ${i}`))}}ke.OfferMediaSection=Ua;function Ur(s){const t=new RegExp("^(audio|video)/(.+)","i").exec(s.mimeType);if(!t)throw new TypeError("invalid codec.mimeType");return t[2]}var za=_&&_.__createBinding||(Object.create?function(s,e,t,r){r===void 0&&(r=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(s,r,i)}:function(s,e,t,r){r===void 0&&(r=t),s[r]=e[t]}),Ha=_&&_.__setModuleDefault||(Object.create?function(s,e){Object.defineProperty(s,"default",{enumerable:!0,value:e})}:function(s,e){s.default=e}),Ga=_&&_.__importStar||function(s){if(s&&s.__esModule)return s;var e={};if(s!=null)for(var t in s)t!=="default"&&Object.prototype.hasOwnProperty.call(s,t)&&za(e,s,t);return Ha(e,s),e};Object.defineProperty(se,"__esModule",{value:!0});se.RemoteSdp=void 0;const qa=Ga(Q),Ka=K,At=ke,Er=new Ka.Logger("RemoteSdp");class Va{constructor({iceParameters:e,iceCandidates:t,dtlsParameters:r,sctpParameters:i,plainRtpParameters:n,planB:o=!1}){if(this._mediaSections=[],this._midToIndex=new Map,this._iceParameters=e,this._iceCandidates=t,this._dtlsParameters=r,this._sctpParameters=i,this._plainRtpParameters=n,this._planB=o,this._sdpObject={version:0,origin:{address:"0.0.0.0",ipVer:4,netType:"IN",sessionId:1e4,sessionVersion:0,username:"mediasoup-client"},name:"-",timing:{start:0,stop:0},media:[]},e&&e.iceLite&&(this._sdpObject.icelite="ice-lite"),r){this._sdpObject.msidSemantic={semantic:"WMS",token:"*"};const d=this._dtlsParameters.fingerprints.length;this._sdpObject.fingerprint={type:r.fingerprints[d-1].algorithm,hash:r.fingerprints[d-1].value},this._sdpObject.groups=[{type:"BUNDLE",mids:""}]}n&&(this._sdpObject.origin.address=n.ip,this._sdpObject.origin.ipVer=n.ipVersion)}updateIceParameters(e){Er.debug("updateIceParameters() [iceParameters:%o]",e),this._iceParameters=e,this._sdpObject.icelite=e.iceLite?"ice-lite":void 0;for(const t of this._mediaSections)t.setIceParameters(e)}updateDtlsRole(e){Er.debug("updateDtlsRole() [role:%s]",e),this._dtlsParameters.role=e;for(const t of this._mediaSections)t.setDtlsRole(e)}getNextMediaSectionIdx(){for(let e=0;e<this._mediaSections.length;++e){const t=this._mediaSections[e];if(t.closed)return{idx:e,reuseMid:t.mid}}return{idx:this._mediaSections.length}}send({offerMediaObject:e,reuseMid:t,offerRtpParameters:r,answerRtpParameters:i,codecOptions:n,extmapAllowMixed:o=!1}){const d=new At.AnswerMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,planB:this._planB,offerMediaObject:e,offerRtpParameters:r,answerRtpParameters:i,codecOptions:n,extmapAllowMixed:o});t?this._replaceMediaSection(d,t):this._midToIndex.has(d.mid)?this._replaceMediaSection(d):this._addMediaSection(d)}receive({mid:e,kind:t,offerRtpParameters:r,streamId:i,trackId:n}){const o=this._midToIndex.get(e);let d;if(o!==void 0&&(d=this._mediaSections[o]),d)d.planBReceive({offerRtpParameters:r,streamId:i,trackId:n}),this._replaceMediaSection(d);else{d=new At.OfferMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,plainRtpParameters:this._plainRtpParameters,planB:this._planB,mid:e,kind:t,offerRtpParameters:r,streamId:i,trackId:n});const u=this._mediaSections.find(p=>p.closed);u?this._replaceMediaSection(d,u.mid):this._addMediaSection(d)}}pauseMediaSection(e){this._findMediaSection(e).pause()}resumeSendingMediaSection(e){this._findMediaSection(e).resume()}resumeReceivingMediaSection(e){this._findMediaSection(e).resume()}disableMediaSection(e){this._findMediaSection(e).disable()}closeMediaSection(e){const t=this._findMediaSection(e);return e===this._firstMid?(Er.debug("closeMediaSection() | cannot close first media section, disabling it instead [mid:%s]",e),this.disableMediaSection(e),!1):(t.close(),this._regenerateBundleMids(),!0)}muxMediaSectionSimulcast(e,t){const r=this._findMediaSection(e);r.muxSimulcastStreams(t),this._replaceMediaSection(r)}planBStopReceiving({mid:e,offerRtpParameters:t}){const r=this._findMediaSection(e);r.planBStopReceiving({offerRtpParameters:t}),this._replaceMediaSection(r)}sendSctpAssociation({offerMediaObject:e}){const t=new At.AnswerMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,sctpParameters:this._sctpParameters,plainRtpParameters:this._plainRtpParameters,offerMediaObject:e});this._addMediaSection(t)}receiveSctpAssociation({oldDataChannelSpec:e=!1}={}){const t=new At.OfferMediaSection({iceParameters:this._iceParameters,iceCandidates:this._iceCandidates,dtlsParameters:this._dtlsParameters,sctpParameters:this._sctpParameters,plainRtpParameters:this._plainRtpParameters,mid:"datachannel",kind:"application",oldDataChannelSpec:e});this._addMediaSection(t)}getSdp(){return this._sdpObject.origin.sessionVersion++,qa.write(this._sdpObject)}_addMediaSection(e){this._firstMid||(this._firstMid=e.mid),this._mediaSections.push(e),this._midToIndex.set(e.mid,this._mediaSections.length-1),this._sdpObject.media.push(e.getObject()),this._regenerateBundleMids()}_replaceMediaSection(e,t){if(typeof t=="string"){const r=this._midToIndex.get(t);if(r===void 0)throw new Error(`no media section found for reuseMid '${t}'`);const i=this._mediaSections[r];this._mediaSections[r]=e,this._midToIndex.delete(i.mid),this._midToIndex.set(e.mid,r),this._sdpObject.media[r]=e.getObject(),this._regenerateBundleMids()}else{const r=this._midToIndex.get(e.mid);if(r===void 0)throw new Error(`no media section found with mid '${e.mid}'`);this._mediaSections[r]=e,this._sdpObject.media[r]=e.getObject()}}_findMediaSection(e){const t=this._midToIndex.get(e);if(t===void 0)throw new Error(`no media section found with mid '${e}'`);return this._mediaSections[t]}_regenerateBundleMids(){this._dtlsParameters&&(this._sdpObject.groups[0].mids=this._mediaSections.filter(e=>!e.closed).map(e=>e.mid).join(" "))}}se.RemoteSdp=Va;var Se={};Object.defineProperty(Se,"__esModule",{value:!0});Se.parse=void 0;const Qa=new RegExp("^[LS]([1-9]\\d{0,1})T([1-9]\\d{0,1})");function Wa(s){const e=Qa.exec(s||"");return e?{spatialLayers:Number(e[1]),temporalLayers:Number(e[2])}:{spatialLayers:1,temporalLayers:1}}Se.parse=Wa;var Za=_&&_.__createBinding||(Object.create?function(s,e,t,r){r===void 0&&(r=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(s,r,i)}:function(s,e,t,r){r===void 0&&(r=t),s[r]=e[t]}),Ja=_&&_.__setModuleDefault||(Object.create?function(s,e){Object.defineProperty(s,"default",{enumerable:!0,value:e})}:function(s,e){s.default=e}),ct=_&&_.__importStar||function(s){if(s&&s.__esModule)return s;var e={};if(s!=null)for(var t in s)t!=="default"&&Object.prototype.hasOwnProperty.call(s,t)&&Za(e,s,t);return Ja(e,s),e};Object.defineProperty(ir,"__esModule",{value:!0});ir.Chrome111=void 0;const xe=ct(Q),Ya=K,Os=ct(V),We=ct(S),Bt=ct(Y),ks=ct(oe),Xa=ct(Be),eo=X,to=te,ro=se,so=Se,D=new Ya.Logger("Chrome111"),js={OS:1024,MIS:1024};class Wr extends to.HandlerInterface{static createFactory(){return()=>new Wr}constructor(){super(),this._closed=!1,this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return"Chrome111"}close(){if(D.debug("close()"),!this._closed){if(this._closed=!0,this._pc)try{this._pc.close()}catch{}this.emit("@close")}}async getNativeRtpCapabilities(){D.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();try{e.close()}catch{}const r=xe.parse(t.sdp),i=Bt.extractRtpCapabilities({sdpObject:r});return Xa.addNackSuppportForOpus(i),i}catch(t){try{e.close()}catch{}throw t}}async getNativeSctpCapabilities(){return D.debug("getNativeSctpCapabilities()"),{numStreams:js}}run({direction:e,iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n,iceServers:o,iceTransportPolicy:d,additionalSettings:u,proprietaryConstraints:p,extendedRtpCapabilities:a}){this.assertNotClosed(),D.debug("run()"),this._direction=e,this._remoteSdp=new ro.RemoteSdp({iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n}),this._sendingRtpParametersByKind={audio:We.getSendingRtpParameters("audio",a),video:We.getSendingRtpParameters("video",a)},this._sendingRemoteRtpParametersByKind={audio:We.getSendingRemoteRtpParameters("audio",a),video:We.getSendingRemoteRtpParameters("video",a)},i.role&&i.role!=="auto"&&(this._forcedLocalDtlsRole=i.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:o||[],iceTransportPolicy:d||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan",...u},p),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):(D.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.addEventListener("iceconnectionstatechange",()=>{switch(this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}}))}async updateIceServers(e){this.assertNotClosed(),D.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(this.assertNotClosed(),D.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});D.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const r={type:"answer",sdp:this._remoteSdp.getSdp()};D.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",r),await this._pc.setRemoteDescription(r)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};D.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();D.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}}async getTransportStats(){return this.assertNotClosed(),this._pc.getStats()}async send({track:e,encodings:t,codecOptions:r,codec:i}){if(this.assertNotClosed(),this.assertSendDirection(),D.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),t&&t.length>1){t.forEach((f,w)=>{f.rid=`r${w}`});let m=1,g=1;for(const f of t){const w=f.scalabilityMode?(0,so.parse)(f.scalabilityMode).temporalLayers:3;w>g&&(g=w)}for(const f of t)f.rid=`r${m++}`,f.scalabilityMode=`L1T${g}`}const n=Os.clone(this._sendingRtpParametersByKind[e.kind]);n.codecs=We.reduceCodecs(n.codecs,i);const o=Os.clone(this._sendingRemoteRtpParametersByKind[e.kind]);o.codecs=We.reduceCodecs(o.codecs,i);const d=this._remoteSdp.getNextMediaSectionIdx(),u=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream],sendEncodings:t}),p=await this._pc.createOffer();let a=xe.parse(p.sdp);this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:a}),D.debug("send() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p);const c=u.mid;n.mid=c,a=xe.parse(this._pc.localDescription.sdp);const l=a.media[d.idx];if(n.rtcp.cname=Bt.getCname({offerMediaObject:l}),!t)n.encodings=ks.getRtpEncodings({offerMediaObject:l});else if(t.length===1){const m=ks.getRtpEncodings({offerMediaObject:l});Object.assign(m[0],t[0]),n.encodings=m}else n.encodings=t;this._remoteSdp.send({offerMediaObject:l,reuseMid:d.reuseMid,offerRtpParameters:n,answerRtpParameters:o,codecOptions:r,extmapAllowMixed:!0});const h={type:"answer",sdp:this._remoteSdp.getSdp()};return D.debug("send() | calling pc.setRemoteDescription() [answer:%o]",h),await this._pc.setRemoteDescription(h),this._mapMidTransceiver.set(c,u),{localId:c,rtpParameters:n,rtpSender:u.sender}}async stopSending(e){if(this.assertSendDirection(),D.debug("stopSending() [localId:%s]",e),this._closed)return;const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");if(t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid))try{t.stop()}catch{}const i=await this._pc.createOffer();D.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};D.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n),this._mapMidTransceiver.delete(e)}async pauseSending(e){this.assertNotClosed(),this.assertSendDirection(),D.debug("pauseSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);const r=await this._pc.createOffer();D.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",r),await this._pc.setLocalDescription(r);const i={type:"answer",sdp:this._remoteSdp.getSdp()};D.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async resumeSending(e){this.assertNotClosed(),this.assertSendDirection(),D.debug("resumeSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(this._remoteSdp.resumeSendingMediaSection(e),!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly";const r=await this._pc.createOffer();D.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",r),await this._pc.setLocalDescription(r);const i={type:"answer",sdp:this._remoteSdp.getSdp()};D.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async replaceTrack(e,t){this.assertNotClosed(),this.assertSendDirection(),t?D.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):D.debug("replaceTrack() [localId:%s, no track]",e);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");await r.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertNotClosed(),this.assertSendDirection(),D.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");const i=r.sender.getParameters();i.encodings.forEach((d,u)=>{u<=t?d.active=!0:d.active=!1}),await r.sender.setParameters(i),this._remoteSdp.muxMediaSectionSimulcast(e,i.encodings);const n=await this._pc.createOffer();D.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const o={type:"answer",sdp:this._remoteSdp.getSdp()};D.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async setRtpEncodingParameters(e,t){this.assertNotClosed(),this.assertSendDirection(),D.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");const i=r.sender.getParameters();i.encodings.forEach((d,u)=>{i.encodings[u]={...d,...t}}),await r.sender.setParameters(i),this._remoteSdp.muxMediaSectionSimulcast(e,i.encodings);const n=await this._pc.createOffer();D.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const o={type:"answer",sdp:this._remoteSdp.getSdp()};D.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async getSenderStats(e){this.assertNotClosed(),this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:r,label:i,protocol:n}){this.assertNotClosed(),this.assertSendDirection();const o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:r,protocol:n};D.debug("sendDataChannel() [options:%o]",o);const d=this._pc.createDataChannel(i,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%js.MIS,!this._hasDataChannelMediaSection){const p=await this._pc.createOffer(),a=xe.parse(p.sdp),c=a.media.find(h=>h.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:a}),D.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p),this._remoteSdp.sendSctpAssociation({offerMediaObject:c});const l={type:"answer",sdp:this._remoteSdp.getSdp()};D.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l),this._hasDataChannelMediaSection=!0}const u={streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits};return{dataChannel:d,sctpStreamParameters:u}}async receive(e){this.assertNotClosed(),this.assertRecvDirection();const t=[],r=new Map;for(const d of e){const{trackId:u,kind:p,rtpParameters:a,streamId:c}=d;D.debug("receive() [trackId:%s, kind:%s]",u,p);const l=a.mid||String(this._mapMidTransceiver.size);r.set(u,l),this._remoteSdp.receive({mid:l,kind:p,offerRtpParameters:a,streamId:c||a.rtcp.cname,trackId:u})}const i={type:"offer",sdp:this._remoteSdp.getSdp()};D.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",i),await this._pc.setRemoteDescription(i);let n=await this._pc.createAnswer();const o=xe.parse(n.sdp);for(const d of e){const{trackId:u,rtpParameters:p}=d,a=r.get(u),c=o.media.find(l=>String(l.mid)===a);Bt.applyCodecParameters({offerRtpParameters:p,answerMediaObject:c})}n={type:"answer",sdp:xe.write(o)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:o}),D.debug("receive() | calling pc.setLocalDescription() [answer:%o]",n),await this._pc.setLocalDescription(n);for(const d of e){const{trackId:u}=d,p=r.get(u),a=this._pc.getTransceivers().find(c=>c.mid===p);if(a)this._mapMidTransceiver.set(p,a),t.push({localId:p,track:a.receiver.track,rtpReceiver:a.receiver});else throw new Error("new RTCRtpTransceiver not found")}return t}async stopReceiving(e){if(this.assertRecvDirection(),this._closed)return;for(const i of e){D.debug("stopReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(n.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};D.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();D.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r);for(const i of e)this._mapMidTransceiver.delete(i)}async pauseReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const i of e){D.debug("pauseReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="inactive",this._remoteSdp.pauseMediaSection(i)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};D.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();D.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}async resumeReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const i of e){D.debug("resumeReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(i)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};D.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();D.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}async getReceiverStats(e){this.assertNotClosed(),this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:r}){this.assertNotClosed(),this.assertRecvDirection();const{streamId:i,ordered:n,maxPacketLifeTime:o,maxRetransmits:d}=e,u={negotiated:!0,id:i,ordered:n,maxPacketLifeTime:o,maxRetransmits:d,protocol:r};D.debug("receiveDataChannel() [options:%o]",u);const p=this._pc.createDataChannel(t,u);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const a={type:"offer",sdp:this._remoteSdp.getSdp()};D.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",a),await this._pc.setRemoteDescription(a);const c=await this._pc.createAnswer();if(!this._transportReady){const l=xe.parse(c.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:l})}D.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",c),await this._pc.setLocalDescription(c),this._hasDataChannelMediaSection=!0}return{dataChannel:p}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=xe.parse(this._pc.localDescription.sdp));const r=Bt.extractDtlsParameters({sdpObject:t});r.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((i,n)=>{this.safeEmit("@connect",{dtlsParameters:r},i,n)}),this._transportReady=!0}assertNotClosed(){if(this._closed)throw new eo.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}ir.Chrome111=Wr;var nr={},io=_&&_.__createBinding||(Object.create?function(s,e,t,r){r===void 0&&(r=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(s,r,i)}:function(s,e,t,r){r===void 0&&(r=t),s[r]=e[t]}),no=_&&_.__setModuleDefault||(Object.create?function(s,e){Object.defineProperty(s,"default",{enumerable:!0,value:e})}:function(s,e){s.default=e}),dt=_&&_.__importStar||function(s){if(s&&s.__esModule)return s;var e={};if(s!=null)for(var t in s)t!=="default"&&Object.prototype.hasOwnProperty.call(s,t)&&io(e,s,t);return no(e,s),e};Object.defineProperty(nr,"__esModule",{value:!0});nr.Chrome74=void 0;const he=dt(Q),ao=K,Fs=dt(V),Ze=dt(S),Ut=dt(Y),Lr=dt(oe),oo=dt(Be),co=X,po=te,lo=se,uo=Se,R=new ao.Logger("Chrome74"),$s={OS:1024,MIS:1024};class Zr extends po.HandlerInterface{static createFactory(){return()=>new Zr}constructor(){super(),this._closed=!1,this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return"Chrome74"}close(){if(R.debug("close()"),!this._closed){if(this._closed=!0,this._pc)try{this._pc.close()}catch{}this.emit("@close")}}async getNativeRtpCapabilities(){R.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();try{e.close()}catch{}const r=he.parse(t.sdp),i=Ut.extractRtpCapabilities({sdpObject:r});return oo.addNackSuppportForOpus(i),i}catch(t){try{e.close()}catch{}throw t}}async getNativeSctpCapabilities(){return R.debug("getNativeSctpCapabilities()"),{numStreams:$s}}run({direction:e,iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n,iceServers:o,iceTransportPolicy:d,additionalSettings:u,proprietaryConstraints:p,extendedRtpCapabilities:a}){R.debug("run()"),this._direction=e,this._remoteSdp=new lo.RemoteSdp({iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n}),this._sendingRtpParametersByKind={audio:Ze.getSendingRtpParameters("audio",a),video:Ze.getSendingRtpParameters("video",a)},this._sendingRemoteRtpParametersByKind={audio:Ze.getSendingRemoteRtpParameters("audio",a),video:Ze.getSendingRemoteRtpParameters("video",a)},i.role&&i.role!=="auto"&&(this._forcedLocalDtlsRole=i.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:o||[],iceTransportPolicy:d||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan",...u},p),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):(R.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.addEventListener("iceconnectionstatechange",()=>{switch(this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}}))}async updateIceServers(e){this.assertNotClosed(),R.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(this.assertNotClosed(),R.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});R.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const r={type:"answer",sdp:this._remoteSdp.getSdp()};R.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",r),await this._pc.setRemoteDescription(r)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};R.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();R.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}}async getTransportStats(){return this.assertNotClosed(),this._pc.getStats()}async send({track:e,encodings:t,codecOptions:r,codec:i}){this.assertNotClosed(),this.assertSendDirection(),R.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),t&&t.length>1&&t.forEach((f,w)=>{f.rid=`r${w}`});const n=Fs.clone(this._sendingRtpParametersByKind[e.kind]);n.codecs=Ze.reduceCodecs(n.codecs,i);const o=Fs.clone(this._sendingRemoteRtpParametersByKind[e.kind]);o.codecs=Ze.reduceCodecs(o.codecs,i);const d=this._remoteSdp.getNextMediaSectionIdx(),u=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream],sendEncodings:t});let p=await this._pc.createOffer(),a=he.parse(p.sdp),c;this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:a});let l=!1;const h=(0,uo.parse)((t||[{}])[0].scalabilityMode);t&&t.length===1&&h.spatialLayers>1&&n.codecs[0].mimeType.toLowerCase()==="video/vp9"&&(R.debug("send() | enabling legacy simulcast for VP9 SVC"),l=!0,a=he.parse(p.sdp),c=a.media[d.idx],Lr.addLegacySimulcast({offerMediaObject:c,numStreams:h.spatialLayers}),p={type:"offer",sdp:he.write(a)}),R.debug("send() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p);const m=u.mid;if(n.mid=m,a=he.parse(this._pc.localDescription.sdp),c=a.media[d.idx],n.rtcp.cname=Ut.getCname({offerMediaObject:c}),!t)n.encodings=Lr.getRtpEncodings({offerMediaObject:c});else if(t.length===1){let f=Lr.getRtpEncodings({offerMediaObject:c});Object.assign(f[0],t[0]),l&&(f=[f[0]]),n.encodings=f}else n.encodings=t;if(n.encodings.length>1&&(n.codecs[0].mimeType.toLowerCase()==="video/vp8"||n.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const f of n.encodings)f.scalabilityMode?f.scalabilityMode=`L1T${h.temporalLayers}`:f.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:c,reuseMid:d.reuseMid,offerRtpParameters:n,answerRtpParameters:o,codecOptions:r,extmapAllowMixed:!0});const g={type:"answer",sdp:this._remoteSdp.getSdp()};return R.debug("send() | calling pc.setRemoteDescription() [answer:%o]",g),await this._pc.setRemoteDescription(g),this._mapMidTransceiver.set(m,u),{localId:m,rtpParameters:n,rtpSender:u.sender}}async stopSending(e){if(this.assertSendDirection(),R.debug("stopSending() [localId:%s]",e),this._closed)return;const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");if(t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid))try{t.stop()}catch{}const i=await this._pc.createOffer();R.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};R.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n),this._mapMidTransceiver.delete(e)}async pauseSending(e){this.assertNotClosed(),this.assertSendDirection(),R.debug("pauseSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);const r=await this._pc.createOffer();R.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",r),await this._pc.setLocalDescription(r);const i={type:"answer",sdp:this._remoteSdp.getSdp()};R.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async resumeSending(e){this.assertNotClosed(),this.assertSendDirection(),R.debug("resumeSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(this._remoteSdp.resumeSendingMediaSection(e),!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly";const r=await this._pc.createOffer();R.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",r),await this._pc.setLocalDescription(r);const i={type:"answer",sdp:this._remoteSdp.getSdp()};R.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async replaceTrack(e,t){this.assertNotClosed(),this.assertSendDirection(),t?R.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):R.debug("replaceTrack() [localId:%s, no track]",e);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");await r.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertNotClosed(),this.assertSendDirection(),R.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");const i=r.sender.getParameters();i.encodings.forEach((d,u)=>{u<=t?d.active=!0:d.active=!1}),await r.sender.setParameters(i),this._remoteSdp.muxMediaSectionSimulcast(e,i.encodings);const n=await this._pc.createOffer();R.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const o={type:"answer",sdp:this._remoteSdp.getSdp()};R.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async setRtpEncodingParameters(e,t){this.assertNotClosed(),this.assertSendDirection(),R.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");const i=r.sender.getParameters();i.encodings.forEach((d,u)=>{i.encodings[u]={...d,...t}}),await r.sender.setParameters(i),this._remoteSdp.muxMediaSectionSimulcast(e,i.encodings);const n=await this._pc.createOffer();R.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const o={type:"answer",sdp:this._remoteSdp.getSdp()};R.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async getSenderStats(e){this.assertNotClosed(),this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:r,label:i,protocol:n}){this.assertNotClosed(),this.assertSendDirection();const o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:r,protocol:n};R.debug("sendDataChannel() [options:%o]",o);const d=this._pc.createDataChannel(i,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%$s.MIS,!this._hasDataChannelMediaSection){const p=await this._pc.createOffer(),a=he.parse(p.sdp),c=a.media.find(h=>h.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:a}),R.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p),this._remoteSdp.sendSctpAssociation({offerMediaObject:c});const l={type:"answer",sdp:this._remoteSdp.getSdp()};R.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l),this._hasDataChannelMediaSection=!0}const u={streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits};return{dataChannel:d,sctpStreamParameters:u}}async receive(e){this.assertNotClosed(),this.assertRecvDirection();const t=[],r=new Map;for(const d of e){const{trackId:u,kind:p,rtpParameters:a,streamId:c}=d;R.debug("receive() [trackId:%s, kind:%s]",u,p);const l=a.mid||String(this._mapMidTransceiver.size);r.set(u,l),this._remoteSdp.receive({mid:l,kind:p,offerRtpParameters:a,streamId:c||a.rtcp.cname,trackId:u})}const i={type:"offer",sdp:this._remoteSdp.getSdp()};R.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",i),await this._pc.setRemoteDescription(i);let n=await this._pc.createAnswer();const o=he.parse(n.sdp);for(const d of e){const{trackId:u,rtpParameters:p}=d,a=r.get(u),c=o.media.find(l=>String(l.mid)===a);Ut.applyCodecParameters({offerRtpParameters:p,answerMediaObject:c})}n={type:"answer",sdp:he.write(o)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:o}),R.debug("receive() | calling pc.setLocalDescription() [answer:%o]",n),await this._pc.setLocalDescription(n);for(const d of e){const{trackId:u}=d,p=r.get(u),a=this._pc.getTransceivers().find(c=>c.mid===p);if(a)this._mapMidTransceiver.set(p,a),t.push({localId:p,track:a.receiver.track,rtpReceiver:a.receiver});else throw new Error("new RTCRtpTransceiver not found")}return t}async stopReceiving(e){if(this.assertRecvDirection(),this._closed)return;for(const i of e){R.debug("stopReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(n.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};R.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();R.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r);for(const i of e)this._mapMidTransceiver.delete(i)}async pauseReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const i of e){R.debug("pauseReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="inactive",this._remoteSdp.pauseMediaSection(i)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};R.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();R.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}async resumeReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const i of e){R.debug("resumeReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(i)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};R.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();R.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}async getReceiverStats(e){this.assertNotClosed(),this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:r}){this.assertNotClosed(),this.assertRecvDirection();const{streamId:i,ordered:n,maxPacketLifeTime:o,maxRetransmits:d}=e,u={negotiated:!0,id:i,ordered:n,maxPacketLifeTime:o,maxRetransmits:d,protocol:r};R.debug("receiveDataChannel() [options:%o]",u);const p=this._pc.createDataChannel(t,u);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const a={type:"offer",sdp:this._remoteSdp.getSdp()};R.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",a),await this._pc.setRemoteDescription(a);const c=await this._pc.createAnswer();if(!this._transportReady){const l=he.parse(c.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:l})}R.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",c),await this._pc.setLocalDescription(c),this._hasDataChannelMediaSection=!0}return{dataChannel:p}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=he.parse(this._pc.localDescription.sdp));const r=Ut.extractDtlsParameters({sdpObject:t});r.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((i,n)=>{this.safeEmit("@connect",{dtlsParameters:r},i,n)}),this._transportReady=!0}assertNotClosed(){if(this._closed)throw new co.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}nr.Chrome74=Zr;var ar={},ho=_&&_.__createBinding||(Object.create?function(s,e,t,r){r===void 0&&(r=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(s,r,i)}:function(s,e,t,r){r===void 0&&(r=t),s[r]=e[t]}),fo=_&&_.__setModuleDefault||(Object.create?function(s,e){Object.defineProperty(s,"default",{enumerable:!0,value:e})}:function(s,e){s.default=e}),Dt=_&&_.__importStar||function(s){if(s&&s.__esModule)return s;var e={};if(s!=null)for(var t in s)t!=="default"&&Object.prototype.hasOwnProperty.call(s,t)&&ho(e,s,t);return fo(e,s),e};Object.defineProperty(ar,"__esModule",{value:!0});ar.Chrome70=void 0;const ie=Dt(Q),mo=K,Ns=Dt(V),Je=Dt(S),zt=Dt(Y),xr=Dt(oe),go=te,_o=se,wo=Se,x=new mo.Logger("Chrome70"),As={OS:1024,MIS:1024};class Jr extends go.HandlerInterface{static createFactory(){return()=>new Jr}constructor(){super(),this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return"Chrome70"}close(){if(x.debug("close()"),this._pc)try{this._pc.close()}catch{}this.emit("@close")}async getNativeRtpCapabilities(){x.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();try{e.close()}catch{}const r=ie.parse(t.sdp);return zt.extractRtpCapabilities({sdpObject:r})}catch(t){try{e.close()}catch{}throw t}}async getNativeSctpCapabilities(){return x.debug("getNativeSctpCapabilities()"),{numStreams:As}}run({direction:e,iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n,iceServers:o,iceTransportPolicy:d,additionalSettings:u,proprietaryConstraints:p,extendedRtpCapabilities:a}){x.debug("run()"),this._direction=e,this._remoteSdp=new _o.RemoteSdp({iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n}),this._sendingRtpParametersByKind={audio:Je.getSendingRtpParameters("audio",a),video:Je.getSendingRtpParameters("video",a)},this._sendingRemoteRtpParametersByKind={audio:Je.getSendingRemoteRtpParameters("audio",a),video:Je.getSendingRemoteRtpParameters("video",a)},i.role&&i.role!=="auto"&&(this._forcedLocalDtlsRole=i.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:o||[],iceTransportPolicy:d||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan",...u},p),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(x.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}})}async updateIceServers(e){x.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(x.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});x.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const r={type:"answer",sdp:this._remoteSdp.getSdp()};x.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",r),await this._pc.setRemoteDescription(r)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};x.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();x.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:t,codecOptions:r,codec:i}){this.assertSendDirection(),x.debug("send() [kind:%s, track.id:%s]",e.kind,e.id);const n=Ns.clone(this._sendingRtpParametersByKind[e.kind]);n.codecs=Je.reduceCodecs(n.codecs,i);const o=Ns.clone(this._sendingRemoteRtpParametersByKind[e.kind]);o.codecs=Je.reduceCodecs(o.codecs,i);const d=this._remoteSdp.getNextMediaSectionIdx(),u=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream]});let p=await this._pc.createOffer(),a=ie.parse(p.sdp),c;this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:a}),t&&t.length>1&&(x.debug("send() | enabling legacy simulcast"),a=ie.parse(p.sdp),c=a.media[d.idx],xr.addLegacySimulcast({offerMediaObject:c,numStreams:t.length}),p={type:"offer",sdp:ie.write(a)});let l=!1;const h=(0,wo.parse)((t||[{}])[0].scalabilityMode);if(t&&t.length===1&&h.spatialLayers>1&&n.codecs[0].mimeType.toLowerCase()==="video/vp9"&&(x.debug("send() | enabling legacy simulcast for VP9 SVC"),l=!0,a=ie.parse(p.sdp),c=a.media[d.idx],xr.addLegacySimulcast({offerMediaObject:c,numStreams:h.spatialLayers}),p={type:"offer",sdp:ie.write(a)}),x.debug("send() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p),t){x.debug("send() | applying given encodings");const f=u.sender.getParameters();for(let w=0;w<(f.encodings||[]).length;++w){const I=f.encodings[w],v=t[w];if(!v)break;f.encodings[w]=Object.assign(I,v)}await u.sender.setParameters(f)}const m=u.mid;if(n.mid=m,a=ie.parse(this._pc.localDescription.sdp),c=a.media[d.idx],n.rtcp.cname=zt.getCname({offerMediaObject:c}),n.encodings=xr.getRtpEncodings({offerMediaObject:c}),t)for(let f=0;f<n.encodings.length;++f)t[f]&&Object.assign(n.encodings[f],t[f]);if(l&&(n.encodings=[n.encodings[0]]),n.encodings.length>1&&(n.codecs[0].mimeType.toLowerCase()==="video/vp8"||n.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const f of n.encodings)f.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:c,reuseMid:d.reuseMid,offerRtpParameters:n,answerRtpParameters:o,codecOptions:r});const g={type:"answer",sdp:this._remoteSdp.getSdp()};return x.debug("send() | calling pc.setRemoteDescription() [answer:%o]",g),await this._pc.setRemoteDescription(g),this._mapMidTransceiver.set(m,u),{localId:m,rtpParameters:n,rtpSender:u.sender}}async stopSending(e){this.assertSendDirection(),x.debug("stopSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");if(t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid))try{t.stop()}catch{}const i=await this._pc.createOffer();x.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};x.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n),this._mapMidTransceiver.delete(e)}async pauseSending(e){}async resumeSending(e){}async replaceTrack(e,t){this.assertSendDirection(),t?x.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):x.debug("replaceTrack() [localId:%s, no track]",e);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");await r.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertSendDirection(),x.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");const i=r.sender.getParameters();i.encodings.forEach((d,u)=>{u<=t?d.active=!0:d.active=!1}),await r.sender.setParameters(i),this._remoteSdp.muxMediaSectionSimulcast(e,i.encodings);const n=await this._pc.createOffer();x.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const o={type:"answer",sdp:this._remoteSdp.getSdp()};x.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async setRtpEncodingParameters(e,t){this.assertSendDirection(),x.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");const i=r.sender.getParameters();i.encodings.forEach((d,u)=>{i.encodings[u]={...d,...t}}),await r.sender.setParameters(i),this._remoteSdp.muxMediaSectionSimulcast(e,i.encodings);const n=await this._pc.createOffer();x.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const o={type:"answer",sdp:this._remoteSdp.getSdp()};x.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async getSenderStats(e){this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:r,label:i,protocol:n}){this.assertSendDirection();const o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmitTime:t,maxRetransmits:r,protocol:n};x.debug("sendDataChannel() [options:%o]",o);const d=this._pc.createDataChannel(i,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%As.MIS,!this._hasDataChannelMediaSection){const p=await this._pc.createOffer(),a=ie.parse(p.sdp),c=a.media.find(h=>h.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:a}),x.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p),this._remoteSdp.sendSctpAssociation({offerMediaObject:c});const l={type:"answer",sdp:this._remoteSdp.getSdp()};x.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l),this._hasDataChannelMediaSection=!0}const u={streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits};return{dataChannel:d,sctpStreamParameters:u}}async receive(e){this.assertRecvDirection();const t=[],r=new Map;for(const d of e){const{trackId:u,kind:p,rtpParameters:a,streamId:c}=d;x.debug("receive() [trackId:%s, kind:%s]",u,p);const l=a.mid||String(this._mapMidTransceiver.size);r.set(u,l),this._remoteSdp.receive({mid:l,kind:p,offerRtpParameters:a,streamId:c||a.rtcp.cname,trackId:u})}const i={type:"offer",sdp:this._remoteSdp.getSdp()};x.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",i),await this._pc.setRemoteDescription(i);let n=await this._pc.createAnswer();const o=ie.parse(n.sdp);for(const d of e){const{trackId:u,rtpParameters:p}=d,a=r.get(u),c=o.media.find(l=>String(l.mid)===a);zt.applyCodecParameters({offerRtpParameters:p,answerMediaObject:c})}n={type:"answer",sdp:ie.write(o)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:o}),x.debug("receive() | calling pc.setLocalDescription() [answer:%o]",n),await this._pc.setLocalDescription(n);for(const d of e){const{trackId:u}=d,p=r.get(u),a=this._pc.getTransceivers().find(c=>c.mid===p);if(!a)throw new Error("new RTCRtpTransceiver not found");this._mapMidTransceiver.set(p,a),t.push({localId:p,track:a.receiver.track,rtpReceiver:a.receiver})}return t}async stopReceiving(e){this.assertRecvDirection();for(const i of e){x.debug("stopReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(n.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};x.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();x.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r);for(const i of e)this._mapMidTransceiver.delete(i)}async pauseReceiving(e){}async resumeReceiving(e){}async getReceiverStats(e){this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:r}){this.assertRecvDirection();const{streamId:i,ordered:n,maxPacketLifeTime:o,maxRetransmits:d}=e,u={negotiated:!0,id:i,ordered:n,maxPacketLifeTime:o,maxRetransmitTime:o,maxRetransmits:d,protocol:r};x.debug("receiveDataChannel() [options:%o]",u);const p=this._pc.createDataChannel(t,u);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const a={type:"offer",sdp:this._remoteSdp.getSdp()};x.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",a),await this._pc.setRemoteDescription(a);const c=await this._pc.createAnswer();if(!this._transportReady){const l=ie.parse(c.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:l})}x.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",c),await this._pc.setLocalDescription(c),this._hasDataChannelMediaSection=!0}return{dataChannel:p}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=ie.parse(this._pc.localDescription.sdp));const r=zt.extractDtlsParameters({sdpObject:t});r.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((i,n)=>{this.safeEmit("@connect",{dtlsParameters:r},i,n)}),this._transportReady=!0}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}ar.Chrome70=Jr;var or={},Te={};Object.defineProperty(Te,"__esModule",{value:!0});Te.addLegacySimulcast=Te.getRtpEncodings=void 0;function vo({offerMediaObject:s,track:e}){const t=new Set;for(const n of s.ssrcs||[]){if(n.attribute!=="msid")continue;if(n.value.split(" ")[1]===e.id){const d=n.id;t.add(d)}}if(t.size===0)throw new Error(`a=ssrc line with msid information not found [track.id:${e.id}]`);const r=new Map;for(const n of s.ssrcGroups||[]){if(n.semantics!=="FID")continue;let[o,d]=n.ssrcs.split(/\s+/);o=Number(o),d=Number(d),t.has(o)&&(t.delete(o),t.delete(d),r.set(o,d))}for(const n of t)r.set(n,null);const i=[];for(const[n,o]of r){const d={ssrc:n};o&&(d.rtx={ssrc:o}),i.push(d)}return i}Te.getRtpEncodings=vo;function bo({offerMediaObject:s,track:e,numStreams:t}){if(t<=1)throw new TypeError("numStreams must be greater than 1");let r,i,n;if(!(s.ssrcs||[]).find(c=>c.attribute!=="msid"?!1:c.value.split(" ")[1]===e.id?(r=c.id,n=c.value.split(" ")[0],!0):!1))throw new Error(`a=ssrc line with msid information not found [track.id:${e.id}]`);(s.ssrcGroups||[]).some(c=>{if(c.semantics!=="FID")return!1;const l=c.ssrcs.split(/\s+/);return Number(l[0])===r?(i=Number(l[1]),!0):!1});const d=s.ssrcs.find(c=>c.attribute==="cname"&&c.id===r);if(!d)throw new Error(`a=ssrc line with cname information not found [track.id:${e.id}]`);const u=d.value,p=[],a=[];for(let c=0;c<t;++c)p.push(r+c),i&&a.push(i+c);s.ssrcGroups=s.ssrcGroups||[],s.ssrcs=s.ssrcs||[],s.ssrcGroups.push({semantics:"SIM",ssrcs:p.join(" ")});for(let c=0;c<p.length;++c){const l=p[c];s.ssrcs.push({id:l,attribute:"cname",value:u}),s.ssrcs.push({id:l,attribute:"msid",value:`${n} ${e.id}`})}for(let c=0;c<a.length;++c){const l=p[c],h=a[c];s.ssrcs.push({id:h,attribute:"cname",value:u}),s.ssrcs.push({id:h,attribute:"msid",value:`${n} ${e.id}`}),s.ssrcGroups.push({semantics:"FID",ssrcs:`${l} ${h}`})}}Te.addLegacySimulcast=bo;var So=_&&_.__createBinding||(Object.create?function(s,e,t,r){r===void 0&&(r=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(s,r,i)}:function(s,e,t,r){r===void 0&&(r=t),s[r]=e[t]}),yo=_&&_.__setModuleDefault||(Object.create?function(s,e){Object.defineProperty(s,"default",{enumerable:!0,value:e})}:function(s,e){s.default=e}),Tt=_&&_.__importStar||function(s){if(s&&s.__esModule)return s;var e={};if(s!=null)for(var t in s)t!=="default"&&Object.prototype.hasOwnProperty.call(s,t)&&So(e,s,t);return yo(e,s),e};Object.defineProperty(or,"__esModule",{value:!0});or.Chrome67=void 0;const fe=Tt(Q),Ro=K,Bs=Tt(V),Ye=Tt(S),Ht=Tt(Y),Us=Tt(Te),Co=te,Do=se,M=new Ro.Logger("Chrome67"),zs={OS:1024,MIS:1024};class Yr extends Co.HandlerInterface{static createFactory(){return()=>new Yr}constructor(){super(),this._sendStream=new MediaStream,this._mapSendLocalIdRtpSender=new Map,this._nextSendLocalId=0,this._mapRecvLocalIdInfo=new Map,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return"Chrome67"}close(){if(M.debug("close()"),this._pc)try{this._pc.close()}catch{}this.emit("@close")}async getNativeRtpCapabilities(){M.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"});try{const t=await e.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});try{e.close()}catch{}const r=fe.parse(t.sdp);return Ht.extractRtpCapabilities({sdpObject:r})}catch(t){try{e.close()}catch{}throw t}}async getNativeSctpCapabilities(){return M.debug("getNativeSctpCapabilities()"),{numStreams:zs}}run({direction:e,iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n,iceServers:o,iceTransportPolicy:d,additionalSettings:u,proprietaryConstraints:p,extendedRtpCapabilities:a}){M.debug("run()"),this._direction=e,this._remoteSdp=new Do.RemoteSdp({iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n,planB:!0}),this._sendingRtpParametersByKind={audio:Ye.getSendingRtpParameters("audio",a),video:Ye.getSendingRtpParameters("video",a)},this._sendingRemoteRtpParametersByKind={audio:Ye.getSendingRemoteRtpParameters("audio",a),video:Ye.getSendingRemoteRtpParameters("video",a)},i.role&&i.role!=="auto"&&(this._forcedLocalDtlsRole=i.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:o||[],iceTransportPolicy:d||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b",...u},p),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(M.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}})}async updateIceServers(e){M.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(M.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});M.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const r={type:"answer",sdp:this._remoteSdp.getSdp()};M.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",r),await this._pc.setRemoteDescription(r)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};M.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();M.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:t,codecOptions:r,codec:i}){this.assertSendDirection(),M.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),i&&M.warn("send() | codec selection is not available in %s handler",this.name),this._sendStream.addTrack(e),this._pc.addTrack(e,this._sendStream);let n=await this._pc.createOffer(),o=fe.parse(n.sdp),d;const u=Bs.clone(this._sendingRtpParametersByKind[e.kind]);u.codecs=Ye.reduceCodecs(u.codecs);const p=Bs.clone(this._sendingRemoteRtpParametersByKind[e.kind]);if(p.codecs=Ye.reduceCodecs(p.codecs),this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:o}),e.kind==="video"&&t&&t.length>1&&(M.debug("send() | enabling simulcast"),o=fe.parse(n.sdp),d=o.media.find(h=>h.type==="video"),Us.addLegacySimulcast({offerMediaObject:d,track:e,numStreams:t.length}),n={type:"offer",sdp:fe.write(o)}),M.debug("send() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n),o=fe.parse(this._pc.localDescription.sdp),d=o.media.find(h=>h.type===e.kind),u.rtcp.cname=Ht.getCname({offerMediaObject:d}),u.encodings=Us.getRtpEncodings({offerMediaObject:d,track:e}),t)for(let h=0;h<u.encodings.length;++h)t[h]&&Object.assign(u.encodings[h],t[h]);if(u.encodings.length>1&&u.codecs[0].mimeType.toLowerCase()==="video/vp8")for(const h of u.encodings)h.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:d,offerRtpParameters:u,answerRtpParameters:p,codecOptions:r});const a={type:"answer",sdp:this._remoteSdp.getSdp()};M.debug("send() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a);const c=String(this._nextSendLocalId);this._nextSendLocalId++;const l=this._pc.getSenders().find(h=>h.track===e);return this._mapSendLocalIdRtpSender.set(c,l),{localId:c,rtpParameters:u,rtpSender:l}}async stopSending(e){this.assertSendDirection(),M.debug("stopSending() [localId:%s]",e);const t=this._mapSendLocalIdRtpSender.get(e);if(!t)throw new Error("associated RTCRtpSender not found");this._pc.removeTrack(t),t.track&&this._sendStream.removeTrack(t.track),this._mapSendLocalIdRtpSender.delete(e);const r=await this._pc.createOffer();M.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",r);try{await this._pc.setLocalDescription(r)}catch(n){if(this._sendStream.getTracks().length===0){M.warn("stopSending() | ignoring expected error due no sending tracks: %s",n.toString());return}throw n}if(this._pc.signalingState==="stable")return;const i={type:"answer",sdp:this._remoteSdp.getSdp()};M.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async pauseSending(e){}async resumeSending(e){}async replaceTrack(e,t){this.assertSendDirection(),t?M.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):M.debug("replaceTrack() [localId:%s, no track]",e);const r=this._mapSendLocalIdRtpSender.get(e);if(!r)throw new Error("associated RTCRtpSender not found");const i=r.track;await r.replaceTrack(t),i&&this._sendStream.removeTrack(i),t&&this._sendStream.addTrack(t)}async setMaxSpatialLayer(e,t){this.assertSendDirection(),M.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const r=this._mapSendLocalIdRtpSender.get(e);if(!r)throw new Error("associated RTCRtpSender not found");const i=r.getParameters();i.encodings.forEach((n,o)=>{o<=t?n.active=!0:n.active=!1}),await r.setParameters(i)}async setRtpEncodingParameters(e,t){this.assertSendDirection(),M.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const r=this._mapSendLocalIdRtpSender.get(e);if(!r)throw new Error("associated RTCRtpSender not found");const i=r.getParameters();i.encodings.forEach((n,o)=>{i.encodings[o]={...n,...t}}),await r.setParameters(i)}async getSenderStats(e){this.assertSendDirection();const t=this._mapSendLocalIdRtpSender.get(e);if(!t)throw new Error("associated RTCRtpSender not found");return t.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:r,label:i,protocol:n}){this.assertSendDirection();const o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmitTime:t,maxRetransmits:r,protocol:n};M.debug("sendDataChannel() [options:%o]",o);const d=this._pc.createDataChannel(i,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%zs.MIS,!this._hasDataChannelMediaSection){const p=await this._pc.createOffer(),a=fe.parse(p.sdp),c=a.media.find(h=>h.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:a}),M.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p),this._remoteSdp.sendSctpAssociation({offerMediaObject:c});const l={type:"answer",sdp:this._remoteSdp.getSdp()};M.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l),this._hasDataChannelMediaSection=!0}const u={streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits};return{dataChannel:d,sctpStreamParameters:u}}async receive(e){this.assertRecvDirection();const t=[];for(const o of e){const{trackId:d,kind:u,rtpParameters:p,streamId:a}=o;M.debug("receive() [trackId:%s, kind:%s]",d,u);const c=u;this._remoteSdp.receive({mid:c,kind:u,offerRtpParameters:p,streamId:a||p.rtcp.cname,trackId:d})}const r={type:"offer",sdp:this._remoteSdp.getSdp()};M.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",r),await this._pc.setRemoteDescription(r);let i=await this._pc.createAnswer();const n=fe.parse(i.sdp);for(const o of e){const{kind:d,rtpParameters:u}=o,p=d,a=n.media.find(c=>String(c.mid)===p);Ht.applyCodecParameters({offerRtpParameters:u,answerMediaObject:a})}i={type:"answer",sdp:fe.write(n)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:n}),M.debug("receive() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i);for(const o of e){const{kind:d,trackId:u,rtpParameters:p}=o,a=u,c=d,l=this._pc.getReceivers().find(h=>h.track&&h.track.id===a);if(!l)throw new Error("new RTCRtpReceiver not");this._mapRecvLocalIdInfo.set(a,{mid:c,rtpParameters:p,rtpReceiver:l}),t.push({localId:a,track:l.track,rtpReceiver:l})}return t}async stopReceiving(e){this.assertRecvDirection();for(const i of e){M.debug("stopReceiving() [localId:%s]",i);const{mid:n,rtpParameters:o}=this._mapRecvLocalIdInfo.get(i)||{};this._mapRecvLocalIdInfo.delete(i),this._remoteSdp.planBStopReceiving({mid:n,offerRtpParameters:o})}const t={type:"offer",sdp:this._remoteSdp.getSdp()};M.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();M.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}async pauseReceiving(e){}async resumeReceiving(e){}async getReceiverStats(e){this.assertRecvDirection();const{rtpReceiver:t}=this._mapRecvLocalIdInfo.get(e)||{};if(!t)throw new Error("associated RTCRtpReceiver not found");return t.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:r}){this.assertRecvDirection();const{streamId:i,ordered:n,maxPacketLifeTime:o,maxRetransmits:d}=e,u={negotiated:!0,id:i,ordered:n,maxPacketLifeTime:o,maxRetransmitTime:o,maxRetransmits:d,protocol:r};M.debug("receiveDataChannel() [options:%o]",u);const p=this._pc.createDataChannel(t,u);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation({oldDataChannelSpec:!0});const a={type:"offer",sdp:this._remoteSdp.getSdp()};M.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",a),await this._pc.setRemoteDescription(a);const c=await this._pc.createAnswer();if(!this._transportReady){const l=fe.parse(c.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:l})}M.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",c),await this._pc.setLocalDescription(c),this._hasDataChannelMediaSection=!0}return{dataChannel:p}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=fe.parse(this._pc.localDescription.sdp));const r=Ht.extractDtlsParameters({sdpObject:t});r.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((i,n)=>{this.safeEmit("@connect",{dtlsParameters:r},i,n)}),this._transportReady=!0}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}or.Chrome67=Yr;var cr={},To=_&&_.__createBinding||(Object.create?function(s,e,t,r){r===void 0&&(r=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(s,r,i)}:function(s,e,t,r){r===void 0&&(r=t),s[r]=e[t]}),Po=_&&_.__setModuleDefault||(Object.create?function(s,e){Object.defineProperty(s,"default",{enumerable:!0,value:e})}:function(s,e){s.default=e}),Pt=_&&_.__importStar||function(s){if(s&&s.__esModule)return s;var e={};if(s!=null)for(var t in s)t!=="default"&&Object.prototype.hasOwnProperty.call(s,t)&&To(e,s,t);return Po(e,s),e};Object.defineProperty(cr,"__esModule",{value:!0});cr.Chrome55=void 0;const me=Pt(Q),Eo=K,gt=X,Hs=Pt(V),Xe=Pt(S),Gt=Pt(Y),Gs=Pt(Te),Lo=te,xo=se,F=new Eo.Logger("Chrome55"),qs={OS:1024,MIS:1024};class Xr extends Lo.HandlerInterface{static createFactory(){return()=>new Xr}constructor(){super(),this._sendStream=new MediaStream,this._mapSendLocalIdTrack=new Map,this._nextSendLocalId=0,this._mapRecvLocalIdInfo=new Map,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return"Chrome55"}close(){if(F.debug("close()"),this._pc)try{this._pc.close()}catch{}this.emit("@close")}async getNativeRtpCapabilities(){F.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"});try{const t=await e.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});try{e.close()}catch{}const r=me.parse(t.sdp);return Gt.extractRtpCapabilities({sdpObject:r})}catch(t){try{e.close()}catch{}throw t}}async getNativeSctpCapabilities(){return F.debug("getNativeSctpCapabilities()"),{numStreams:qs}}run({direction:e,iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n,iceServers:o,iceTransportPolicy:d,additionalSettings:u,proprietaryConstraints:p,extendedRtpCapabilities:a}){F.debug("run()"),this._direction=e,this._remoteSdp=new xo.RemoteSdp({iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n,planB:!0}),this._sendingRtpParametersByKind={audio:Xe.getSendingRtpParameters("audio",a),video:Xe.getSendingRtpParameters("video",a)},this._sendingRemoteRtpParametersByKind={audio:Xe.getSendingRemoteRtpParameters("audio",a),video:Xe.getSendingRemoteRtpParameters("video",a)},i.role&&i.role!=="auto"&&(this._forcedLocalDtlsRole=i.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:o||[],iceTransportPolicy:d||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b",...u},p),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(F.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}})}async updateIceServers(e){F.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(F.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});F.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const r={type:"answer",sdp:this._remoteSdp.getSdp()};F.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",r),await this._pc.setRemoteDescription(r)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};F.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();F.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:t,codecOptions:r,codec:i}){this.assertSendDirection(),F.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),i&&F.warn("send() | codec selection is not available in %s handler",this.name),this._sendStream.addTrack(e),this._pc.addStream(this._sendStream);let n=await this._pc.createOffer(),o=me.parse(n.sdp),d;const u=Hs.clone(this._sendingRtpParametersByKind[e.kind]);u.codecs=Xe.reduceCodecs(u.codecs);const p=Hs.clone(this._sendingRemoteRtpParametersByKind[e.kind]);if(p.codecs=Xe.reduceCodecs(p.codecs),this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:o}),e.kind==="video"&&t&&t.length>1&&(F.debug("send() | enabling simulcast"),o=me.parse(n.sdp),d=o.media.find(l=>l.type==="video"),Gs.addLegacySimulcast({offerMediaObject:d,track:e,numStreams:t.length}),n={type:"offer",sdp:me.write(o)}),F.debug("send() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n),o=me.parse(this._pc.localDescription.sdp),d=o.media.find(l=>l.type===e.kind),u.rtcp.cname=Gt.getCname({offerMediaObject:d}),u.encodings=Gs.getRtpEncodings({offerMediaObject:d,track:e}),t)for(let l=0;l<u.encodings.length;++l)t[l]&&Object.assign(u.encodings[l],t[l]);if(u.encodings.length>1&&u.codecs[0].mimeType.toLowerCase()==="video/vp8")for(const l of u.encodings)l.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:d,offerRtpParameters:u,answerRtpParameters:p,codecOptions:r});const a={type:"answer",sdp:this._remoteSdp.getSdp()};F.debug("send() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a);const c=String(this._nextSendLocalId);return this._nextSendLocalId++,this._mapSendLocalIdTrack.set(c,e),{localId:c,rtpParameters:u}}async stopSending(e){this.assertSendDirection(),F.debug("stopSending() [localId:%s]",e);const t=this._mapSendLocalIdTrack.get(e);if(!t)throw new Error("track not found");this._mapSendLocalIdTrack.delete(e),this._sendStream.removeTrack(t),this._pc.addStream(this._sendStream);const r=await this._pc.createOffer();F.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",r);try{await this._pc.setLocalDescription(r)}catch(n){if(this._sendStream.getTracks().length===0){F.warn("stopSending() | ignoring expected error due no sending tracks: %s",n.toString());return}throw n}if(this._pc.signalingState==="stable")return;const i={type:"answer",sdp:this._remoteSdp.getSdp()};F.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async pauseSending(e){}async resumeSending(e){}async replaceTrack(e,t){throw new gt.UnsupportedError("not implemented")}async setMaxSpatialLayer(e,t){throw new gt.UnsupportedError(" not implemented")}async setRtpEncodingParameters(e,t){throw new gt.UnsupportedError("not supported")}async getSenderStats(e){throw new gt.UnsupportedError("not implemented")}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:r,label:i,protocol:n}){this.assertSendDirection();const o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmitTime:t,maxRetransmits:r,protocol:n};F.debug("sendDataChannel() [options:%o]",o);const d=this._pc.createDataChannel(i,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%qs.MIS,!this._hasDataChannelMediaSection){const p=await this._pc.createOffer(),a=me.parse(p.sdp),c=a.media.find(h=>h.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:a}),F.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p),this._remoteSdp.sendSctpAssociation({offerMediaObject:c});const l={type:"answer",sdp:this._remoteSdp.getSdp()};F.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l),this._hasDataChannelMediaSection=!0}const u={streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits};return{dataChannel:d,sctpStreamParameters:u}}async receive(e){this.assertRecvDirection();const t=[];for(const o of e){const{trackId:d,kind:u,rtpParameters:p,streamId:a}=o;F.debug("receive() [trackId:%s, kind:%s]",d,u);const c=u;this._remoteSdp.receive({mid:c,kind:u,offerRtpParameters:p,streamId:a||p.rtcp.cname,trackId:d})}const r={type:"offer",sdp:this._remoteSdp.getSdp()};F.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",r),await this._pc.setRemoteDescription(r);let i=await this._pc.createAnswer();const n=me.parse(i.sdp);for(const o of e){const{kind:d,rtpParameters:u}=o,p=d,a=n.media.find(c=>String(c.mid)===p);Gt.applyCodecParameters({offerRtpParameters:u,answerMediaObject:a})}i={type:"answer",sdp:me.write(n)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:n}),F.debug("receive() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i);for(const o of e){const{kind:d,trackId:u,rtpParameters:p}=o,a=d,c=u,l=o.streamId||p.rtcp.cname,m=this._pc.getRemoteStreams().find(g=>g.id===l).getTrackById(c);if(!m)throw new Error("remote track not found");this._mapRecvLocalIdInfo.set(c,{mid:a,rtpParameters:p}),t.push({localId:c,track:m})}return t}async stopReceiving(e){this.assertRecvDirection();for(const i of e){F.debug("stopReceiving() [localId:%s]",i);const{mid:n,rtpParameters:o}=this._mapRecvLocalIdInfo.get(i)||{};this._mapRecvLocalIdInfo.delete(i),this._remoteSdp.planBStopReceiving({mid:n,offerRtpParameters:o})}const t={type:"offer",sdp:this._remoteSdp.getSdp()};F.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();F.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}async pauseReceiving(e){}async resumeReceiving(e){}async getReceiverStats(e){throw new gt.UnsupportedError("not implemented")}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:r}){this.assertRecvDirection();const{streamId:i,ordered:n,maxPacketLifeTime:o,maxRetransmits:d}=e,u={negotiated:!0,id:i,ordered:n,maxPacketLifeTime:o,maxRetransmitTime:o,maxRetransmits:d,protocol:r};F.debug("receiveDataChannel() [options:%o]",u);const p=this._pc.createDataChannel(t,u);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation({oldDataChannelSpec:!0});const a={type:"offer",sdp:this._remoteSdp.getSdp()};F.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",a),await this._pc.setRemoteDescription(a);const c=await this._pc.createAnswer();if(!this._transportReady){const l=me.parse(c.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:l})}F.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",c),await this._pc.setLocalDescription(c),this._hasDataChannelMediaSection=!0}return{dataChannel:p}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=me.parse(this._pc.localDescription.sdp));const r=Gt.extractDtlsParameters({sdpObject:t});r.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((i,n)=>{this.safeEmit("@connect",{dtlsParameters:r},i,n)}),this._transportReady=!0}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}cr.Chrome55=Xr;var dr={},Mo=_&&_.__createBinding||(Object.create?function(s,e,t,r){r===void 0&&(r=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(s,r,i)}:function(s,e,t,r){r===void 0&&(r=t),s[r]=e[t]}),Io=_&&_.__setModuleDefault||(Object.create?function(s,e){Object.defineProperty(s,"default",{enumerable:!0,value:e})}:function(s,e){s.default=e}),Et=_&&_.__importStar||function(s){if(s&&s.__esModule)return s;var e={};if(s!=null)for(var t in s)t!=="default"&&Object.prototype.hasOwnProperty.call(s,t)&&Mo(e,s,t);return Io(e,s),e};Object.defineProperty(dr,"__esModule",{value:!0});dr.Firefox60=void 0;const Me=Et(Q),Oo=K,Ks=X,Mr=Et(V),et=Et(S),qt=Et(Y),Vs=Et(oe),ko=te,jo=se,Fo=Se,T=new Oo.Logger("Firefox60"),Qs={OS:16,MIS:2048};class es extends ko.HandlerInterface{static createFactory(){return()=>new es}constructor(){super(),this._closed=!1,this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return"Firefox60"}close(){if(T.debug("close()"),!this._closed){if(this._closed=!0,this._pc)try{this._pc.close()}catch{}this.emit("@close")}}async getNativeRtpCapabilities(){T.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"}),t=document.createElement("canvas");t.getContext("2d");const i=t.captureStream().getVideoTracks()[0];try{e.addTransceiver("audio",{direction:"sendrecv"});const n=e.addTransceiver(i,{direction:"sendrecv"}),o=n.sender.getParameters(),d=[{rid:"r0",maxBitrate:1e5},{rid:"r1",maxBitrate:5e5}];o.encodings=d,await n.sender.setParameters(o);const u=await e.createOffer();try{t.remove()}catch{}try{i.stop()}catch{}try{e.close()}catch{}const p=Me.parse(u.sdp);return qt.extractRtpCapabilities({sdpObject:p})}catch(n){try{t.remove()}catch{}try{i.stop()}catch{}try{e.close()}catch{}throw n}}async getNativeSctpCapabilities(){return T.debug("getNativeSctpCapabilities()"),{numStreams:Qs}}run({direction:e,iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n,iceServers:o,iceTransportPolicy:d,additionalSettings:u,proprietaryConstraints:p,extendedRtpCapabilities:a}){this.assertNotClosed(),T.debug("run()"),this._direction=e,this._remoteSdp=new jo.RemoteSdp({iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n}),this._sendingRtpParametersByKind={audio:et.getSendingRtpParameters("audio",a),video:et.getSendingRtpParameters("video",a)},this._sendingRemoteRtpParametersByKind={audio:et.getSendingRemoteRtpParameters("audio",a),video:et.getSendingRemoteRtpParameters("video",a)},this._pc=new RTCPeerConnection({iceServers:o||[],iceTransportPolicy:d||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...u},p),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(T.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}})}async updateIceServers(e){throw this.assertNotClosed(),new Ks.UnsupportedError("not supported")}async restartIce(e){if(this.assertNotClosed(),T.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});T.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const r={type:"answer",sdp:this._remoteSdp.getSdp()};T.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",r),await this._pc.setRemoteDescription(r)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};T.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();T.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}}async getTransportStats(){return this.assertNotClosed(),this._pc.getStats()}async send({track:e,encodings:t,codecOptions:r,codec:i}){this.assertNotClosed(),this.assertSendDirection(),T.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),t&&(t=Mr.clone(t),t.length>1&&(t.forEach((m,g)=>{m.rid=`r${g}`}),t.reverse()));const n=Mr.clone(this._sendingRtpParametersByKind[e.kind]);n.codecs=et.reduceCodecs(n.codecs,i);const o=Mr.clone(this._sendingRemoteRtpParametersByKind[e.kind]);o.codecs=et.reduceCodecs(o.codecs,i);const d=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream]});if(t){const m=d.sender.getParameters();m.encodings=t,await d.sender.setParameters(m)}const u=await this._pc.createOffer();let p=Me.parse(u.sdp);this._transportReady||await this.setupTransport({localDtlsRole:"client",localSdpObject:p});const a=(0,Fo.parse)((t||[{}])[0].scalabilityMode);T.debug("send() | calling pc.setLocalDescription() [offer:%o]",u),await this._pc.setLocalDescription(u);const c=d.mid;n.mid=c,p=Me.parse(this._pc.localDescription.sdp);const l=p.media[p.media.length-1];if(n.rtcp.cname=qt.getCname({offerMediaObject:l}),!t)n.encodings=Vs.getRtpEncodings({offerMediaObject:l});else if(t.length===1){const m=Vs.getRtpEncodings({offerMediaObject:l});Object.assign(m[0],t[0]),n.encodings=m}else n.encodings=t.reverse();if(n.encodings.length>1&&(n.codecs[0].mimeType.toLowerCase()==="video/vp8"||n.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const m of n.encodings)m.scalabilityMode?m.scalabilityMode=`L1T${a.temporalLayers}`:m.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:l,offerRtpParameters:n,answerRtpParameters:o,codecOptions:r,extmapAllowMixed:!0});const h={type:"answer",sdp:this._remoteSdp.getSdp()};return T.debug("send() | calling pc.setRemoteDescription() [answer:%o]",h),await this._pc.setRemoteDescription(h),this._mapMidTransceiver.set(c,d),{localId:c,rtpParameters:n,rtpSender:d.sender}}async stopSending(e){if(this.assertSendDirection(),T.debug("stopSending() [localId:%s]",e),this._closed)return;const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated transceiver not found");t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.disableMediaSection(t.mid);const r=await this._pc.createOffer();T.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",r),await this._pc.setLocalDescription(r);const i={type:"answer",sdp:this._remoteSdp.getSdp()};T.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i),this._mapMidTransceiver.delete(e)}async pauseSending(e){this.assertNotClosed(),this.assertSendDirection(),T.debug("pauseSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);const r=await this._pc.createOffer();T.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",r),await this._pc.setLocalDescription(r);const i={type:"answer",sdp:this._remoteSdp.getSdp()};T.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async resumeSending(e){this.assertNotClosed(),this.assertSendDirection(),T.debug("resumeSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly",this._remoteSdp.resumeSendingMediaSection(e);const r=await this._pc.createOffer();T.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",r),await this._pc.setLocalDescription(r);const i={type:"answer",sdp:this._remoteSdp.getSdp()};T.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async replaceTrack(e,t){this.assertNotClosed(),this.assertSendDirection(),t?T.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):T.debug("replaceTrack() [localId:%s, no track]",e);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");await r.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertNotClosed(),this.assertSendDirection(),T.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated transceiver not found");const i=r.sender.getParameters();t=i.encodings.length-1-t,i.encodings.forEach((d,u)=>{u>=t?d.active=!0:d.active=!1}),await r.sender.setParameters(i),this._remoteSdp.muxMediaSectionSimulcast(e,i.encodings);const n=await this._pc.createOffer();T.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const o={type:"answer",sdp:this._remoteSdp.getSdp()};T.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async setRtpEncodingParameters(e,t){this.assertNotClosed(),this.assertSendDirection(),T.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");const i=r.sender.getParameters();i.encodings.forEach((d,u)=>{i.encodings[u]={...d,...t}}),await r.sender.setParameters(i),this._remoteSdp.muxMediaSectionSimulcast(e,i.encodings);const n=await this._pc.createOffer();T.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const o={type:"answer",sdp:this._remoteSdp.getSdp()};T.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async getSenderStats(e){this.assertNotClosed(),this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:r,label:i,protocol:n}){this.assertNotClosed(),this.assertSendDirection();const o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:r,protocol:n};T.debug("sendDataChannel() [options:%o]",o);const d=this._pc.createDataChannel(i,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%Qs.MIS,!this._hasDataChannelMediaSection){const p=await this._pc.createOffer(),a=Me.parse(p.sdp),c=a.media.find(h=>h.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:"client",localSdpObject:a}),T.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p),this._remoteSdp.sendSctpAssociation({offerMediaObject:c});const l={type:"answer",sdp:this._remoteSdp.getSdp()};T.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l),this._hasDataChannelMediaSection=!0}const u={streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits};return{dataChannel:d,sctpStreamParameters:u}}async receive(e){this.assertNotClosed(),this.assertRecvDirection();const t=[],r=new Map;for(const d of e){const{trackId:u,kind:p,rtpParameters:a,streamId:c}=d;T.debug("receive() [trackId:%s, kind:%s]",u,p);const l=a.mid||String(this._mapMidTransceiver.size);r.set(u,l),this._remoteSdp.receive({mid:l,kind:p,offerRtpParameters:a,streamId:c||a.rtcp.cname,trackId:u})}const i={type:"offer",sdp:this._remoteSdp.getSdp()};T.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",i),await this._pc.setRemoteDescription(i);let n=await this._pc.createAnswer();const o=Me.parse(n.sdp);for(const d of e){const{trackId:u,rtpParameters:p}=d,a=r.get(u),c=o.media.find(l=>String(l.mid)===a);qt.applyCodecParameters({offerRtpParameters:p,answerMediaObject:c}),n={type:"answer",sdp:Me.write(o)}}this._transportReady||await this.setupTransport({localDtlsRole:"client",localSdpObject:o}),T.debug("receive() | calling pc.setLocalDescription() [answer:%o]",n),await this._pc.setLocalDescription(n);for(const d of e){const{trackId:u}=d,p=r.get(u),a=this._pc.getTransceivers().find(c=>c.mid===p);if(!a)throw new Error("new RTCRtpTransceiver not found");this._mapMidTransceiver.set(p,a),t.push({localId:p,track:a.receiver.track,rtpReceiver:a.receiver})}return t}async stopReceiving(e){if(this.assertRecvDirection(),this._closed)return;for(const i of e){T.debug("stopReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(n.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};T.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();T.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r);for(const i of e)this._mapMidTransceiver.delete(i)}async pauseReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const i of e){T.debug("pauseReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="inactive",this._remoteSdp.pauseMediaSection(i)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};T.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();T.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}async resumeReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const i of e){T.debug("resumeReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(i)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};T.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();T.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}async getReceiverStats(e){this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:r}){this.assertNotClosed(),this.assertRecvDirection();const{streamId:i,ordered:n,maxPacketLifeTime:o,maxRetransmits:d}=e,u={negotiated:!0,id:i,ordered:n,maxPacketLifeTime:o,maxRetransmits:d,protocol:r};T.debug("receiveDataChannel() [options:%o]",u);const p=this._pc.createDataChannel(t,u);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const a={type:"offer",sdp:this._remoteSdp.getSdp()};T.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",a),await this._pc.setRemoteDescription(a);const c=await this._pc.createAnswer();if(!this._transportReady){const l=Me.parse(c.sdp);await this.setupTransport({localDtlsRole:"client",localSdpObject:l})}T.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",c),await this._pc.setLocalDescription(c),this._hasDataChannelMediaSection=!0}return{dataChannel:p}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=Me.parse(this._pc.localDescription.sdp));const r=qt.extractDtlsParameters({sdpObject:t});r.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((i,n)=>{this.safeEmit("@connect",{dtlsParameters:r},i,n)}),this._transportReady=!0}assertNotClosed(){if(this._closed)throw new Ks.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}dr.Firefox60=es;var pr={},$o=_&&_.__createBinding||(Object.create?function(s,e,t,r){r===void 0&&(r=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(s,r,i)}:function(s,e,t,r){r===void 0&&(r=t),s[r]=e[t]}),No=_&&_.__setModuleDefault||(Object.create?function(s,e){Object.defineProperty(s,"default",{enumerable:!0,value:e})}:function(s,e){s.default=e}),pt=_&&_.__importStar||function(s){if(s&&s.__esModule)return s;var e={};if(s!=null)for(var t in s)t!=="default"&&Object.prototype.hasOwnProperty.call(s,t)&&$o(e,s,t);return No(e,s),e};Object.defineProperty(pr,"__esModule",{value:!0});pr.Safari12=void 0;const ge=pt(Q),Ao=K,Ws=pt(V),tt=pt(S),Kt=pt(Y),Zs=pt(oe),Bo=pt(Be),Uo=X,zo=te,Ho=se,Go=Se,C=new Ao.Logger("Safari12"),Js={OS:1024,MIS:1024};class ts extends zo.HandlerInterface{static createFactory(){return()=>new ts}constructor(){super(),this._closed=!1,this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return"Safari12"}close(){if(C.debug("close()"),!this._closed){if(this._closed=!0,this._pc)try{this._pc.close()}catch{}this.emit("@close")}}async getNativeRtpCapabilities(){C.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();try{e.close()}catch{}const r=ge.parse(t.sdp),i=Kt.extractRtpCapabilities({sdpObject:r});return Bo.addNackSuppportForOpus(i),i}catch(t){try{e.close()}catch{}throw t}}async getNativeSctpCapabilities(){return C.debug("getNativeSctpCapabilities()"),{numStreams:Js}}run({direction:e,iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n,iceServers:o,iceTransportPolicy:d,additionalSettings:u,proprietaryConstraints:p,extendedRtpCapabilities:a}){this.assertNotClosed(),C.debug("run()"),this._direction=e,this._remoteSdp=new Ho.RemoteSdp({iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n}),this._sendingRtpParametersByKind={audio:tt.getSendingRtpParameters("audio",a),video:tt.getSendingRtpParameters("video",a)},this._sendingRemoteRtpParametersByKind={audio:tt.getSendingRemoteRtpParameters("audio",a),video:tt.getSendingRemoteRtpParameters("video",a)},i.role&&i.role!=="auto"&&(this._forcedLocalDtlsRole=i.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:o||[],iceTransportPolicy:d||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...u},p),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(C.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}})}async updateIceServers(e){this.assertNotClosed(),C.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(this.assertNotClosed(),C.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});C.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const r={type:"answer",sdp:this._remoteSdp.getSdp()};C.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",r),await this._pc.setRemoteDescription(r)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};C.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();C.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}}async getTransportStats(){return this.assertNotClosed(),this._pc.getStats()}async send({track:e,encodings:t,codecOptions:r,codec:i}){this.assertNotClosed(),this.assertSendDirection(),C.debug("send() [kind:%s, track.id:%s]",e.kind,e.id);const n=Ws.clone(this._sendingRtpParametersByKind[e.kind]);n.codecs=tt.reduceCodecs(n.codecs,i);const o=Ws.clone(this._sendingRemoteRtpParametersByKind[e.kind]);o.codecs=tt.reduceCodecs(o.codecs,i);const d=this._remoteSdp.getNextMediaSectionIdx(),u=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream]});let p=await this._pc.createOffer(),a=ge.parse(p.sdp),c;this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:a});const l=(0,Go.parse)((t||[{}])[0].scalabilityMode);t&&t.length>1&&(C.debug("send() | enabling legacy simulcast"),a=ge.parse(p.sdp),c=a.media[d.idx],Zs.addLegacySimulcast({offerMediaObject:c,numStreams:t.length}),p={type:"offer",sdp:ge.write(a)}),C.debug("send() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p);const h=u.mid;if(n.mid=h,a=ge.parse(this._pc.localDescription.sdp),c=a.media[d.idx],n.rtcp.cname=Kt.getCname({offerMediaObject:c}),n.encodings=Zs.getRtpEncodings({offerMediaObject:c}),t)for(let g=0;g<n.encodings.length;++g)t[g]&&Object.assign(n.encodings[g],t[g]);if(n.encodings.length>1&&(n.codecs[0].mimeType.toLowerCase()==="video/vp8"||n.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const g of n.encodings)g.scalabilityMode?g.scalabilityMode=`L1T${l.temporalLayers}`:g.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:c,reuseMid:d.reuseMid,offerRtpParameters:n,answerRtpParameters:o,codecOptions:r});const m={type:"answer",sdp:this._remoteSdp.getSdp()};return C.debug("send() | calling pc.setRemoteDescription() [answer:%o]",m),await this._pc.setRemoteDescription(m),this._mapMidTransceiver.set(h,u),{localId:h,rtpParameters:n,rtpSender:u.sender}}async stopSending(e){if(this.assertSendDirection(),this._closed)return;C.debug("stopSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");if(t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid))try{t.stop()}catch{}const i=await this._pc.createOffer();C.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};C.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n),this._mapMidTransceiver.delete(e)}async pauseSending(e){this.assertNotClosed(),this.assertSendDirection(),C.debug("pauseSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);const r=await this._pc.createOffer();C.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",r),await this._pc.setLocalDescription(r);const i={type:"answer",sdp:this._remoteSdp.getSdp()};C.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async resumeSending(e){this.assertNotClosed(),this.assertSendDirection(),C.debug("resumeSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly",this._remoteSdp.resumeSendingMediaSection(e);const r=await this._pc.createOffer();C.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",r),await this._pc.setLocalDescription(r);const i={type:"answer",sdp:this._remoteSdp.getSdp()};C.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async replaceTrack(e,t){this.assertNotClosed(),this.assertSendDirection(),t?C.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):C.debug("replaceTrack() [localId:%s, no track]",e);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");await r.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertNotClosed(),this.assertSendDirection(),C.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");const i=r.sender.getParameters();i.encodings.forEach((d,u)=>{u<=t?d.active=!0:d.active=!1}),await r.sender.setParameters(i),this._remoteSdp.muxMediaSectionSimulcast(e,i.encodings);const n=await this._pc.createOffer();C.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const o={type:"answer",sdp:this._remoteSdp.getSdp()};C.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async setRtpEncodingParameters(e,t){this.assertNotClosed(),this.assertSendDirection(),C.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");const i=r.sender.getParameters();i.encodings.forEach((d,u)=>{i.encodings[u]={...d,...t}}),await r.sender.setParameters(i),this._remoteSdp.muxMediaSectionSimulcast(e,i.encodings);const n=await this._pc.createOffer();C.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const o={type:"answer",sdp:this._remoteSdp.getSdp()};C.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async getSenderStats(e){this.assertNotClosed(),this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:r,label:i,protocol:n}){this.assertNotClosed(),this.assertSendDirection();const o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:r,protocol:n};C.debug("sendDataChannel() [options:%o]",o);const d=this._pc.createDataChannel(i,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%Js.MIS,!this._hasDataChannelMediaSection){const p=await this._pc.createOffer(),a=ge.parse(p.sdp),c=a.media.find(h=>h.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:a}),C.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p),this._remoteSdp.sendSctpAssociation({offerMediaObject:c});const l={type:"answer",sdp:this._remoteSdp.getSdp()};C.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l),this._hasDataChannelMediaSection=!0}const u={streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits};return{dataChannel:d,sctpStreamParameters:u}}async receive(e){this.assertNotClosed(),this.assertRecvDirection();const t=[],r=new Map;for(const d of e){const{trackId:u,kind:p,rtpParameters:a,streamId:c}=d;C.debug("receive() [trackId:%s, kind:%s]",u,p);const l=a.mid||String(this._mapMidTransceiver.size);r.set(u,l),this._remoteSdp.receive({mid:l,kind:p,offerRtpParameters:a,streamId:c||a.rtcp.cname,trackId:u})}const i={type:"offer",sdp:this._remoteSdp.getSdp()};C.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",i),await this._pc.setRemoteDescription(i);let n=await this._pc.createAnswer();const o=ge.parse(n.sdp);for(const d of e){const{trackId:u,rtpParameters:p}=d,a=r.get(u),c=o.media.find(l=>String(l.mid)===a);Kt.applyCodecParameters({offerRtpParameters:p,answerMediaObject:c})}n={type:"answer",sdp:ge.write(o)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:o}),C.debug("receive() | calling pc.setLocalDescription() [answer:%o]",n),await this._pc.setLocalDescription(n);for(const d of e){const{trackId:u}=d,p=r.get(u),a=this._pc.getTransceivers().find(c=>c.mid===p);if(!a)throw new Error("new RTCRtpTransceiver not found");this._mapMidTransceiver.set(p,a),t.push({localId:p,track:a.receiver.track,rtpReceiver:a.receiver})}return t}async stopReceiving(e){if(this.assertRecvDirection(),this._closed)return;for(const i of e){C.debug("stopReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(n.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};C.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();C.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r);for(const i of e)this._mapMidTransceiver.delete(i)}async pauseReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const i of e){C.debug("pauseReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="inactive",this._remoteSdp.pauseMediaSection(i)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};C.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();C.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}async resumeReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const i of e){C.debug("resumeReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(i)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};C.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();C.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}async getReceiverStats(e){this.assertNotClosed(),this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:r}){this.assertNotClosed(),this.assertRecvDirection();const{streamId:i,ordered:n,maxPacketLifeTime:o,maxRetransmits:d}=e,u={negotiated:!0,id:i,ordered:n,maxPacketLifeTime:o,maxRetransmits:d,protocol:r};C.debug("receiveDataChannel() [options:%o]",u);const p=this._pc.createDataChannel(t,u);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const a={type:"offer",sdp:this._remoteSdp.getSdp()};C.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",a),await this._pc.setRemoteDescription(a);const c=await this._pc.createAnswer();if(!this._transportReady){const l=ge.parse(c.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:l})}C.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",c),await this._pc.setLocalDescription(c),this._hasDataChannelMediaSection=!0}return{dataChannel:p}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=ge.parse(this._pc.localDescription.sdp));const r=Kt.extractDtlsParameters({sdpObject:t});r.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((i,n)=>{this.safeEmit("@connect",{dtlsParameters:r},i,n)}),this._transportReady=!0}assertNotClosed(){if(this._closed)throw new Uo.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}pr.Safari12=ts;var lr={},qo=_&&_.__createBinding||(Object.create?function(s,e,t,r){r===void 0&&(r=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(s,r,i)}:function(s,e,t,r){r===void 0&&(r=t),s[r]=e[t]}),Ko=_&&_.__setModuleDefault||(Object.create?function(s,e){Object.defineProperty(s,"default",{enumerable:!0,value:e})}:function(s,e){s.default=e}),Lt=_&&_.__importStar||function(s){if(s&&s.__esModule)return s;var e={};if(s!=null)for(var t in s)t!=="default"&&Object.prototype.hasOwnProperty.call(s,t)&&qo(e,s,t);return Ko(e,s),e};Object.defineProperty(lr,"__esModule",{value:!0});lr.Safari11=void 0;const _e=Lt(Q),Vo=K,Ys=Lt(V),rt=Lt(S),Vt=Lt(Y),Xs=Lt(Te),Qo=te,Wo=se,k=new Vo.Logger("Safari11"),ei={OS:1024,MIS:1024};class rs extends Qo.HandlerInterface{static createFactory(){return()=>new rs}constructor(){super(),this._sendStream=new MediaStream,this._mapSendLocalIdRtpSender=new Map,this._nextSendLocalId=0,this._mapRecvLocalIdInfo=new Map,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return"Safari11"}close(){if(k.debug("close()"),this._pc)try{this._pc.close()}catch{}this.emit("@close")}async getNativeRtpCapabilities(){k.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"});try{const t=await e.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});try{e.close()}catch{}const r=_e.parse(t.sdp);return Vt.extractRtpCapabilities({sdpObject:r})}catch(t){try{e.close()}catch{}throw t}}async getNativeSctpCapabilities(){return k.debug("getNativeSctpCapabilities()"),{numStreams:ei}}run({direction:e,iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n,iceServers:o,iceTransportPolicy:d,additionalSettings:u,proprietaryConstraints:p,extendedRtpCapabilities:a}){k.debug("run()"),this._direction=e,this._remoteSdp=new Wo.RemoteSdp({iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n,planB:!0}),this._sendingRtpParametersByKind={audio:rt.getSendingRtpParameters("audio",a),video:rt.getSendingRtpParameters("video",a)},this._sendingRemoteRtpParametersByKind={audio:rt.getSendingRemoteRtpParameters("audio",a),video:rt.getSendingRemoteRtpParameters("video",a)},i.role&&i.role!=="auto"&&(this._forcedLocalDtlsRole=i.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:o||[],iceTransportPolicy:d||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",...u},p),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(k.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}})}async updateIceServers(e){k.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(k.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});k.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const r={type:"answer",sdp:this._remoteSdp.getSdp()};k.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",r),await this._pc.setRemoteDescription(r)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};k.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();k.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:t,codecOptions:r,codec:i}){this.assertSendDirection(),k.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),i&&k.warn("send() | codec selection is not available in %s handler",this.name),this._sendStream.addTrack(e),this._pc.addTrack(e,this._sendStream);let n=await this._pc.createOffer(),o=_e.parse(n.sdp),d;const u=Ys.clone(this._sendingRtpParametersByKind[e.kind]);u.codecs=rt.reduceCodecs(u.codecs);const p=Ys.clone(this._sendingRemoteRtpParametersByKind[e.kind]);if(p.codecs=rt.reduceCodecs(p.codecs),this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:o}),e.kind==="video"&&t&&t.length>1&&(k.debug("send() | enabling simulcast"),o=_e.parse(n.sdp),d=o.media.find(h=>h.type==="video"),Xs.addLegacySimulcast({offerMediaObject:d,track:e,numStreams:t.length}),n={type:"offer",sdp:_e.write(o)}),k.debug("send() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n),o=_e.parse(this._pc.localDescription.sdp),d=o.media.find(h=>h.type===e.kind),u.rtcp.cname=Vt.getCname({offerMediaObject:d}),u.encodings=Xs.getRtpEncodings({offerMediaObject:d,track:e}),t)for(let h=0;h<u.encodings.length;++h)t[h]&&Object.assign(u.encodings[h],t[h]);if(u.encodings.length>1&&u.codecs[0].mimeType.toLowerCase()==="video/vp8")for(const h of u.encodings)h.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:d,offerRtpParameters:u,answerRtpParameters:p,codecOptions:r});const a={type:"answer",sdp:this._remoteSdp.getSdp()};k.debug("send() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a);const c=String(this._nextSendLocalId);this._nextSendLocalId++;const l=this._pc.getSenders().find(h=>h.track===e);return this._mapSendLocalIdRtpSender.set(c,l),{localId:c,rtpParameters:u,rtpSender:l}}async stopSending(e){this.assertSendDirection();const t=this._mapSendLocalIdRtpSender.get(e);if(!t)throw new Error("associated RTCRtpSender not found");t.track&&this._sendStream.removeTrack(t.track),this._mapSendLocalIdRtpSender.delete(e);const r=await this._pc.createOffer();k.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",r);try{await this._pc.setLocalDescription(r)}catch(n){if(this._sendStream.getTracks().length===0){k.warn("stopSending() | ignoring expected error due no sending tracks: %s",n.toString());return}throw n}if(this._pc.signalingState==="stable")return;const i={type:"answer",sdp:this._remoteSdp.getSdp()};k.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async pauseSending(e){}async resumeSending(e){}async replaceTrack(e,t){this.assertSendDirection(),t?k.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):k.debug("replaceTrack() [localId:%s, no track]",e);const r=this._mapSendLocalIdRtpSender.get(e);if(!r)throw new Error("associated RTCRtpSender not found");const i=r.track;await r.replaceTrack(t),i&&this._sendStream.removeTrack(i),t&&this._sendStream.addTrack(t)}async setMaxSpatialLayer(e,t){this.assertSendDirection(),k.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const r=this._mapSendLocalIdRtpSender.get(e);if(!r)throw new Error("associated RTCRtpSender not found");const i=r.getParameters();i.encodings.forEach((n,o)=>{o<=t?n.active=!0:n.active=!1}),await r.setParameters(i)}async setRtpEncodingParameters(e,t){this.assertSendDirection(),k.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const r=this._mapSendLocalIdRtpSender.get(e);if(!r)throw new Error("associated RTCRtpSender not found");const i=r.getParameters();i.encodings.forEach((n,o)=>{i.encodings[o]={...n,...t}}),await r.setParameters(i)}async getSenderStats(e){this.assertSendDirection();const t=this._mapSendLocalIdRtpSender.get(e);if(!t)throw new Error("associated RTCRtpSender not found");return t.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:r,label:i,protocol:n}){this.assertSendDirection();const o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:r,protocol:n};k.debug("sendDataChannel() [options:%o]",o);const d=this._pc.createDataChannel(i,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%ei.MIS,!this._hasDataChannelMediaSection){const p=await this._pc.createOffer(),a=_e.parse(p.sdp),c=a.media.find(h=>h.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:a}),k.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p),this._remoteSdp.sendSctpAssociation({offerMediaObject:c});const l={type:"answer",sdp:this._remoteSdp.getSdp()};k.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l),this._hasDataChannelMediaSection=!0}const u={streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits};return{dataChannel:d,sctpStreamParameters:u}}async receive(e){this.assertRecvDirection();const t=[];for(const o of e){const{trackId:d,kind:u,rtpParameters:p,streamId:a}=o;k.debug("receive() [trackId:%s, kind:%s]",d,u);const c=u;this._remoteSdp.receive({mid:c,kind:u,offerRtpParameters:p,streamId:a||p.rtcp.cname,trackId:d})}const r={type:"offer",sdp:this._remoteSdp.getSdp()};k.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",r),await this._pc.setRemoteDescription(r);let i=await this._pc.createAnswer();const n=_e.parse(i.sdp);for(const o of e){const{kind:d,rtpParameters:u}=o,p=d,a=n.media.find(c=>String(c.mid)===p);Vt.applyCodecParameters({offerRtpParameters:u,answerMediaObject:a})}i={type:"answer",sdp:_e.write(n)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:n}),k.debug("receive() | calling pc.setLocalDescription() [answer:%o]",i),await this._pc.setLocalDescription(i);for(const o of e){const{kind:d,trackId:u,rtpParameters:p}=o,a=d,c=u,l=this._pc.getReceivers().find(h=>h.track&&h.track.id===c);if(!l)throw new Error("new RTCRtpReceiver not");this._mapRecvLocalIdInfo.set(c,{mid:a,rtpParameters:p,rtpReceiver:l}),t.push({localId:c,track:l.track,rtpReceiver:l})}return t}async stopReceiving(e){this.assertRecvDirection();for(const i of e){k.debug("stopReceiving() [localId:%s]",i);const{mid:n,rtpParameters:o}=this._mapRecvLocalIdInfo.get(i)||{};this._mapRecvLocalIdInfo.delete(i),this._remoteSdp.planBStopReceiving({mid:n,offerRtpParameters:o})}const t={type:"offer",sdp:this._remoteSdp.getSdp()};k.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();k.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}async getReceiverStats(e){this.assertRecvDirection();const{rtpReceiver:t}=this._mapRecvLocalIdInfo.get(e)||{};if(!t)throw new Error("associated RTCRtpReceiver not found");return t.getStats()}async pauseReceiving(e){}async resumeReceiving(e){}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:r}){this.assertRecvDirection();const{streamId:i,ordered:n,maxPacketLifeTime:o,maxRetransmits:d}=e,u={negotiated:!0,id:i,ordered:n,maxPacketLifeTime:o,maxRetransmits:d,protocol:r};k.debug("receiveDataChannel() [options:%o]",u);const p=this._pc.createDataChannel(t,u);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation({oldDataChannelSpec:!0});const a={type:"offer",sdp:this._remoteSdp.getSdp()};k.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",a),await this._pc.setRemoteDescription(a);const c=await this._pc.createAnswer();if(!this._transportReady){const l=_e.parse(c.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:l})}k.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",c),await this._pc.setLocalDescription(c),this._hasDataChannelMediaSection=!0}return{dataChannel:p}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=_e.parse(this._pc.localDescription.sdp));const r=Vt.extractDtlsParameters({sdpObject:t});r.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((i,n)=>{this.safeEmit("@connect",{dtlsParameters:r},i,n)}),this._transportReady=!0}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}lr.Safari11=rs;var ur={},ot={},Zo=_&&_.__createBinding||(Object.create?function(s,e,t,r){r===void 0&&(r=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(s,r,i)}:function(s,e,t,r){r===void 0&&(r=t),s[r]=e[t]}),Jo=_&&_.__setModuleDefault||(Object.create?function(s,e){Object.defineProperty(s,"default",{enumerable:!0,value:e})}:function(s,e){s.default=e}),Yo=_&&_.__importStar||function(s){if(s&&s.__esModule)return s;var e={};if(s!=null)for(var t in s)t!=="default"&&Object.prototype.hasOwnProperty.call(s,t)&&Zo(e,s,t);return Jo(e,s),e};Object.defineProperty(ot,"__esModule",{value:!0});ot.mangleRtpParameters=ot.getCapabilities=void 0;const Mi=Yo(V);function Xo(){const s=RTCRtpReceiver.getCapabilities(),e=Mi.clone(s);for(const t of e.codecs??[]){if(t.channels=t.numChannels,delete t.numChannels,t.mimeType=t.mimeType||`${t.kind}/${t.name}`,t.parameters){const r=t.parameters;r.apt&&(r.apt=Number(r.apt)),r["packetization-mode"]&&(r["packetization-mode"]=Number(r["packetization-mode"]))}for(const r of t.rtcpFeedback||[])r.parameter||(r.parameter="")}return e}ot.getCapabilities=Xo;function ec(s){const e=Mi.clone(s);e.mid&&(e.muxId=e.mid,delete e.mid);for(const t of e.codecs)t.channels&&(t.numChannels=t.channels,delete t.channels),t.mimeType&&!t.name&&(t.name=t.mimeType.split("/")[1]),delete t.mimeType;return e}ot.mangleRtpParameters=ec;var tc=_&&_.__createBinding||(Object.create?function(s,e,t,r){r===void 0&&(r=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(s,r,i)}:function(s,e,t,r){r===void 0&&(r=t),s[r]=e[t]}),rc=_&&_.__setModuleDefault||(Object.create?function(s,e){Object.defineProperty(s,"default",{enumerable:!0,value:e})}:function(s,e){s.default=e}),ss=_&&_.__importStar||function(s){if(s&&s.__esModule)return s;var e={};if(s!=null)for(var t in s)t!=="default"&&Object.prototype.hasOwnProperty.call(s,t)&&tc(e,s,t);return rc(e,s),e};Object.defineProperty(ur,"__esModule",{value:!0});ur.Edge11=void 0;const sc=K,Ir=X,Qt=ss(V),Or=ss(S),kr=ss(ot),ic=te,N=new sc.Logger("Edge11");class is extends ic.HandlerInterface{static createFactory(){return()=>new is}constructor(){super(),this._rtpSenders=new Map,this._rtpReceivers=new Map,this._nextSendLocalId=0,this._transportReady=!1}get name(){return"Edge11"}close(){N.debug("close()");try{this._iceGatherer.close()}catch{}try{this._iceTransport.stop()}catch{}try{this._dtlsTransport.stop()}catch{}for(const e of this._rtpSenders.values())try{e.stop()}catch{}for(const e of this._rtpReceivers.values())try{e.stop()}catch{}this.emit("@close")}async getNativeRtpCapabilities(){return N.debug("getNativeRtpCapabilities()"),kr.getCapabilities()}async getNativeSctpCapabilities(){return N.debug("getNativeSctpCapabilities()"),{numStreams:{OS:0,MIS:0}}}run({direction:e,iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n,iceServers:o,iceTransportPolicy:d,additionalSettings:u,proprietaryConstraints:p,extendedRtpCapabilities:a}){N.debug("run()"),this._sendingRtpParametersByKind={audio:Or.getSendingRtpParameters("audio",a),video:Or.getSendingRtpParameters("video",a)},this._remoteIceParameters=t,this._remoteIceCandidates=r,this._remoteDtlsParameters=i,this._cname=`CNAME-${Qt.generateRandomNumber()}`,this.setIceGatherer({iceServers:o,iceTransportPolicy:d}),this.setIceTransport(),this.setDtlsTransport()}async updateIceServers(e){throw new Ir.UnsupportedError("not supported")}async restartIce(e){if(N.debug("restartIce()"),this._remoteIceParameters=e,!!this._transportReady){N.debug("restartIce() | calling iceTransport.start()"),this._iceTransport.start(this._iceGatherer,e,"controlling");for(const t of this._remoteIceCandidates)this._iceTransport.addRemoteCandidate(t);this._iceTransport.addRemoteCandidate({})}}async getTransportStats(){return this._iceTransport.getStats()}async send({track:e,encodings:t,codecOptions:r,codec:i}){N.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),this._transportReady||await this.setupTransport({localDtlsRole:"server"}),N.debug("send() | calling new RTCRtpSender()");const n=new RTCRtpSender(e,this._dtlsTransport),o=Qt.clone(this._sendingRtpParametersByKind[e.kind]);o.codecs=Or.reduceCodecs(o.codecs,i);const d=o.codecs.some(a=>/.+\/rtx$/i.test(a.mimeType));t||(t=[{}]);for(const a of t)a.ssrc=Qt.generateRandomNumber(),d&&(a.rtx={ssrc:Qt.generateRandomNumber()});o.encodings=t,o.rtcp={cname:this._cname,reducedSize:!0,mux:!0};const u=kr.mangleRtpParameters(o);N.debug("send() | calling rtpSender.send() [params:%o]",u),await n.send(u);const p=String(this._nextSendLocalId);return this._nextSendLocalId++,this._rtpSenders.set(p,n),{localId:p,rtpParameters:o,rtpSender:n}}async stopSending(e){N.debug("stopSending() [localId:%s]",e);const t=this._rtpSenders.get(e);if(!t)throw new Error("RTCRtpSender not found");this._rtpSenders.delete(e);try{N.debug("stopSending() | calling rtpSender.stop()"),t.stop()}catch(r){throw N.warn("stopSending() | rtpSender.stop() failed:%o",r),r}}async pauseSending(e){}async resumeSending(e){}async replaceTrack(e,t){t?N.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):N.debug("replaceTrack() [localId:%s, no track]",e);const r=this._rtpSenders.get(e);if(!r)throw new Error("RTCRtpSender not found");r.setTrack(t)}async setMaxSpatialLayer(e,t){N.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const r=this._rtpSenders.get(e);if(!r)throw new Error("RTCRtpSender not found");const i=r.getParameters();i.encodings.forEach((n,o)=>{o<=t?n.active=!0:n.active=!1}),await r.setParameters(i)}async setRtpEncodingParameters(e,t){N.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const r=this._rtpSenders.get(e);if(!r)throw new Error("RTCRtpSender not found");const i=r.getParameters();i.encodings.forEach((n,o)=>{i.encodings[o]={...n,...t}}),await r.setParameters(i)}async getSenderStats(e){const t=this._rtpSenders.get(e);if(!t)throw new Error("RTCRtpSender not found");return t.getStats()}async sendDataChannel(e){throw new Ir.UnsupportedError("not implemented")}async receive(e){const t=[];for(const r of e){const{trackId:i,kind:n}=r;N.debug("receive() [trackId:%s, kind:%s]",i,n)}this._transportReady||await this.setupTransport({localDtlsRole:"server"});for(const r of e){const{trackId:i,kind:n,rtpParameters:o}=r;N.debug("receive() | calling new RTCRtpReceiver()");const d=new RTCRtpReceiver(this._dtlsTransport,n);d.addEventListener("error",a=>{N.error('rtpReceiver "error" event [event:%o]',a)});const u=kr.mangleRtpParameters(o);N.debug("receive() | calling rtpReceiver.receive() [params:%o]",u),await d.receive(u);const p=i;this._rtpReceivers.set(p,d),t.push({localId:p,track:d.track,rtpReceiver:d})}return t}async stopReceiving(e){for(const t of e){N.debug("stopReceiving() [localId:%s]",t);const r=this._rtpReceivers.get(t);if(!r)throw new Error("RTCRtpReceiver not found");this._rtpReceivers.delete(t);try{N.debug("stopReceiving() | calling rtpReceiver.stop()"),r.stop()}catch(i){N.warn("stopReceiving() | rtpReceiver.stop() failed:%o",i)}}}async pauseReceiving(e){}async resumeReceiving(e){}async getReceiverStats(e){const t=this._rtpReceivers.get(e);if(!t)throw new Error("RTCRtpReceiver not found");return t.getStats()}async receiveDataChannel(e){throw new Ir.UnsupportedError("not implemented")}setIceGatherer({iceServers:e,iceTransportPolicy:t}){const r=new RTCIceGatherer({iceServers:e||[],gatherPolicy:t||"all"});r.addEventListener("error",i=>{N.error('iceGatherer "error" event [event:%o]',i)});try{r.gather()}catch(i){N.debug("setIceGatherer() | iceGatherer.gather() failed: %s",i.toString())}this._iceGatherer=r}setIceTransport(){const e=new RTCIceTransport(this._iceGatherer);e.addEventListener("statechange",()=>{switch(e.state){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}}),e.addEventListener("icestatechange",()=>{switch(e.state){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}}),e.addEventListener("candidatepairchange",t=>{N.debug('iceTransport "candidatepairchange" event [pair:%o]',t.pair)}),this._iceTransport=e}setDtlsTransport(){const e=new RTCDtlsTransport(this._iceTransport);e.addEventListener("statechange",()=>{N.debug('dtlsTransport "statechange" event [state:%s]',e.state)}),e.addEventListener("dtlsstatechange",()=>{N.debug('dtlsTransport "dtlsstatechange" event [state:%s]',e.state),e.state==="closed"&&this.emit("@connectionstatechange","closed")}),e.addEventListener("error",t=>{N.error('dtlsTransport "error" event [event:%o]',t)}),this._dtlsTransport=e}async setupTransport({localDtlsRole:e}){N.debug("setupTransport()");const t=this._dtlsTransport.getLocalParameters();t.role=e,await new Promise((r,i)=>{this.safeEmit("@connect",{dtlsParameters:t},r,i)}),this._iceTransport.start(this._iceGatherer,this._remoteIceParameters,"controlling");for(const r of this._remoteIceCandidates)this._iceTransport.addRemoteCandidate(r);this._iceTransport.addRemoteCandidate({}),this._remoteDtlsParameters.fingerprints=this._remoteDtlsParameters.fingerprints.filter(r=>r.algorithm==="sha-256"||r.algorithm==="sha-384"||r.algorithm==="sha-512"),this._dtlsTransport.start(this._remoteDtlsParameters),this._transportReady=!0}}ur.Edge11=is;var hr={},nc=_&&_.__createBinding||(Object.create?function(s,e,t,r){r===void 0&&(r=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(s,r,i)}:function(s,e,t,r){r===void 0&&(r=t),s[r]=e[t]}),ac=_&&_.__setModuleDefault||(Object.create?function(s,e){Object.defineProperty(s,"default",{enumerable:!0,value:e})}:function(s,e){s.default=e}),lt=_&&_.__importStar||function(s){if(s&&s.__esModule)return s;var e={};if(s!=null)for(var t in s)t!=="default"&&Object.prototype.hasOwnProperty.call(s,t)&&nc(e,s,t);return ac(e,s),e};Object.defineProperty(hr,"__esModule",{value:!0});hr.ReactNativeUnifiedPlan=void 0;const we=lt(Q),oc=K,ti=lt(V),st=lt(S),Wt=lt(Y),jr=lt(oe),cc=lt(Be),dc=X,pc=te,lc=se,uc=Se,y=new oc.Logger("ReactNativeUnifiedPlan"),ri={OS:1024,MIS:1024};class ns extends pc.HandlerInterface{static createFactory(){return()=>new ns}constructor(){super(),this._closed=!1,this._mapMidTransceiver=new Map,this._sendStream=new MediaStream,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return"ReactNativeUnifiedPlan"}close(){if(y.debug("close()"),!this._closed){if(this._closed=!0,this._sendStream.release(!1),this._pc)try{this._pc.close()}catch{}this.emit("@close")}}async getNativeRtpCapabilities(){y.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan"});try{e.addTransceiver("audio"),e.addTransceiver("video");const t=await e.createOffer();try{e.close()}catch{}const r=we.parse(t.sdp),i=Wt.extractRtpCapabilities({sdpObject:r});return cc.addNackSuppportForOpus(i),i}catch(t){try{e.close()}catch{}throw t}}async getNativeSctpCapabilities(){return y.debug("getNativeSctpCapabilities()"),{numStreams:ri}}run({direction:e,iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n,iceServers:o,iceTransportPolicy:d,additionalSettings:u,proprietaryConstraints:p,extendedRtpCapabilities:a}){this.assertNotClosed(),y.debug("run()"),this._direction=e,this._remoteSdp=new lc.RemoteSdp({iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n}),this._sendingRtpParametersByKind={audio:st.getSendingRtpParameters("audio",a),video:st.getSendingRtpParameters("video",a)},this._sendingRemoteRtpParametersByKind={audio:st.getSendingRemoteRtpParameters("audio",a),video:st.getSendingRemoteRtpParameters("video",a)},i.role&&i.role!=="auto"&&(this._forcedLocalDtlsRole=i.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:o||[],iceTransportPolicy:d||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"unified-plan",...u},p),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(y.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}})}async updateIceServers(e){this.assertNotClosed(),y.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(this.assertNotClosed(),y.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});y.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const r={type:"answer",sdp:this._remoteSdp.getSdp()};y.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",r),await this._pc.setRemoteDescription(r)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};y.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();y.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}}async getTransportStats(){return this.assertNotClosed(),this._pc.getStats()}async send({track:e,encodings:t,codecOptions:r,codec:i}){this.assertNotClosed(),this.assertSendDirection(),y.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),t&&t.length>1&&t.forEach((f,w)=>{f.rid=`r${w}`});const n=ti.clone(this._sendingRtpParametersByKind[e.kind]);n.codecs=st.reduceCodecs(n.codecs,i);const o=ti.clone(this._sendingRemoteRtpParametersByKind[e.kind]);o.codecs=st.reduceCodecs(o.codecs,i);const d=this._remoteSdp.getNextMediaSectionIdx(),u=this._pc.addTransceiver(e,{direction:"sendonly",streams:[this._sendStream],sendEncodings:t});let p=await this._pc.createOffer(),a=we.parse(p.sdp),c;this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:a});let l=!1;const h=(0,uc.parse)((t||[{}])[0].scalabilityMode);t&&t.length===1&&h.spatialLayers>1&&n.codecs[0].mimeType.toLowerCase()==="video/vp9"&&(y.debug("send() | enabling legacy simulcast for VP9 SVC"),l=!0,a=we.parse(p.sdp),c=a.media[d.idx],jr.addLegacySimulcast({offerMediaObject:c,numStreams:h.spatialLayers}),p={type:"offer",sdp:we.write(a)}),y.debug("send() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p);let m=u.mid??void 0;if(m||y.warn("send() | missing transceiver.mid (bug in react-native-webrtc, using a workaround"),n.mid=m,a=we.parse(this._pc.localDescription.sdp),c=a.media[d.idx],n.rtcp.cname=Wt.getCname({offerMediaObject:c}),!t)n.encodings=jr.getRtpEncodings({offerMediaObject:c});else if(t.length===1){let f=jr.getRtpEncodings({offerMediaObject:c});Object.assign(f[0],t[0]),l&&(f=[f[0]]),n.encodings=f}else n.encodings=t;if(n.encodings.length>1&&(n.codecs[0].mimeType.toLowerCase()==="video/vp8"||n.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const f of n.encodings)f.scalabilityMode?f.scalabilityMode=`L1T${h.temporalLayers}`:f.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:c,reuseMid:d.reuseMid,offerRtpParameters:n,answerRtpParameters:o,codecOptions:r,extmapAllowMixed:!0});const g={type:"answer",sdp:this._remoteSdp.getSdp()};return y.debug("send() | calling pc.setRemoteDescription() [answer:%o]",g),await this._pc.setRemoteDescription(g),m||(m=u.mid,n.mid=m),this._mapMidTransceiver.set(m,u),{localId:m,rtpParameters:n,rtpSender:u.sender}}async stopSending(e){if(this.assertSendDirection(),this._closed)return;y.debug("stopSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");if(t.sender.replaceTrack(null),this._pc.removeTrack(t.sender),this._remoteSdp.closeMediaSection(t.mid))try{t.stop()}catch{}const i=await this._pc.createOffer();y.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",i),await this._pc.setLocalDescription(i);const n={type:"answer",sdp:this._remoteSdp.getSdp()};y.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",n),await this._pc.setRemoteDescription(n),this._mapMidTransceiver.delete(e)}async pauseSending(e){this.assertNotClosed(),this.assertSendDirection(),y.debug("pauseSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="inactive",this._remoteSdp.pauseMediaSection(e);const r=await this._pc.createOffer();y.debug("pauseSending() | calling pc.setLocalDescription() [offer:%o]",r),await this._pc.setLocalDescription(r);const i={type:"answer",sdp:this._remoteSdp.getSdp()};y.debug("pauseSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async resumeSending(e){this.assertNotClosed(),this.assertSendDirection(),y.debug("resumeSending() [localId:%s]",e);const t=this._mapMidTransceiver.get(e);if(this._remoteSdp.resumeSendingMediaSection(e),!t)throw new Error("associated RTCRtpTransceiver not found");t.direction="sendonly";const r=await this._pc.createOffer();y.debug("resumeSending() | calling pc.setLocalDescription() [offer:%o]",r),await this._pc.setLocalDescription(r);const i={type:"answer",sdp:this._remoteSdp.getSdp()};y.debug("resumeSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async replaceTrack(e,t){this.assertNotClosed(),this.assertSendDirection(),t?y.debug("replaceTrack() [localId:%s, track.id:%s]",e,t.id):y.debug("replaceTrack() [localId:%s, no track]",e);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");await r.sender.replaceTrack(t)}async setMaxSpatialLayer(e,t){this.assertNotClosed(),this.assertSendDirection(),y.debug("setMaxSpatialLayer() [localId:%s, spatialLayer:%s]",e,t);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");const i=r.sender.getParameters();i.encodings.forEach((d,u)=>{u<=t?d.active=!0:d.active=!1}),await r.sender.setParameters(i),this._remoteSdp.muxMediaSectionSimulcast(e,i.encodings);const n=await this._pc.createOffer();y.debug("setMaxSpatialLayer() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const o={type:"answer",sdp:this._remoteSdp.getSdp()};y.debug("setMaxSpatialLayer() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async setRtpEncodingParameters(e,t){this.assertNotClosed(),this.assertSendDirection(),y.debug("setRtpEncodingParameters() [localId:%s, params:%o]",e,t);const r=this._mapMidTransceiver.get(e);if(!r)throw new Error("associated RTCRtpTransceiver not found");const i=r.sender.getParameters();i.encodings.forEach((d,u)=>{i.encodings[u]={...d,...t}}),await r.sender.setParameters(i),this._remoteSdp.muxMediaSectionSimulcast(e,i.encodings);const n=await this._pc.createOffer();y.debug("setRtpEncodingParameters() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n);const o={type:"answer",sdp:this._remoteSdp.getSdp()};y.debug("setRtpEncodingParameters() | calling pc.setRemoteDescription() [answer:%o]",o),await this._pc.setRemoteDescription(o)}async getSenderStats(e){this.assertNotClosed(),this.assertSendDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.sender.getStats()}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:r,label:i,protocol:n}){this.assertNotClosed(),this.assertSendDirection();const o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmits:r,protocol:n};y.debug("sendDataChannel() [options:%o]",o);const d=this._pc.createDataChannel(i,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%ri.MIS,!this._hasDataChannelMediaSection){const p=await this._pc.createOffer(),a=we.parse(p.sdp),c=a.media.find(h=>h.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:a}),y.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p),this._remoteSdp.sendSctpAssociation({offerMediaObject:c});const l={type:"answer",sdp:this._remoteSdp.getSdp()};y.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l),this._hasDataChannelMediaSection=!0}const u={streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits};return{dataChannel:d,sctpStreamParameters:u}}async receive(e){this.assertNotClosed(),this.assertRecvDirection();const t=[],r=new Map;for(const d of e){const{trackId:u,kind:p,rtpParameters:a,streamId:c}=d;y.debug("receive() [trackId:%s, kind:%s]",u,p);const l=a.mid||String(this._mapMidTransceiver.size);r.set(u,l),this._remoteSdp.receive({mid:l,kind:p,offerRtpParameters:a,streamId:c||a.rtcp.cname,trackId:u})}const i={type:"offer",sdp:this._remoteSdp.getSdp()};y.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",i),await this._pc.setRemoteDescription(i);let n=await this._pc.createAnswer();const o=we.parse(n.sdp);for(const d of e){const{trackId:u,rtpParameters:p}=d,a=r.get(u),c=o.media.find(l=>String(l.mid)===a);Wt.applyCodecParameters({offerRtpParameters:p,answerMediaObject:c})}n={type:"answer",sdp:we.write(o)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:o}),y.debug("receive() | calling pc.setLocalDescription() [answer:%o]",n),await this._pc.setLocalDescription(n);for(const d of e){const{trackId:u}=d,p=r.get(u),a=this._pc.getTransceivers().find(c=>c.mid===p);if(a)this._mapMidTransceiver.set(p,a),t.push({localId:p,track:a.receiver.track,rtpReceiver:a.receiver});else throw new Error("new RTCRtpTransceiver not found")}return t}async stopReceiving(e){if(this.assertRecvDirection(),this._closed)return;for(const i of e){y.debug("stopReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");this._remoteSdp.closeMediaSection(n.mid)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};y.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();y.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r);for(const i of e)this._mapMidTransceiver.delete(i)}async pauseReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const i of e){y.debug("pauseReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="inactive",this._remoteSdp.pauseMediaSection(i)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};y.debug("pauseReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();y.debug("pauseReceiving() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}async resumeReceiving(e){this.assertNotClosed(),this.assertRecvDirection();for(const i of e){y.debug("resumeReceiving() [localId:%s]",i);const n=this._mapMidTransceiver.get(i);if(!n)throw new Error("associated RTCRtpTransceiver not found");n.direction="recvonly",this._remoteSdp.resumeReceivingMediaSection(i)}const t={type:"offer",sdp:this._remoteSdp.getSdp()};y.debug("resumeReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();y.debug("resumeReceiving() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}async getReceiverStats(e){this.assertNotClosed(),this.assertRecvDirection();const t=this._mapMidTransceiver.get(e);if(!t)throw new Error("associated RTCRtpTransceiver not found");return t.receiver.getStats()}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:r}){this.assertNotClosed(),this.assertRecvDirection();const{streamId:i,ordered:n,maxPacketLifeTime:o,maxRetransmits:d}=e,u={negotiated:!0,id:i,ordered:n,maxPacketLifeTime:o,maxRetransmits:d,protocol:r};y.debug("receiveDataChannel() [options:%o]",u);const p=this._pc.createDataChannel(t,u);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation();const a={type:"offer",sdp:this._remoteSdp.getSdp()};y.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",a),await this._pc.setRemoteDescription(a);const c=await this._pc.createAnswer();if(!this._transportReady){const l=we.parse(c.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:l})}y.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",c),await this._pc.setLocalDescription(c),this._hasDataChannelMediaSection=!0}return{dataChannel:p}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=we.parse(this._pc.localDescription.sdp));const r=Wt.extractDtlsParameters({sdpObject:t});r.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((i,n)=>{this.safeEmit("@connect",{dtlsParameters:r},i,n)}),this._transportReady=!0}assertNotClosed(){if(this._closed)throw new dc.InvalidStateError("method called in a closed handler")}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}hr.ReactNativeUnifiedPlan=ns;var fr={},hc=_&&_.__createBinding||(Object.create?function(s,e,t,r){r===void 0&&(r=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(s,r,i)}:function(s,e,t,r){r===void 0&&(r=t),s[r]=e[t]}),fc=_&&_.__setModuleDefault||(Object.create?function(s,e){Object.defineProperty(s,"default",{enumerable:!0,value:e})}:function(s,e){s.default=e}),xt=_&&_.__importStar||function(s){if(s&&s.__esModule)return s;var e={};if(s!=null)for(var t in s)t!=="default"&&Object.prototype.hasOwnProperty.call(s,t)&&hc(e,s,t);return fc(e,s),e};Object.defineProperty(fr,"__esModule",{value:!0});fr.ReactNative=void 0;const ve=xt(Q),mc=K,_t=X,Fr=xt(V),it=xt(S),Zt=xt(Y),si=xt(Te),gc=te,_c=se,j=new mc.Logger("ReactNative"),ii={OS:1024,MIS:1024};class as extends gc.HandlerInterface{static createFactory(){return()=>new as}constructor(){super(),this._sendStream=new MediaStream,this._mapSendLocalIdTrack=new Map,this._nextSendLocalId=0,this._mapRecvLocalIdInfo=new Map,this._hasDataChannelMediaSection=!1,this._nextSendSctpStreamId=0,this._transportReady=!1}get name(){return"ReactNative"}close(){if(j.debug("close()"),this._sendStream.release(!1),this._pc)try{this._pc.close()}catch{}this.emit("@close")}async getNativeRtpCapabilities(){j.debug("getNativeRtpCapabilities()");const e=new RTCPeerConnection({iceServers:[],iceTransportPolicy:"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b"});try{const t=await e.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});try{e.close()}catch{}const r=ve.parse(t.sdp);return Zt.extractRtpCapabilities({sdpObject:r})}catch(t){try{e.close()}catch{}throw t}}async getNativeSctpCapabilities(){return j.debug("getNativeSctpCapabilities()"),{numStreams:ii}}run({direction:e,iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n,iceServers:o,iceTransportPolicy:d,additionalSettings:u,proprietaryConstraints:p,extendedRtpCapabilities:a}){j.debug("run()"),this._direction=e,this._remoteSdp=new _c.RemoteSdp({iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n,planB:!0}),this._sendingRtpParametersByKind={audio:it.getSendingRtpParameters("audio",a),video:it.getSendingRtpParameters("video",a)},this._sendingRemoteRtpParametersByKind={audio:it.getSendingRemoteRtpParameters("audio",a),video:it.getSendingRemoteRtpParameters("video",a)},i.role&&i.role!=="auto"&&(this._forcedLocalDtlsRole=i.role==="server"?"client":"server"),this._pc=new RTCPeerConnection({iceServers:o||[],iceTransportPolicy:d||"all",bundlePolicy:"max-bundle",rtcpMuxPolicy:"require",sdpSemantics:"plan-b",...u},p),this._pc.addEventListener("icegatheringstatechange",()=>{this.emit("@icegatheringstatechange",this._pc.iceGatheringState)}),this._pc.connectionState?this._pc.addEventListener("connectionstatechange",()=>{this.emit("@connectionstatechange",this._pc.connectionState)}):this._pc.addEventListener("iceconnectionstatechange",()=>{switch(j.warn("run() | pc.connectionState not supported, using pc.iceConnectionState"),this._pc.iceConnectionState){case"checking":{this.emit("@connectionstatechange","connecting");break}case"connected":case"completed":{this.emit("@connectionstatechange","connected");break}case"failed":{this.emit("@connectionstatechange","failed");break}case"disconnected":{this.emit("@connectionstatechange","disconnected");break}case"closed":{this.emit("@connectionstatechange","closed");break}}})}async updateIceServers(e){j.debug("updateIceServers()");const t=this._pc.getConfiguration();t.iceServers=e,this._pc.setConfiguration(t)}async restartIce(e){if(j.debug("restartIce()"),this._remoteSdp.updateIceParameters(e),!!this._transportReady)if(this._direction==="send"){const t=await this._pc.createOffer({iceRestart:!0});j.debug("restartIce() | calling pc.setLocalDescription() [offer:%o]",t),await this._pc.setLocalDescription(t);const r={type:"answer",sdp:this._remoteSdp.getSdp()};j.debug("restartIce() | calling pc.setRemoteDescription() [answer:%o]",r),await this._pc.setRemoteDescription(r)}else{const t={type:"offer",sdp:this._remoteSdp.getSdp()};j.debug("restartIce() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();j.debug("restartIce() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}}async getTransportStats(){return this._pc.getStats()}async send({track:e,encodings:t,codecOptions:r,codec:i}){this.assertSendDirection(),j.debug("send() [kind:%s, track.id:%s]",e.kind,e.id),i&&j.warn("send() | codec selection is not available in %s handler",this.name),this._sendStream.addTrack(e),this._pc.addStream(this._sendStream);let n=await this._pc.createOffer(),o=ve.parse(n.sdp),d;const u=Fr.clone(this._sendingRtpParametersByKind[e.kind]);u.codecs=it.reduceCodecs(u.codecs);const p=Fr.clone(this._sendingRemoteRtpParametersByKind[e.kind]);if(p.codecs=it.reduceCodecs(p.codecs),this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:o}),e.kind==="video"&&t&&t.length>1&&(j.debug("send() | enabling simulcast"),o=ve.parse(n.sdp),d=o.media.find(l=>l.type==="video"),si.addLegacySimulcast({offerMediaObject:d,track:e,numStreams:t.length}),n={type:"offer",sdp:ve.write(o)}),j.debug("send() | calling pc.setLocalDescription() [offer:%o]",n),await this._pc.setLocalDescription(n),o=ve.parse(this._pc.localDescription.sdp),d=o.media.find(l=>l.type===e.kind),u.rtcp.cname=Zt.getCname({offerMediaObject:d}),u.encodings=si.getRtpEncodings({offerMediaObject:d,track:e}),t)for(let l=0;l<u.encodings.length;++l)t[l]&&Object.assign(u.encodings[l],t[l]);if(u.encodings.length>1&&(u.codecs[0].mimeType.toLowerCase()==="video/vp8"||u.codecs[0].mimeType.toLowerCase()==="video/h264"))for(const l of u.encodings)l.scalabilityMode="L1T3";this._remoteSdp.send({offerMediaObject:d,offerRtpParameters:u,answerRtpParameters:p,codecOptions:r});const a={type:"answer",sdp:this._remoteSdp.getSdp()};j.debug("send() | calling pc.setRemoteDescription() [answer:%o]",a),await this._pc.setRemoteDescription(a);const c=String(this._nextSendLocalId);return this._nextSendLocalId++,this._mapSendLocalIdTrack.set(c,e),{localId:c,rtpParameters:u}}async stopSending(e){this.assertSendDirection(),j.debug("stopSending() [localId:%s]",e);const t=this._mapSendLocalIdTrack.get(e);if(!t)throw new Error("track not found");this._mapSendLocalIdTrack.delete(e),this._sendStream.removeTrack(t),this._pc.addStream(this._sendStream);const r=await this._pc.createOffer();j.debug("stopSending() | calling pc.setLocalDescription() [offer:%o]",r);try{await this._pc.setLocalDescription(r)}catch(n){if(this._sendStream.getTracks().length===0){j.warn("stopSending() | ignoring expected error due no sending tracks: %s",n.toString());return}throw n}if(this._pc.signalingState==="stable")return;const i={type:"answer",sdp:this._remoteSdp.getSdp()};j.debug("stopSending() | calling pc.setRemoteDescription() [answer:%o]",i),await this._pc.setRemoteDescription(i)}async pauseSending(e){}async resumeSending(e){}async replaceTrack(e,t){throw new _t.UnsupportedError("not implemented")}async setMaxSpatialLayer(e,t){throw new _t.UnsupportedError("not implemented")}async setRtpEncodingParameters(e,t){throw new _t.UnsupportedError("not implemented")}async getSenderStats(e){throw new _t.UnsupportedError("not implemented")}async sendDataChannel({ordered:e,maxPacketLifeTime:t,maxRetransmits:r,label:i,protocol:n}){this.assertSendDirection();const o={negotiated:!0,id:this._nextSendSctpStreamId,ordered:e,maxPacketLifeTime:t,maxRetransmitTime:t,maxRetransmits:r,protocol:n};j.debug("sendDataChannel() [options:%o]",o);const d=this._pc.createDataChannel(i,o);if(this._nextSendSctpStreamId=++this._nextSendSctpStreamId%ii.MIS,!this._hasDataChannelMediaSection){const p=await this._pc.createOffer(),a=ve.parse(p.sdp),c=a.media.find(h=>h.type==="application");this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:a}),j.debug("sendDataChannel() | calling pc.setLocalDescription() [offer:%o]",p),await this._pc.setLocalDescription(p),this._remoteSdp.sendSctpAssociation({offerMediaObject:c});const l={type:"answer",sdp:this._remoteSdp.getSdp()};j.debug("sendDataChannel() | calling pc.setRemoteDescription() [answer:%o]",l),await this._pc.setRemoteDescription(l),this._hasDataChannelMediaSection=!0}const u={streamId:o.id,ordered:o.ordered,maxPacketLifeTime:o.maxPacketLifeTime,maxRetransmits:o.maxRetransmits};return{dataChannel:d,sctpStreamParameters:u}}async receive(e){this.assertRecvDirection();const t=[],r=new Map;for(const d of e){const{trackId:u,kind:p,rtpParameters:a}=d;j.debug("receive() [trackId:%s, kind:%s]",u,p);const c=p;let l=d.streamId||a.rtcp.cname;j.debug("receive() | forcing a random remote streamId to avoid well known bug in react-native-webrtc"),l+=`-hack-${Fr.generateRandomNumber()}`,r.set(u,l),this._remoteSdp.receive({mid:c,kind:p,offerRtpParameters:a,streamId:l,trackId:u})}const i={type:"offer",sdp:this._remoteSdp.getSdp()};j.debug("receive() | calling pc.setRemoteDescription() [offer:%o]",i),await this._pc.setRemoteDescription(i);let n=await this._pc.createAnswer();const o=ve.parse(n.sdp);for(const d of e){const{kind:u,rtpParameters:p}=d,a=u,c=o.media.find(l=>String(l.mid)===a);Zt.applyCodecParameters({offerRtpParameters:p,answerMediaObject:c})}n={type:"answer",sdp:ve.write(o)},this._transportReady||await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:o}),j.debug("receive() | calling pc.setLocalDescription() [answer:%o]",n),await this._pc.setLocalDescription(n);for(const d of e){const{kind:u,trackId:p,rtpParameters:a}=d,c=p,l=u,h=r.get(p),g=this._pc.getRemoteStreams().find(f=>f.id===h).getTrackById(c);if(!g)throw new Error("remote track not found");this._mapRecvLocalIdInfo.set(c,{mid:l,rtpParameters:a}),t.push({localId:c,track:g})}return t}async stopReceiving(e){this.assertRecvDirection();for(const i of e){j.debug("stopReceiving() [localId:%s]",i);const{mid:n,rtpParameters:o}=this._mapRecvLocalIdInfo.get(i)||{};this._mapRecvLocalIdInfo.delete(i),this._remoteSdp.planBStopReceiving({mid:n,offerRtpParameters:o})}const t={type:"offer",sdp:this._remoteSdp.getSdp()};j.debug("stopReceiving() | calling pc.setRemoteDescription() [offer:%o]",t),await this._pc.setRemoteDescription(t);const r=await this._pc.createAnswer();j.debug("stopReceiving() | calling pc.setLocalDescription() [answer:%o]",r),await this._pc.setLocalDescription(r)}async pauseReceiving(e){}async resumeReceiving(e){}async getReceiverStats(e){throw new _t.UnsupportedError("not implemented")}async receiveDataChannel({sctpStreamParameters:e,label:t,protocol:r}){this.assertRecvDirection();const{streamId:i,ordered:n,maxPacketLifeTime:o,maxRetransmits:d}=e,u={negotiated:!0,id:i,ordered:n,maxPacketLifeTime:o,maxRetransmitTime:o,maxRetransmits:d,protocol:r};j.debug("receiveDataChannel() [options:%o]",u);const p=this._pc.createDataChannel(t,u);if(!this._hasDataChannelMediaSection){this._remoteSdp.receiveSctpAssociation({oldDataChannelSpec:!0});const a={type:"offer",sdp:this._remoteSdp.getSdp()};j.debug("receiveDataChannel() | calling pc.setRemoteDescription() [offer:%o]",a),await this._pc.setRemoteDescription(a);const c=await this._pc.createAnswer();if(!this._transportReady){const l=ve.parse(c.sdp);await this.setupTransport({localDtlsRole:this._forcedLocalDtlsRole??"client",localSdpObject:l})}j.debug("receiveDataChannel() | calling pc.setRemoteDescription() [answer:%o]",c),await this._pc.setLocalDescription(c),this._hasDataChannelMediaSection=!0}return{dataChannel:p}}async setupTransport({localDtlsRole:e,localSdpObject:t}){t||(t=ve.parse(this._pc.localDescription.sdp));const r=Zt.extractDtlsParameters({sdpObject:t});r.role=e,this._remoteSdp.updateDtlsRole(e==="client"?"server":"client"),await new Promise((i,n)=>{this.safeEmit("@connect",{dtlsParameters:r},i,n)}),this._transportReady=!0}assertSendDirection(){if(this._direction!=="send")throw new Error('method can just be called for handlers with "send" direction')}assertRecvDirection(){if(this._direction!=="recv")throw new Error('method can just be called for handlers with "recv" direction')}}fr.ReactNative=as;var wc=_&&_.__createBinding||(Object.create?function(s,e,t,r){r===void 0&&(r=t);var i=Object.getOwnPropertyDescriptor(e,t);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[t]}}),Object.defineProperty(s,r,i)}:function(s,e,t,r){r===void 0&&(r=t),s[r]=e[t]}),vc=_&&_.__setModuleDefault||(Object.create?function(s,e){Object.defineProperty(s,"default",{enumerable:!0,value:e})}:function(s,e){s.default=e}),Ii=_&&_.__importStar||function(s){if(s&&s.__esModule)return s;var e={};if(s!=null)for(var t in s)t!=="default"&&Object.prototype.hasOwnProperty.call(s,t)&&wc(e,s,t);return vc(e,s),e};Object.defineProperty(Ne,"__esModule",{value:!0});Ne.Device=Ne.detectDevice=void 0;const bc=Ki,Sc=K,yc=be,nt=X,Rc=Ii(V),Ie=Ii(S),Cc=bt,Dc=ir,Tc=nr,Pc=ar,Ec=or,Lc=cr,xc=dr,Mc=pr,Ic=lr,Oc=ur,kc=hr,jc=fr,J=new Sc.Logger("Device");function Oi(){var s,e,t,r;if(typeof navigator=="object"&&navigator.product==="ReactNative"){if(J.debug("detectDevice() | React-Native detected"),typeof RTCPeerConnection>"u"){J.warn("detectDevice() | unsupported react-native-webrtc without RTCPeerConnection, forgot to call registerGlobals()?");return}return typeof RTCRtpTransceiver<"u"?(J.debug("detectDevice() | ReactNative UnifiedPlan handler chosen"),"ReactNativeUnifiedPlan"):(J.debug("detectDevice() | ReactNative PlanB handler chosen"),"ReactNative")}else if(typeof navigator=="object"&&typeof navigator.userAgent=="string"){const i=navigator.userAgent,n=new bc.UAParser(i);J.debug("detectDevice() | browser detected [ua:%s, parsed:%o]",i,n.getResult());const o=n.getBrowser(),d=(s=o.name)==null?void 0:s.toLowerCase(),u=parseInt(o.major??"0"),a=(e=n.getEngine().name)==null?void 0:e.toLowerCase(),c=n.getOS(),l=(t=c.name)==null?void 0:t.toLowerCase(),h=parseFloat(c.version??"0"),g=(r=n.getDevice().model)==null?void 0:r.toLowerCase(),f=l==="ios"||g==="ipad",w=d&&["chrome","chromium","mobile chrome","chrome webview","chrome headless"].includes(d),I=d&&["firefox","mobile firefox","mobile focus"].includes(d),v=d&&["safari","mobile safari"].includes(d),b=d&&["edge"].includes(d);if((w||b)&&!f&&u>=111)return"Chrome111";if(w&&!f&&u>=74||b&&!f&&u>=88)return"Chrome74";if(w&&!f&&u>=70)return"Chrome70";if(w&&!f&&u>=67)return"Chrome67";if(w&&!f&&u>=55)return"Chrome55";if(I&&!f&&u>=60)return"Firefox60";if(I&&f&&h>=14.3)return"Safari12";if(v&&u>=12&&typeof RTCRtpTransceiver<"u"&&RTCRtpTransceiver.prototype.hasOwnProperty("currentDirection"))return"Safari12";if(v&&u>=11)return"Safari11";if(b&&!f&&u>=11&&u<=18)return"Edge11";if(a==="webkit"&&f&&typeof RTCRtpTransceiver<"u"&&RTCRtpTransceiver.prototype.hasOwnProperty("currentDirection"))return"Safari12";if(a==="blink"){const G=i.match(/(?:(?:Chrome|Chromium))[ /](\w+)/i);if(G){const U=Number(G[1]);return U>=111?"Chrome111":U>=74?"Chrome74":U>=70?"Chrome70":U>=67?"Chrome67":"Chrome55"}else return"Chrome111"}else{J.warn("detectDevice() | browser not supported [name:%s, version:%s]",d,u);return}}else{J.warn("detectDevice() | unknown device");return}}Ne.detectDevice=Oi;class Fc{constructor({handlerName:e,handlerFactory:t,Handler:r}={}){if(this._loaded=!1,this._observer=new yc.EnhancedEventEmitter,J.debug("constructor()"),r)if(J.warn("constructor() | Handler option is DEPRECATED, use handlerName or handlerFactory instead"),typeof r=="string")e=r;else throw new TypeError("non string Handler option no longer supported, use handlerFactory instead");if(e&&t)throw new TypeError("just one of handlerName or handlerInterface can be given");if(t)this._handlerFactory=t;else{if(e)J.debug("constructor() | handler given: %s",e);else if(e=Oi(),e)J.debug("constructor() | detected handler: %s",e);else throw new nt.UnsupportedError("device not supported");switch(e){case"Chrome111":{this._handlerFactory=Dc.Chrome111.createFactory();break}case"Chrome74":{this._handlerFactory=Tc.Chrome74.createFactory();break}case"Chrome70":{this._handlerFactory=Pc.Chrome70.createFactory();break}case"Chrome67":{this._handlerFactory=Ec.Chrome67.createFactory();break}case"Chrome55":{this._handlerFactory=Lc.Chrome55.createFactory();break}case"Firefox60":{this._handlerFactory=xc.Firefox60.createFactory();break}case"Safari12":{this._handlerFactory=Mc.Safari12.createFactory();break}case"Safari11":{this._handlerFactory=Ic.Safari11.createFactory();break}case"Edge11":{this._handlerFactory=Oc.Edge11.createFactory();break}case"ReactNativeUnifiedPlan":{this._handlerFactory=kc.ReactNativeUnifiedPlan.createFactory();break}case"ReactNative":{this._handlerFactory=jc.ReactNative.createFactory();break}default:throw new TypeError(`unknown handlerName "${e}"`)}}const i=this._handlerFactory();this._handlerName=i.name,i.close(),this._extendedRtpCapabilities=void 0,this._recvRtpCapabilities=void 0,this._canProduceByKind={audio:!1,video:!1},this._sctpCapabilities=void 0}get handlerName(){return this._handlerName}get loaded(){return this._loaded}get rtpCapabilities(){if(!this._loaded)throw new nt.InvalidStateError("not loaded");return this._recvRtpCapabilities}get sctpCapabilities(){if(!this._loaded)throw new nt.InvalidStateError("not loaded");return this._sctpCapabilities}get observer(){return this._observer}async load({routerRtpCapabilities:e}){J.debug("load() [routerRtpCapabilities:%o]",e),e=Rc.clone(e);let t;try{if(this._loaded)throw new nt.InvalidStateError("already loaded");Ie.validateRtpCapabilities(e),t=this._handlerFactory();const r=await t.getNativeRtpCapabilities();J.debug("load() | got native RTP capabilities:%o",r),Ie.validateRtpCapabilities(r),this._extendedRtpCapabilities=Ie.getExtendedRtpCapabilities(r,e),J.debug("load() | got extended RTP capabilities:%o",this._extendedRtpCapabilities),this._canProduceByKind.audio=Ie.canSend("audio",this._extendedRtpCapabilities),this._canProduceByKind.video=Ie.canSend("video",this._extendedRtpCapabilities),this._recvRtpCapabilities=Ie.getRecvRtpCapabilities(this._extendedRtpCapabilities),Ie.validateRtpCapabilities(this._recvRtpCapabilities),J.debug("load() | got receiving RTP capabilities:%o",this._recvRtpCapabilities),this._sctpCapabilities=await t.getNativeSctpCapabilities(),J.debug("load() | got native SCTP capabilities:%o",this._sctpCapabilities),Ie.validateSctpCapabilities(this._sctpCapabilities),J.debug("load() succeeded"),this._loaded=!0,t.close()}catch(r){throw t&&t.close(),r}}canProduce(e){if(this._loaded){if(e!=="audio"&&e!=="video")throw new TypeError(`invalid kind "${e}"`)}else throw new nt.InvalidStateError("not loaded");return this._canProduceByKind[e]}createSendTransport({id:e,iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n,iceServers:o,iceTransportPolicy:d,additionalSettings:u,proprietaryConstraints:p,appData:a}){return J.debug("createSendTransport()"),this.createTransport({direction:"send",id:e,iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n,iceServers:o,iceTransportPolicy:d,additionalSettings:u,proprietaryConstraints:p,appData:a})}createRecvTransport({id:e,iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n,iceServers:o,iceTransportPolicy:d,additionalSettings:u,proprietaryConstraints:p,appData:a}){return J.debug("createRecvTransport()"),this.createTransport({direction:"recv",id:e,iceParameters:t,iceCandidates:r,dtlsParameters:i,sctpParameters:n,iceServers:o,iceTransportPolicy:d,additionalSettings:u,proprietaryConstraints:p,appData:a})}createTransport({direction:e,id:t,iceParameters:r,iceCandidates:i,dtlsParameters:n,sctpParameters:o,iceServers:d,iceTransportPolicy:u,additionalSettings:p,proprietaryConstraints:a,appData:c}){if(this._loaded){if(typeof t!="string")throw new TypeError("missing id");if(typeof r!="object")throw new TypeError("missing iceParameters");if(Array.isArray(i)){if(typeof n!="object")throw new TypeError("missing dtlsParameters");if(o&&typeof o!="object")throw new TypeError("wrong sctpParameters");if(c&&typeof c!="object")throw new TypeError("if given, appData must be an object")}else throw new TypeError("missing iceCandidates")}else throw new nt.InvalidStateError("not loaded");const l=new Cc.Transport({direction:e,id:t,iceParameters:r,iceCandidates:i,dtlsParameters:n,sctpParameters:o,iceServers:d,iceTransportPolicy:u,additionalSettings:p,proprietaryConstraints:a,appData:c,handlerFactory:this._handlerFactory,extendedRtpCapabilities:this._extendedRtpCapabilities,canProduceByKind:this._canProduceByKind});return this._observer.safeEmit("newtransport",l),l}}Ne.Device=Fc;var ki={},ji={};Object.defineProperty(ji,"__esModule",{value:!0});var Fi={};Object.defineProperty(Fi,"__esModule",{value:!0});(function(s){var e=_&&_.__createBinding||(Object.create?function(r,i,n,o){o===void 0&&(o=n);var d=Object.getOwnPropertyDescriptor(i,n);(!d||("get"in d?!i.__esModule:d.writable||d.configurable))&&(d={enumerable:!0,get:function(){return i[n]}}),Object.defineProperty(r,o,d)}:function(r,i,n,o){o===void 0&&(o=n),r[o]=i[n]}),t=_&&_.__exportStar||function(r,i){for(var n in r)n!=="default"&&!Object.prototype.hasOwnProperty.call(i,n)&&e(i,r,n)};Object.defineProperty(s,"__esModule",{value:!0}),t(Ne,s),t(bt,s),t(St,s),t(yt,s),t(Rt,s),t(Ct,s),t(ji,s),t(Fi,s),t(te,s),t(X,s)})(ki);(function(s){var e=_&&_.__createBinding||(Object.create?function(p,a,c,l){l===void 0&&(l=c);var h=Object.getOwnPropertyDescriptor(a,c);(!h||("get"in h?!a.__esModule:h.writable||h.configurable))&&(h={enumerable:!0,get:function(){return a[c]}}),Object.defineProperty(p,l,h)}:function(p,a,c,l){l===void 0&&(l=c),p[l]=a[c]}),t=_&&_.__setModuleDefault||(Object.create?function(p,a){Object.defineProperty(p,"default",{enumerable:!0,value:a})}:function(p,a){p.default=a}),r=_&&_.__importStar||function(p){if(p&&p.__esModule)return p;var a={};if(p!=null)for(var c in p)c!=="default"&&Object.prototype.hasOwnProperty.call(p,c)&&e(a,p,c);return t(a,p),a},i=_&&_.__importDefault||function(p){return p&&p.__esModule?p:{default:p}};Object.defineProperty(s,"__esModule",{value:!0}),s.debug=s.parseScalabilityMode=s.detectDevice=s.Device=s.version=s.types=void 0;const n=i(ni);s.debug=n.default;const o=Ne;Object.defineProperty(s,"Device",{enumerable:!0,get:function(){return o.Device}}),Object.defineProperty(s,"detectDevice",{enumerable:!0,get:function(){return o.detectDevice}});const d=r(ki);s.types=d,s.version="3.7.2";var u=Se;Object.defineProperty(s,"parseScalabilityMode",{enumerable:!0,get:function(){return u.parse}})})(zr);const $c=Ui(zr),Uc=zi({__proto__:null,default:$c},[zr]);export{Uc as i};
